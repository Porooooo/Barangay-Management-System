<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <title>Admin Dashboard - Barangay Talipapa</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        
        :root {
            --primary: #0d4f8b;
            --secondary: #e6a919;
            --light: #f8f9fa;
            --dark: #343a40;
            --success: #28a745;
            --danger: #e74c3c;
            --warning: #ffa000;
            --sidebar-width: 250px;
            --header-height: 70px;
        }
        
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        body { 
            font-family: 'Poppins', sans-serif; 
            background: linear-gradient(135deg, #e6f2ff 0%, #f0f8ff 100%);
            background-attachment: fixed;
            color: #333;
            overflow-x: hidden;
        }

        /* Sidebar Styles */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            width: var(--sidebar-width);
            background: linear-gradient(180deg, #0F172A 0%, #1E3A8A 100%);
            color: #F8FAFC;
            box-shadow: 2px 0 12px rgba(0, 0, 0, 0.15);
            overflow-y: auto;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .sidebar a {
            display: flex;
            align-items: center;
            color: #E2E8F0;
            padding: 12px 18px;
            margin: 6px 12px;
            border-radius: 10px;
            transition: 0.3s ease;
            position: relative;
            text-decoration: none;
        }

        .sidebar a:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            transform: translateX(4px);
        }

        .sidebar a i {
            margin-right: 12px;
            transition: all 0.3s ease;
        }

        .sidebar a:hover i {
            color: #60A5FA;
            transform: translateX(4px);
            text-shadow: 0 0 10px #60A5FA;
        }

        .greeting-section {
            padding: 20px 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: auto;
        }

        .greeting {
            font-size: 16px;
            color: #E2E8F0;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .current-date {
            font-size: 14px;
            color: #94A3B8;
            margin-bottom: 3px;
        }

        .current-time {
            font-size: 14px;
            color: #94A3B8;
            font-weight: 500;
        }

        .logo-name {
            display: flex;
            align-items: center;
            padding: 20px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo-image img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 10px;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .logo_name {
            font-size: 18px;
            font-weight: 600;
        }

        .menu-items {
            padding: 15px 0;
        }

        .nav-links {
            list-style: none;
        }

        .nav-links li {
            margin-bottom: 5px;
        }

        .nav-links a {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }

        .nav-links a:hover,
        .nav-links a.active {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            border-left-color: var(--secondary);
        }

        .nav-links i {
            font-size: 18px;
            margin-right: 12px;
            width: 20px;
            text-align: center;
        }

        .link-name {
            font-size: 14px;
            font-weight: 500;
        }

        .logout-section {
            padding: 15px 0;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Main Content */
        .main-content {
            margin-left: var(--sidebar-width);
            padding: 20px;
            min-height: 100vh;
            transition: all 0.3s ease;
        }

        .top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        .sidebar-toggle {
            font-size: 24px;
            cursor: pointer;
            color: var(--primary);
            display: none;
        }

        /* Header Right Section */
        .header-right {
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 1;
        }

        /* Changing Text Styles - UPDATED FOR SMOOTH EFFECT */
        .changing-text-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 45px;
            overflow: hidden;
        }

        .changing-text {
            font-size: 20px;
            font-weight: 600;
            color: var(--primary);
            text-align: center;
            transition: all 0.5s ease-in-out;
            opacity: 1;
            transform: translateY(0);
        }

        .changing-text.hidden {
            opacity: 0;
            transform: translateY(-10px);
        }

        /* Dashboard Content */
        .dash-content {
            margin-top: 10px;
        }

        /* Filter Controls */
        .filter-controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 150px;
        }

        .filter-group label {
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 14px;
        }

        .filter-group select, .filter-group input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: white;
        }

        .filter-btn {
            padding: 8px 15px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
            margin-top: 20px;
        }

        .filter-btn:hover {
            background-color: #1c6ea4;
        }

        /* Summary Cards */
        .boxes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .box {
            background-color: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            cursor: pointer;
            transition: all 0.3s ease;
            border-top: 4px solid transparent;
        }

        .box:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }

        .box i {
            font-size: 32px;
            margin-bottom: 15px;
        }

        .box .text {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--dark);
        }

        .box .number {
            font-size: 20px;
            font-weight: 600;
        }

        .box1 { 
            border-top-color: var(--primary); 
        }
        .box1 i { color: var(--primary); }
        .box1 .number { color: var(--primary); }

        .box2 { 
            border-top-color: var(--success); 
        }
        .box2 i { color: var(--success); }
        .box2 .number { color: var(--success); }

        .box3 { 
            border-top-color: var(--warning); 
        }
        .box3 i { color: var(--warning); }
        .box3 .number { color: var(--warning); }

        .box4 { 
            border-top-color: #9b59b6; 
        }
        .box4 i { color: #9b59b6; }
        .box4 .number { color: #9b59b6; }

        .box5 { 
            border-top-color: #e74c3c; 
        }
        .box5 i { color: #e74c3c; }
        .box5 .number { color: #e74c3c; }

        .box6 { 
            border-top-color: #3498db; 
        }
        .box6 i { color: #3498db; }
        .box6 .number { color: #3498db; }

        .box7 { 
            border-top-color: #f39c12; 
        }
        .box7 i { color: #f39c12; }
        .box7 .number { color: #f39c12; }

        .box8 { 
            border-top-color: #1abc9c; 
        }
        .box8 i { color: #1abc9c; }
        .box8 .number { color: #1abc9c; }

        /* Charts */
        .chart-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            height: 350px;
            position: relative;
        }

        .chart-container h3 {
            margin-bottom: 15px;
            color: var(--dark);
        }

        .chart-options {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }

        .chart-option-btn {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
        }

        .chart-option-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Recent Activity */
        .activity-section {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            margin-top: 20px;
        }

        .activity-section .title {
            margin-bottom: 15px;
        }

        .activity-table {
            width: 100%;
            border-collapse: collapse;
        }

        .activity-table th, .activity-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .activity-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: var(--dark);
        }

        .activity-table tbody tr:hover {
            background-color: #f8f9fa;
        }

        .status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .status-pending { background-color: #fff3cd; color: #856404; }
        .status-under-investigation { background-color: #d1ecf1; color: #0c5460; }
        .status-resolved { background-color: #d4edda; color: #155724; }
        .status-dismissed { background-color: #f8d7da; color: #721c24; }

        .view-button {
            background-color: var(--primary);
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.3s;
        }

        .view-button:hover {
            background-color: #1c6ea4;
            transform: translateY(-2px);
        }

        /* Emergency Notification */
        .emergency-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #ff4444;
            color: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 1100;
            display: none;
            width: 350px;
            animation: slideIn 0.5s forwards;
            border-left: 5px solid #cc0000;
        }

        .emergency-content {
            display: flex;
            padding: 15px;
            align-items: center;
        }

        .emergency-icon {
            font-size: 30px;
            margin-right: 15px;
            color: white;
        }

        .emergency-text {
            flex: 1;
        }

        .emergency-text h3 {
            margin: 0 0 5px 0;
            font-size: 18px;
        }

        .emergency-text p {
            margin: 0 0 10px 0;
            font-size: 14px;
        }

        .emergency-buttons {
            display: flex;
            gap: 10px;
        }

        .emergency-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            font-size: 12px;
            transition: all 0.3s;
        }

        .acknowledge-btn {
            background-color: #ffbb33;
            color: #000;
        }

        .acknowledge-btn:hover {
            background-color: #ff8800;
        }

        .resolve-btn {
            background-color: #00C851;
            color: white;
        }

        .resolve-btn:hover {
            background-color: #007E33;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* Emergency Emblem */
        .emergency-emblem {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #ff4444;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            box-shadow: 0 4px 8px rgba(255, 68, 68, 0.3);
            z-index: 1000;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .emergency-emblem:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 12px rgba(255, 68, 68, 0.4);
        }

        .alert-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: white;
            color: #ff4444;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            border: 2px solid #ff4444;
        }

        @keyframes shake {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(5deg); }
            50% { transform: rotate(-5deg); }
            75% { transform: rotate(5deg); }
            100% { transform: rotate(0deg); }
        }

        /* Report Card Button */
        .report-card-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background-color: var(--primary);
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .report-card-btn:hover {
            transform: scale(1.1);
            background-color: #1c6ea4;
        }

        /* Modal Overlay */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        /* Compact Report Card Styles */
        .report-modal {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 30px rgba(0,0,0,0.3);
            width: 65%;
            max-width: 900px;
            height: 85vh;
            overflow-y: auto;
            position: relative;
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #ff4444;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 10;
            font-size: 18px;
        }

        .modal-content {
            padding: 30px;
        }

        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px 30px;
            margin: -30px -30px 20px -30px;
            border-radius: 15px 15px 0 0;
        }
        
        .report-header h2 {
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0;
            font-size: 1.5rem;
        }
        
        .export-buttons {
            display: flex;
            gap: 8px;
        }
        
        .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
            font-size: 0.85rem;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #1c6ea4;
        }
        
        .btn-secondary {
            background-color: #3498db;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #2980b9;
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
        }

        .btn-outline:hover {
            background-color: var(--primary);
            color: white;
        }
        
        .filters {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
        }
        
        .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .filter-group {
            flex: 1;
            min-width: 150px;
        }
        
        .filter-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: 500;
            font-size: 0.85rem;
            color: #495057;
        }
        
        .filter-group select, 
        .filter-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.85rem;
            background: white;
        }
        
        .apply-filters {
            display: flex;
            justify-content: flex-end;
            margin-top: 10px;
        }
        
        .report-summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .report-summary-cards .box {
            padding: 15px;
            text-align: center;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-top: 4px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .report-summary-cards .box:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .report-summary-cards .box i {
            font-size: 24px;
            margin-bottom: 8px;
        }
        
        .report-summary-cards .text {
            font-size: 0.8rem;
            font-weight: 500;
            margin-bottom: 5px;
            color: var(--dark);
        }
        
        .report-summary-cards .number {
            font-size: 1.2rem;
            font-weight: 600;
        }

        /* Charts grid removed */
        
        .data-table {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 15px;
        }
        
        .data-table h3 {
            margin-bottom: 12px;
            color: var(--dark);
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
        }
        
        th, td {
            padding: 8px 10px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        
        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #495057;
            font-size: 0.75rem;
            text-transform: uppercase;
        }
        
        tr:hover {
            background-color: #f8f9fa;
        }
        
        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding: 10px 0;
            border-top: 1px solid #dee2e6;
        }
        
        .pagination button {
            padding: 6px 12px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .pagination button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .page-info {
            font-size: 0.8rem;
            color: #6c757d;
            font-weight: 500;
        }

        /* Quick Filters */
        .quick-filters {
            margin-bottom: 15px;
        }

        .quick-filters .btn {
            margin-right: 8px;
            margin-bottom: 8px;
        }

        /* Logout Modal */
        #logoutModal .modal-content {
            max-width: 350px;
            text-align: center;
        }

        #logoutModal .modal-content h3 {
            margin-bottom: 20px;
            font-size: 18px;
            color: var(--dark);
        }

        #logoutModal .modal-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        #logoutModal .modal-actions button {
            flex: 1;
            padding: 10px;
            font-size: 14px;
            border-radius: 6px;
            cursor: pointer;
            border: none;
            transition: all 0.3s ease;
        }

        #logoutModal .confirm {
            background: linear-gradient(135deg, var(--danger) 0%, #c0392b 100%);
            color: #fff;
        }

        #logoutModal .cancel {
            background-color: #ddd;
            color: #333;
        }

        #logoutModal .confirm:hover, #logoutModal .cancel:hover {
            transform: translateY(-2px);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 25px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            position: relative;
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .close {
            color: #aaa;
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .close:hover {
            color: black;
            transform: scale(1.1);
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .boxes {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .chart-row {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                left: -100%;
                width: 280px;
                border-radius: 0 20px 20px 0;
            }
            
            .sidebar.active {
                left: 0;
            }
            
            .main-content {
                margin-left: 0;
                padding: 15px;
            }
            
            .sidebar-toggle {
                display: block;
            }
            
            .top {
                padding: 12px 15px;
            }
            
            .boxes {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .box {
                padding: 20px;
            }
            
            .report-card-btn {
                bottom: 20px;
                right: 20px;
            }
            
            .emergency-notification {
                width: 90%;
                top: 15px;
                max-width: 350px;
            }
            
            .chart-container {
                height: auto;
                min-height: 300px;
            }
            
            .report-modal {
                width: 95%;
                height: 90vh;
            }

            .modal-content {
                padding: 20px;
            }

            .filter-controls {
                flex-direction: column;
                align-items: flex-start;
            }

            .filter-group {
                width: 100%;
            }
            
            .activity-table {
                display: block;
                overflow-x: auto;
            }
            
            .filter-row {
                flex-direction: column;
            }
            
            .filter-group {
                min-width: 100%;
            }
            
            .report-header {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            
            .export-buttons {
                width: 100%;
                justify-content: center;
            }
        }

        @media (max-width: 576px) {
            .main-content {
                padding: 10px;
            }
            
            .top {
                padding: 10px 12px;
            }
            
            .box {
                padding: 15px;
            }
            
            .box i {
                font-size: 28px;
            }
            
            .box .text {
                font-size: 14px;
            }
            
            .box .number {
                font-size: 18px;
            }
            
            .modal-content {
                width: 95%;
                margin: 20% auto;
                padding: 20px;
            }
            
            .report-summary-cards {
                grid-template-columns: 1fr;
            }
            
            .report-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .export-buttons {
                width: 100%;
                justify-content: space-between;
            }
            
            .btn {
                flex: 1;
                justify-content: center;
            }

            .filter-group {
                min-width: 100%;
            }
        }

        @media (max-width: 480px) {
            .report-summary-cards {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .report-summary-cards .box {
                padding: 10px;
            }
            
            .report-summary-cards .box i {
                font-size: 20px;
            }
            
            .report-summary-cards .number {
                font-size: 1rem;
            }
        }

        @media (max-width: 400px) {
            .box .text, .box .number {
                font-size: 13px;
            }
            
            .activity-section {
                padding: 15px;
            }
            
            .activity-table th, .activity-table td {
                padding: 8px 10px;
                font-size: 13px;
            }
        }

        /* Scrollbar styling for report modal */
        .report-modal::-webkit-scrollbar {
            width: 6px;
        }

        .report-modal::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .report-modal::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        .report-modal::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="logo-name">
            <div class="logo-image">
                <img src="images/barangay-bg.png" alt="BTMS Logo">
            </div>
            <span class="logo_name">Admin Panel</span>
        </div>
        
        <div class="menu-items">
            <ul class="nav-links">
                <li><a href="/admin-dashboard" class="active">
                    <i class="fas fa-home"></i>
                    <span class="link-name">Dashboard</span>
                </a></li>
                <li><a href="/manage-residents">
                    <i class="fas fa-users"></i>
                    <span class="link-name">Manage Residents</span>
                </a></li>
                <li><a href="/adminRequests">
                    <i class="fas fa-file-alt"></i>
                    <span class="link-name">Document Requests</span>
                </a></li>
                <li><a href="/admin-blotter">
                    <i class="fas fa-shield-alt"></i>
                    <span class="link-name">Blotter Reports</span>
                </a></li>
                <li><a href="/adminAnnounce">
                    <i class="fas fa-bell"></i>
                    <span class="link-name">Announcement</span>
                </a></li>
                <li><a href="/admin-approvals">
                    <i class="fas fa-user-check"></i>
                    <span class="link-name">Approval</span>
                </a></li>
                <li><a href="/emergency">
                    <i class="fas fa-bell"></i>
                    <span class="link-name">Emergency Alerts</span>
                </a></li>
            </ul>
            
            <!-- Logout Section -->
            <div class="logout-section">
                <a href="#" id="sidebarLogoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                    <span class="link-name">Logout</span>
                </a>
            </div>
        </div>
        
        
    </nav>

    <!-- Emergency Notification -->
    <div id="emergencyNotification" class="emergency-notification">
        <div class="emergency-content">
            <i class="fas fa-bell emergency-icon"></i>
            <div class="emergency-text">
                <h3>EMERGENCY ALERT</h3>
                <p id="emergencyMessage"></p>
                <div class="emergency-buttons">
                    <button id="acknowledgeEmergency" class="emergency-btn acknowledge-btn">Respond</button>
                    <button id="resolveEmergency" class="emergency-btn resolve-btn">Resolve</button>
                </div>
            </div>
        </div>
    </div>

    
    <!-- Report Card Button -->
    <div class="report-card-btn" title="Generate Report Card" onclick="toggleReportCard()">
        <i class="fas fa-chart-bar"></i>
    </div>

     <!-- Main Content -->
     <section class="main-content">
        <div class="top">
            <i class="fas fa-bars sidebar-toggle" onclick="toggleMenu()"></i>
            <div class="header-right">
                <div class="changing-text-container">
                    <span class="changing-text" id="changingText">Admin Dashboard</span>
                </div>
                <!-- Emergency Emblem (Top Right Corner) -->
                <div class="emergency-emblem" title="Emergency Alerts" onclick="window.location.href='/emergency'">
                    <i class="fas fa-bell"></i>
                    <span class="alert-count" id="emergencyAlertCount">0</span>
                </div>
            </div>
        </div>
    
        <div class="dash-content">
            <!-- Updated Time Filter Controls -->
<div class="filter-controls">
    <div class="filter-group">
        <label for="timeFilter">Time Period</label>
        <select id="timeFilter">
            <option value="all">All Time</option>
            <option value="year">This Year</option>
            <option value="month" selected>This Month</option>
            <option value="week">This Week</option>
            <option value="today">Today</option>
            <option value="custom">Custom Range</option>
        </select>
    </div>
    <div class="filter-group">
        <label for="dateRangeStart">From Date</label>
        <input type="date" id="dateRangeStart">
    </div>
    <div class="filter-group">
        <label for="dateRangeEnd">To Date</label>
        <input type="date" id="dateRangeEnd">
    </div>
    <button class="filter-btn" id="applyTimeFilter">
        <i class="fas fa-filter"></i> Apply Filter
    </button>
</div>

            <!-- Summary Cards -->
            <div class="boxes">
                <div class="box box1" onclick="location.href='/manage-residents'">
                    <i class="fas fa-users"></i>
                    <span class="text">Total Population</span>
                    <span class="number" id="totalPopulation">0</span>
                </div>
                <div class="box box2" onclick="location.href='/manage-residents'">
                    <i class="fas fa-check-circle"></i>
                    <span class="text">Registered Voters</span>
                    <span class="number" id="registeredVoters">0</span>
                </div>
                <div class="box box3" onclick="location.href='/admin-blotter'">
                    <i class="fas fa-shield-alt"></i>
                    <span class="text">Active Blotter Cases</span>
                    <span class="number" id="blotterCases">0</span>
                </div>
                <div class="box box4" onclick="location.href='/adminRequests'">
                    <i class="fas fa-file-alt"></i>
                    <span class="text">Document Requests</span>
                    <span class="number" id="documentRequests">0</span>
                </div>
                <div class="box box5" onclick="location.href='/manage-residents'">
                    <i class="fas fa-wheelchair"></i>
                    <span class="text">PWD</span>
                    <span class="number" id="pwdCount">0</span>
                </div>
                <div class="box box6" onclick="location.href='/manage-residents'">
                    <i class="fas fa-user-arrows"></i>
                    <span class="text">Senior Citizens</span>
                    <span class="number" id="seniorCitizens">0</span>
                </div>
                <div class="box box7" onclick="location.href='/manage-residents'">
                    <i class="fas fa-user-md"></i>
                    <span class="text">Solo Parent</span>
                    <span class="number" id="soloParentCount">0</span>
                </div>
                <div class="box box8" onclick="location.href='/manage-residents'">
                    <i class="fas fa-users-alt"></i>
                    <span class="text">4Ps Member</span>
                    <span class="number" id="fourPsCount">0</span>
                </div>
            </div>

            <!-- Charts Row 1 -->
            <div class="chart-row">
                <div class="chart-container">
                    <h3>Age Distribution</h3>
                    <canvas id="ageChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>Gender Distribution</h3>
                    <canvas id="genderChart"></canvas>
                </div>
            </div>

            <!-- Charts Row 2 -->
            <div class="chart-row">
                <div class="chart-container">
                    <h3>Civil Status</h3>
                    <canvas id="civilStatusChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>Government Program Participation</h3>
                    <canvas id="programChart"></canvas>
                </div>
            </div>

            <!-- Charts Row 3 - Time Series -->
            <div class="chart-row">
                <div class="chart-container">
                    <h3>Registration Trends</h3>
                    <canvas id="registrationTrendChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>Monthly Activity</h3>
                    <canvas id="monthlyActivityChart"></canvas>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="activity-section">
                <div class="title">
                    <i class="fas fa-clock"></i>
                    <span class="text">Recent Activity</span>
                </div>
                <div id="recentActivity">
                    <div class="activity-item">
                        <div class="activity-icon">
                            <i class="fas fa-info-circle"></i>
                        </div>
                        <div class="activity-details">
                            Loading recent activity...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Modal Overlay -->
    <div id="reportModalOverlay" class="modal-overlay">
        <div class="report-modal">
            <div class="modal-close" onclick="closeReportModal()">
                <i class="fas fa-times"></i>
            </div>
            <div class="modal-content">
                <div class="report-header">
                    <h2><i class="fas fa-chart-bar"></i> Resident Report Card</h2>
                    <div class="export-buttons">
                        <button class="btn btn-primary" id="exportPDF">
                            <i class="fas fa-file-pdf"></i> PDF
                        </button>
                        <button class="btn btn-secondary" id="exportDOCS">
                            <i class="fas fa-file-word"></i> DOCS
                        </button>
                    </div>
                </div>
                
                <div class="filters">
                    <div class="quick-filters">
                        <div style="display: flex; gap: 8px; margin-bottom: 10px; flex-wrap: wrap;">
                            <button class="btn btn-outline" onclick="applyQuickFilter('seniorCitizen')">
                                <i class="fas fa-user-clock"></i> Senior Citizens
                            </button>
                            <button class="btn btn-outline" onclick="applyQuickFilter('pwdMember')">
                                <i class="fas fa-wheelchair"></i> PWD
                            </button>
                            <button class="btn btn-outline" onclick="applyQuickFilter('registeredVoter')">
                                <i class="fas fa-vote-yea"></i> Voters
                            </button>
                        </div>
                    </div>
                    <div class="filter-row">
                        <div class="filter-group">
                            <label for="statusFilter"><i class="fas fa-user-check"></i> Status</label>
                            <select id="statusFilter">
                                <option value="">All Statuses</option>
                                <option value="Active">Active</option>
                                <option value="Inactive">Inactive</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="genderFilter"><i class="fas fa-venus-mars"></i> Gender</label>
                            <select id="genderFilter">
                                <option value="">All Genders</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="civilStatusFilter"><i class="fas fa-heart"></i> Civil Status</label>
                            <select id="civilStatusFilter">
                                <option value="">All Statuses</option>
                                <option value="Single">Single</option>
                                <option value="Married">Married</option>
                                <option value="Widowed">Widowed</option>
                                <option value="Separated">Separated</option>
                            </select>
                        </div>
                    </div>
                    <div class="filter-row">
                        <div class="filter-group">
                            <label for="ageRangeFilter"><i class="fas fa-birthday-cake"></i> Age Range</label>
                            <select id="ageRangeFilter">
                                <option value="">All Ages</option>
                                <option value="0-17">Under 18</option>
                                <option value="18-24">18-24</option>
                                <option value="25-34">25-34</option>
                                <option value="35-44">35-44</option>
                                <option value="45-54">45-54</option>
                                <option value="55-64">55-64</option>
                                <option value="65+">65+</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="programFilter"><i class="fas fa-users"></i> Program</label>
                            <select id="programFilter">
                                <option value="">All Programs</option>
                                <option value="registeredVoter">Registered Voter</option>
                                <option value="fourPsMember">4Ps Member</option>
                                <option value="pwdMember">PWD Member</option>
                                <option value="seniorCitizen">Senior Citizen</option>
                                <option value="soloParent">Solo Parent</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="searchInput"><i class="fas fa-search"></i> Search</label>
                            <input type="text" id="searchInput" placeholder="Name or email...">
                        </div>
                    </div>
                    <div class="apply-filters">
                        <button class="btn btn-primary" id="applyFilters">
                            <i class="fas fa-filter"></i> Apply Filters
                        </button>
                    </div>
                </div>
                
                <div class="report-summary-cards">
                    <div class="box box1">
                        <i class="fas fa-users"></i>
                        <span class="text">Total Population</span>
                        <span class="number" id="reportTotalPopulation">0</span>
                    </div>
                    <div class="box box2">
                        <i class="fas fa-user-check"></i>
                        <span class="text">Active Residents</span>
                        <span class="number" id="reportActiveResidents">0</span>
                    </div>
                    <div class="box box3">
                        <i class="fas fa-user-minus"></i>
                        <span class="text">Inactive Residents</span>
                        <span class="number" id="reportInactiveResidents">0</span>
                    </div>
                    <div class="box box4">
                        <i class="fas fa-venus"></i>
                        <span class="text">Female</span>
                        <span class="number" id="reportFemaleCount">0</span>
                    </div>
                    <div class="box box5">
                        <i class="fas fa-mars"></i>
                        <span class="text">Male</span>
                        <span class="number" id="reportMaleCount">0</span>
                    </div>
                </div>
                
                <!-- Charts grid removed -->
                
                <div class="data-table">
                    <h3><i class="fas fa-table"></i> Resident Details</h3>
                    <div id="residentTableContainer">
                        <table>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Age</th>
                                    <th>Gender</th>
                                    <th>Civil Status</th>
                                    <th>Status</th>
                                    <th>Programs</th>
                                </tr>
                            </thead>
                            <tbody id="residentTableBody">
                                <tr>
                                    <td colspan="6" class="loading">Loading resident data...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="pagination">
                        <button id="prevPage" disabled>
                            <i class="fas fa-chevron-left"></i> Previous
                        </button>
                        <span class="page-info" id="pageInfo">Page 1 of 1</span>
                        <button id="nextPage" disabled>
                            Next <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Logout Confirmation Modal -->
    <div id="logoutModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeLogoutModal()">&times;</span>
            <h3>Are you sure you want to logout?</h3>
            <div class="modal-actions">
                <button class="confirm" onclick="confirmLogout()">Yes</button>
                <button class="cancel" onclick="closeLogoutModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script>
        // Initialize socket connection
        const socket = io();

        // Emergency notification elements
        const emergencyNotification = document.getElementById('emergencyNotification');
        const emergencyMessage = document.getElementById('emergencyMessage');
        const acknowledgeEmergency = document.getElementById('acknowledgeEmergency');
        const resolveEmergency = document.getElementById('resolveEmergency');
        let currentEmergencyAlert = null;

        // Report card variables
        let allResidents = [];
        let filteredResidents = [];
        let currentPage = 1;
        const residentsPerPage = 10;

        // Time filter variables - UPDATED to default to "All Time"
        let currentTimeFilter = 'all'; // Default to all time
        let currentDateRangeStart = ''; // Will be empty for all time
        let currentDateRangeEnd = ''; // Will be empty for all time
        let historicalData = [];

        // Chart instances
        const chartInstances = {};

        // Changing text effect - UPDATED SMOOTH VERSION
        const changingTexts = [
            "Admin Dashboard",
            "Barangay Management",
            "Resident Statistics",
            "System Overview",
            "Welcome Administrator"
        ];

        let currentTextIndex = 0;
        let changingTextElement;

        function initChangingText() {
            changingTextElement = document.getElementById('changingText');
            
            // Start the text rotation
            setInterval(updateChangingText, 4000);
        }

        function updateChangingText() {
            // Fade out current text
            changingTextElement.classList.add('hidden');
            
            setTimeout(() => {
                // Change text
                currentTextIndex = (currentTextIndex + 1) % changingTexts.length;
                changingTextElement.textContent = changingTexts[currentTextIndex];
                
                // Fade in new text
                changingTextElement.classList.remove('hidden');
            }, 500);
        }

        // Toggle sidebar
        function toggleMenu() {
            document.querySelector('.sidebar').classList.toggle('active');
        }

        // Update greeting and time
        function updateGreetingAndTime() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            
            // Set greeting based on time of day
            let greeting;
            if (hours < 12) {
                greeting = "Good Morning";
            } else if (hours < 18) {
                greeting = "Good Afternoon";
            } else {
                greeting = "Good Evening";
            }
            
            // Format date
            const options = { weekday: 'long', year: 'numeric', month: 'short', day: 'numeric' };
            const dateString = now.toLocaleDateString('en-US', options);
            
            // Format time with AM/PM
            const ampm = hours >= 12 ? 'PM' : 'AM';
            const formattedHours = hours % 12 || 12;
            const timeString = `${formattedHours}:${minutes}:${seconds} ${ampm}`;
            
            // Update DOM elements
            const greetingText = document.getElementById('greetingText');
            const currentDate = document.getElementById('currentDate');
            const currentTime = document.getElementById('currentTime');
            
            if (greetingText) greetingText.textContent = greeting;
            if (currentDate) currentDate.textContent = dateString;
            if (currentTime) currentTime.textContent = timeString;
        }

        // Update time every second
        setInterval(updateGreetingAndTime, 1000);
        updateGreetingAndTime(); // Initial call

        // Toggle report card modal
        function toggleReportCard() {
            const modalOverlay = document.getElementById('reportModalOverlay');
            if (modalOverlay.style.display === 'flex') {
                closeReportModal();
            } else {
                modalOverlay.style.display = 'flex';
                document.body.style.overflow = 'hidden'; // Prevent scrolling
                // Load report data if not already loaded
                initializeReportCard();
            }
        }
        
        // Close report modal
        function closeReportModal() {
            document.getElementById('reportModalOverlay').style.display = 'none';
            document.body.style.overflow = 'auto'; // Re-enable scrolling
        }
        
        // Close modal when clicking outside content
        document.getElementById('reportModalOverlay').addEventListener('click', function(e) {
            if (e.target === this) {
                closeReportModal();
            }
        });

        // Function to update emergency alert count
        async function updateEmergencyAlertCount() {
            try {
                const response = await fetch('/api/emergency?status=pending');
                if (!response.ok) {
                    throw new Error('Failed to fetch emergency alerts');
                }
                
                const data = await response.json();
                const count = data.alerts ? data.alerts.length : 0;
                const alertCountElement = document.getElementById('emergencyAlertCount');
                
                if (alertCountElement) {
                    alertCountElement.textContent = count;
                    
                    // Make the bell shake if there are new alerts
                    if (count > 0) {
                        const emblem = document.querySelector('.emergency-emblem');
                        emblem.style.animation = 'shake 0.5s';
                        setTimeout(() => {
                            emblem.style.animation = '';
                        }, 500);
                    }
                }
            } catch (error) {
                console.error('Error updating emergency alert count:', error);
                // Set count to 0 on error
                const alertCountElement = document.getElementById('emergencyAlertCount');
                if (alertCountElement) {
                    alertCountElement.textContent = '0';
                }
            }
        }

        // Show emergency notification
        function showEmergencyNotification(alert) {
            emergencyMessage.textContent = `${alert.residentName}: ${alert.message}`;
            emergencyNotification.style.display = 'block';
            
            // Set up button event listeners
            acknowledgeEmergency.onclick = () => acknowledgeAlert(alert._id);
            resolveEmergency.onclick = () => resolveAlert(alert._id);
            
            // Auto-hide after 1 minute if not acknowledged
            setTimeout(() => {
                if (emergencyNotification.style.display === 'block') {
                    emergencyNotification.classList.add('hide');
                    setTimeout(() => {
                        emergencyNotification.style.display = 'none';
                        emergencyNotification.classList.remove('hide');
                    }, 500);
                }
            }, 60000);
        }

        // Hide emergency notification
        function hideEmergencyNotification() {
            emergencyNotification.classList.add('hide');
            setTimeout(() => {
                emergencyNotification.style.display = 'none';
                emergencyNotification.classList.remove('hide');
                currentEmergencyAlert = null;
            }, 500);
        }

        // Acknowledge emergency alert
        async function acknowledgeAlert(alertId) {
            try {
                const adminMessage = prompt("Please enter a message to send to the resident:");
                if (!adminMessage) return; // User cancelled
                
                const token = localStorage.getItem('token');
                if (!token) {
                    window.location.href = '/admin-login';
                    return;
                }

                const response = await fetch(`/api/emergency/${alertId}/respond`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ adminMessage })
                });

                if (!response.ok) {
                    throw new Error('Failed to acknowledge alert');
                }

                hideEmergencyNotification();
                updateEmergencyAlertCount(); // Update count after acknowledging
            } catch (error) {
                console.error('Acknowledge error:', error);
                showNotification(`Error: ${error.message}`);
            }
        }

        // Resolve emergency alert
        async function resolveAlert(alertId) {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    window.location.href = '/admin-login';
                    return;
                }

                const response = await fetch(`/api/emergency/${alertId}/resolve`, {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to resolve alert');
                }

                hideEmergencyNotification();
                updateEmergencyAlertCount(); // Update count after resolving
            } catch (error) {
                console.error('Resolve error:', error);
                showNotification(`Error: ${error.message}`);
            }
        }

        // Listen for new emergency alerts
        socket.on('newEmergencyAlert', (alert) => {
            currentEmergencyAlert = alert;
            showEmergencyNotification(alert);
            updateEmergencyAlertCount();
            
            // Show notification
            if (Notification.permission === "granted") {
                new Notification(`New Emergency Alert from ${alert.residentName}`, {
                    body: alert.message
                });
            }
        });

        // Listen for acknowledged alerts
        socket.on('alertAcknowledged', (alert) => {
            if (currentEmergencyAlert && currentEmergencyAlert._id === alert._id) {
                hideEmergencyNotification();
            }
            updateEmergencyAlertCount();
        });

        // Listen for resolved alerts
        socket.on('alertResolved', (alertId) => {
            if (currentEmergencyAlert && currentEmergencyAlert._id === alertId) {
                hideEmergencyNotification();
            }
            updateEmergencyAlertCount();
        });

        // Listen for removed alerts
        socket.on('alertRemoved', (alertId) => {
            if (currentEmergencyAlert && currentEmergencyAlert._id === alertId) {
                hideEmergencyNotification();
            }
            updateEmergencyAlertCount();
        });

        // Request notification permission
        if (Notification.permission !== "granted") {
            Notification.requestPermission();
        }

        // Function to calculate age from birthdate
        function calculateAge(birthdate) {
            if (!birthdate) return null;
            const today = new Date();
            const birthDate = new Date(birthdate);
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            
            return age;
        }

        // Function to categorize age groups
        function categorizeAge(age) {
            if (age === null) return 'Unknown';
            if (age < 18) return 'Under 18';
            if (age >= 18 && age <= 24) return '18-24';
            if (age >= 25 && age <= 34) return '25-34';
            if (age >= 35 && age <= 44) return '35-44';
            if (age >= 45 && age <= 54) return '45-54';
            if (age >= 55 && age <= 64) return '55-64';
            return '65+';
        }

        // Function to get current month date range
        function getCurrentMonthRange() {
            const now = new Date();
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            
            return {
                start: startOfMonth.toISOString().split('T')[0],
                end: endOfMonth.toISOString().split('T')[0]
            };
        }

        // Function to get current week date range
        function getCurrentWeekRange() {
            const now = new Date();
            const startOfWeek = new Date(now);
            startOfWeek.setDate(now.getDate() - now.getDay());
            startOfWeek.setHours(0, 0, 0, 0);
            
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            endOfWeek.setHours(23, 59, 59, 999);
            
            return {
                start: startOfWeek.toISOString().split('T')[0],
                end: endOfWeek.toISOString().split('T')[0]
            };
        }

        // Function to update date inputs based on selected time filter
        function updateDateInputs(filter) {
            const startInput = document.getElementById('dateRangeStart');
            const endInput = document.getElementById('dateRangeEnd');
            const now = new Date();
            
            switch(filter) {
                case 'today':
                    const today = now.toISOString().split('T')[0];
                    startInput.value = today;
                    endInput.value = today;
                    currentDateRangeStart = today;
                    currentDateRangeEnd = today;
                    break;
                    
                case 'week':
                    const weekRange = getCurrentWeekRange();
                    startInput.value = weekRange.start;
                    endInput.value = weekRange.end;
                    currentDateRangeStart = weekRange.start;
                    currentDateRangeEnd = weekRange.end;
                    break;
                    
                case 'month':
                    const monthRange = getCurrentMonthRange();
                    startInput.value = monthRange.start;
                    endInput.value = monthRange.end;
                    currentDateRangeStart = monthRange.start;
                    currentDateRangeEnd = monthRange.end;
                    break;
                    
                case 'year':
                    const yearStart = `${now.getFullYear()}-01-01`;
                    const yearEnd = `${now.getFullYear()}-12-31`;
                    startInput.value = yearStart;
                    endInput.value = yearEnd;
                    currentDateRangeStart = yearStart;
                    currentDateRangeEnd = yearEnd;
                    break;
                    
                case 'custom':
                    // Keep current values for custom range
                    break;
                    
                default: // 'all'
                    startInput.value = '';
                    endInput.value = '';
                    currentDateRangeStart = '';
                    currentDateRangeEnd = '';
            }
        }

        // Function to get date range based on filter - UPDATED
        function getDateRange(filter, startDateStr, endDateStr) {
            const now = new Date();
            let startDate, endDate;
            
            switch(filter) {
                case 'today':
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
                    break;
                case 'week':
                    const weekRange = getCurrentWeekRange();
                    startDate = new Date(weekRange.start);
                    endDate = new Date(weekRange.end);
                    endDate.setHours(23, 59, 59, 999);
                    break;
                case 'month':
                    const monthRange = getCurrentMonthRange();
                    startDate = new Date(monthRange.start);
                    endDate = new Date(monthRange.end);
                    endDate.setHours(23, 59, 59, 999);
                    break;
                case 'year':
                    startDate = new Date(now.getFullYear(), 0, 1);
                    endDate = new Date(now.getFullYear() + 1, 0, 1);
                    break;
                case 'custom':
                    if (startDateStr && endDateStr) {
                        startDate = new Date(startDateStr);
                        endDate = new Date(endDateStr);
                        // Set end date to end of day
                        endDate.setHours(23, 59, 59, 999);
                    }
                    break;
                default: // 'all'
                    startDate = null;
                    endDate = null;
            }
            
            return { startDate, endDate };
        }

        // Function to filter data by date
        function filterDataByDate(data, startDate, endDate) {
            if (!startDate || !endDate) return data;
            
            return data.filter(item => {
                const itemDate = new Date(item.createdAt || item.date);
                return itemDate >= startDate && itemDate < endDate;
            });
        }

        // Fetch resident data and update dashboard
        async function fetchResidentData() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    window.location.href = '/admin-login';
                    return;
                }

                // Fetch residents data (excluding admin users)
                const residentsResponse = await fetch('/api/admin/users?role=resident', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!residentsResponse.ok) {
                    throw new Error('Failed to fetch resident data');
                }
                
                const residentsData = await residentsResponse.json();
                const residents = residentsData.residents || residentsData;

                // Fetch document requests
                const requestsResponse = await fetch('/api/requests', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                let documentRequests = [];
                if (requestsResponse.ok) {
                    const requestsData = await requestsResponse.json();
                    documentRequests = Array.isArray(requestsData) ? requestsData : [];
                }

                let activeBlotterCases = [];
                try {
                    const blotterResponse = await fetch('/api/blotter', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (blotterResponse.ok) {
                        const blotterCases = await blotterResponse.json();
                        activeBlotterCases = blotterCases.filter(caseItem =>
                            caseItem.status !== "Resolved" &&
                            caseItem.status !== "Dismissed" &&
                            caseItem.status !== "Escalated to PNP"
                        );
                    }
                } catch (error) {
                    console.error("Error fetching blotter cases:", error);
                }

                // Apply time filters - UPDATED
                const { startDate, endDate } = getDateRange(
                    currentTimeFilter, 
                    currentDateRangeStart, 
                    currentDateRangeEnd
                );
                
                const filteredResidents = filterDataByDate(residents, startDate, endDate);
                const filteredRequests = filterDataByDate(documentRequests, startDate, endDate);
                const filteredBlotterCases = filterDataByDate(activeBlotterCases, startDate, endDate);

                // Update summary cards with all data
                updateSummaryCards(filteredResidents, filteredRequests, filteredBlotterCases);

                // Create charts
                createCharts(filteredResidents, filteredRequests);

                // Update recent activity
                updateRecentActivity(filteredResidents, filteredRequests, filteredBlotterCases);

            } catch (error) {
                console.error('Error fetching dashboard data:', error);
                
                // Show error message in recent activity
                document.getElementById('recentActivity').innerHTML = `
                    <div class="activity-item">
                        <div class="activity-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="activity-details">
                            Error loading data. Please try again later.
                            <div class="activity-time">${new Date().toLocaleString()}</div>
                        </div>
                    </div>
                `;
            }
        }

        // Update summary cards with resident data
        function updateSummaryCards(residents, documentRequests, blotterCases) {
            // Calculate statistics (excluding admin users)
            const totalPopulation = residents.length;
            const registeredVoters = residents.filter(r => r.registeredVoter === true).length;
            const pwd = residents.filter(r => r.pwdMember === true).length;
            
            // Use the seniorCitizen boolean field instead of calculating from birthdate
            const seniorCitizens = residents.filter(r => r.seniorCitizen === true).length;
            
            const soloParent = residents.filter(r => r.soloParent === true).length;
            const fourPsMember = residents.filter(r => r.fourPsMember === true).length;

            // Update card values
            document.getElementById('totalPopulation').textContent = totalPopulation;
            document.getElementById('registeredVoters').textContent = registeredVoters;
            document.getElementById('pwdCount').textContent = pwd;
            document.getElementById('seniorCitizens').textContent = seniorCitizens;
            document.getElementById('soloParentCount').textContent = soloParent;
            document.getElementById('fourPsCount').textContent = fourPsMember;
            
            // Update from API data
            document.getElementById('documentRequests').textContent = documentRequests.length;
            document.getElementById('blotterCases').textContent = blotterCases.length;
        }

        // Create charts based on resident data
        function createCharts(residents, documentRequests) {
            // Age Distribution Chart
            const ageGroups = {
                'Under 18': 0,
                '18-24': 0,
                '25-34': 0,
                '35-44': 0,
                '45-54': 0,
                '55-64': 0,
                '65+': 0,
                'Unknown': 0
            };

            residents.forEach(resident => {
                const age = calculateAge(resident.birthdate);
                const ageGroup = categorizeAge(age);
                ageGroups[ageGroup]++;
            });

            createChart('ageChart', 'bar', {
                labels: Object.keys(ageGroups),
                datasets: [{
                    label: 'Number of Residents',
                    data: Object.values(ageGroups),
                    backgroundColor: '#0d4f8b',
                    borderWidth: 0
                }]
            }, {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            });

            // Gender Distribution Chart
            const genderCounts = {
                'Male': 0,
                'Female': 0,
                'Other': 0
            };

            residents.forEach(resident => {
                const gender = resident.gender || 'Other';
                genderCounts[gender]++;
            });

            createChart('genderChart', 'doughnut', {
                labels: Object.keys(genderCounts),
                datasets: [{
                    data: Object.values(genderCounts),
                    backgroundColor: ['#2c3e50', '#0d4f8b', '#3498db'],
                    borderWidth: 0
                }]
            }, {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            });

            // Civil Status Chart
            const civilStatusCounts = {
                'Single': 0,
                'Married': 0,
                'Widowed': 0,
                'Separated': 0,
                'Unknown': 0
            };
            
            residents.forEach(resident => {
                const status = resident.civilStatus || 'Unknown';
                civilStatusCounts[status] = (civilStatusCounts[status] || 0) + 1;
            });

            createChart('civilStatusChart', 'pie', {
                labels: Object.keys(civilStatusCounts),
                datasets: [{
                    data: Object.values(civilStatusCounts),
                    backgroundColor: ['#2c3e50', '#0d4f8b', '#3498db', '#e74c3c', '#f39c12'],
                    borderWidth: 0
                }]
            }, {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            });

            // Government Program Participation Chart
            const programCounts = {
                'Registered Voter': residents.filter(r => r.registeredVoter === true).length,
                '4Ps Member': residents.filter(r => r.fourPsMember === true).length,
                'PWD Member': residents.filter(r => r.pwdMember === true).length,
                'Senior Citizen': residents.filter(r => r.seniorCitizen === true).length,
                'Solo Parent': residents.filter(r => r.soloParent === true).length
            };

            createChart('programChart', 'bar', {
                labels: Object.keys(programCounts),
                datasets: [{
                    label: 'Number of Residents',
                    data: Object.values(programCounts),
                    backgroundColor: [
                        '#3498db', // Blue for Registered Voter
                        '#e74c3c', // Red for 4Ps Member
                        '#f39c12', // Orange for PWD Member
                        '#2c3e50', // Dark blue for Senior Citizen
                        '#0d4f8b'  // Primary blue for Solo Parent
                    ],
                    borderWidth: 0
                }]
            }, {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    },
                    x: {
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            });

            // Registration Trends Chart (Monthly)
            const monthlyRegistrations = getMonthlyRegistrations(residents);
            createChart('registrationTrendChart', 'line', {
                labels: Object.keys(monthlyRegistrations),
                datasets: [{
                    label: 'Registrations',
                    data: Object.values(monthlyRegistrations),
                    borderColor: '#0d4f8b',
                    backgroundColor: 'rgba(13, 79, 139, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            }, {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            });

            // Monthly Activity Chart (Multiple metrics)
            const monthlyData = getMonthlyActivityData(residents, documentRequests);
            createChart('monthlyActivityChart', 'bar', {
                labels: monthlyData.months,
                datasets: [
                    {
                        label: 'Registrations',
                        data: monthlyData.registrations,
                        backgroundColor: '#0d4f8b'
                    },
                    {
                        label: 'Document Requests',
                        data: monthlyData.requests,
                        backgroundColor: '#3498db'
                    }
                ]
            }, {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            });
        }

        // Create or update a chart
        function createChart(canvasId, type, data, options) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            
            // Destroy existing chart if it exists
            if (chartInstances[canvasId]) {
                chartInstances[canvasId].destroy();
            }
            
            // Create new chart
            chartInstances[canvasId] = new Chart(ctx, {
                type: type,
                data: data,
                options: options
            });
        }

        // Get monthly registration data
        function getMonthlyRegistrations(residents) {
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const monthlyData = {};
            
            // Initialize all months with 0
            months.forEach(month => {
                monthlyData[month] = 0;
            });
            
            // Count registrations by month
            residents.forEach(resident => {
                if (resident.createdAt) {
                    const date = new Date(resident.createdAt);
                    const month = months[date.getMonth()];
                    monthlyData[month]++;
                }
            });
            
            return monthlyData;
        }

        // Get monthly activity data for multiple metrics
        function getMonthlyActivityData(residents, documentRequests) {
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const registrations = Array(12).fill(0);
            const requests = Array(12).fill(0);
            
            // Count registrations by month
            residents.forEach(resident => {
                if (resident.createdAt) {
                    const date = new Date(resident.createdAt);
                    const month = date.getMonth();
                    registrations[month]++;
                }
            });
            
            // Count document requests by month
            documentRequests.forEach(request => {
                if (request.createdAt) {
                    const date = new Date(request.createdAt);
                    const month = date.getMonth();
                    requests[month]++;
                }
            });
            
            return {
                months: months,
                registrations: registrations,
                requests: requests
            };
        }

        // Update recent activity section
        function updateRecentActivity(residents, documentRequests, blotterCases) {
            const activityContainer = document.getElementById('recentActivity');
            activityContainer.innerHTML = '';

            // Combine all activities
            const activities = [];

            // Add resident registrations
            residents.slice(0, 3).forEach(resident => {
                activities.push({
                    type: 'registration',
                    message: `${resident.fullName} registered as resident`,
                    date: new Date(resident.createdAt),
                    icon: 'fas fa-user-plus'
                });
            });

            // Add document requests
            documentRequests.slice(0, 2).forEach(request => {
                activities.push({
                    type: 'document',
                    message: `${request.fullName} requested ${Array.isArray(request.documentTypes) ? request.documentTypes.join(', ') : request.documentTypes}`,
                    date: new Date(request.createdAt),
                    icon: 'fas fa-file-alt'
                });
            });

            // Add blotter cases
            blotterCases.slice(0, 2).forEach(blotter => {
                activities.push({
                    type: 'blotter',
                    message: `New blotter case reported by ${blotter.complainantName}`,
                    date: new Date(blotter.createdAt || blotter.date),
                    icon: 'fas fa-shield-alt'
                });
            });

            // Sort by date (newest first) and take top 5
            activities.sort((a, b) => b.date - a.date).slice(0, 5).forEach(activity => {
                const activityItem = document.createElement('div');
                activityItem.className = 'activity-item';
                activityItem.innerHTML = `
                    <div class="activity-icon">
                        <i class="${activity.icon}"></i>
                    </div>
                    <div class="activity-details">
                        ${activity.message}
                        <div class="activity-time">${activity.date.toLocaleString()}</div>
                    </div>
                `;
                activityContainer.appendChild(activityItem);
            });

            if (activities.length === 0) {
                activityContainer.innerHTML = `
                    <div class="activity-item">
                        <div class="activity-icon">
                            <i class="fas fa-info-circle"></i>
                        </div>
                        <div class="activity-details">
                            No recent activity found for the selected time period
                            <div class="activity-time">${new Date().toLocaleString()}</div>
                        </div>
                    </div>
                `;
            }
        }

        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Set default to "All Time" - empty date inputs
            document.getElementById('dateRangeStart').value = '';
            document.getElementById('dateRangeEnd').value = '';
            document.getElementById('timeFilter').value = currentTimeFilter;
            
            fetchResidentData();
            
            // Initialize changing text
            initChangingText();
            
            // Add event listener for time filter change
            document.getElementById('timeFilter').addEventListener('change', function() {
                currentTimeFilter = this.value;
                updateDateInputs(currentTimeFilter);
            });
            
            // Add event listeners for chart type buttons
            document.querySelectorAll('.chart-option-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const chartId = this.dataset.chart;
                    const chartType = this.dataset.type;
                    
                    // Remove active class from all buttons for this chart
                    document.querySelectorAll(`.chart-option-btn[data-chart="${chartId}"]`).forEach(btn => {
                        btn.classList.remove('active');
                    });
                    
                    // Add active class to clicked button
                    this.classList.add('active');
                    
                    // Recreate chart with new type
                    if (chartInstances[chartId]) {
                        const data = chartInstances[chartId].data;
                        const options = chartInstances[chartId].options;
                        createChart(chartId, chartType, data, options);
                    }
                });
            });
            
            // Add event listener for time filter button - UPDATED
            document.getElementById('applyTimeFilter').addEventListener('click', function() {
                currentTimeFilter = document.getElementById('timeFilter').value;
                
                // For custom range, get values from inputs
                if (currentTimeFilter === 'custom') {
                    currentDateRangeStart = document.getElementById('dateRangeStart').value;
                    currentDateRangeEnd = document.getElementById('dateRangeEnd').value;
                } else {
                    // For other filters, ensure date ranges are cleared
                    currentDateRangeStart = '';
                    currentDateRangeEnd = '';
                }
                
                fetchResidentData();
            });

            // Setup sidebar logout
            setupSidebarLogout();

            // Initialize emergency alert count
            updateEmergencyAlertCount();
            
            // Set up periodic refresh of emergency alert count
            setInterval(updateEmergencyAlertCount, 30000); // Refresh every 30 seconds
        });

        // Report Card Functions
        // Function to get program participation text
        function getProgramParticipation(resident) {
            const programs = [];
            if (resident.registeredVoter) programs.push('Voter');
            if (resident.fourPsMember) programs.push('4Ps');
            if (resident.pwdMember) programs.push('PWD');
            if (resident.seniorCitizen) programs.push('Senior');
            if (resident.soloParent) programs.push('Solo Parent');
            
            return programs.join(', ') || 'None';
        }
        
        // Function to fetch report data
        async function fetchReportData() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    window.location.href = '/admin-login';
                    return;
                }
                
                const response = await fetch('/api/admin/users?role=resident', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch resident data');
                }
                
                const data = await response.json();
                allResidents = data.residents || data;
                
                // Process data for display
                processReportData(allResidents);
                
            } catch (error) {
                console.error('Error fetching resident data:', error);
                document.getElementById('residentTableBody').innerHTML = '<tr><td colspan="6">Error loading data. Please try again later.</td></tr>';
            }
        }
        
        // Function to process report data and update UI
        function processReportData(residents) {
            // Apply filters if any
            applyFilters();
            
            // Update summary cards
            updateReportSummaryCards(filteredResidents);
            
            // Update table
            updateResidentTable();
        }
        
        // Function to apply filters
        function applyFilters() {
            const statusFilter = document.getElementById('statusFilter').value;
            const genderFilter = document.getElementById('genderFilter').value;
            const civilStatusFilter = document.getElementById('civilStatusFilter').value;
            const ageRangeFilter = document.getElementById('ageRangeFilter').value;
            const programFilter = document.getElementById('programFilter').value;
            const searchText = document.getElementById('searchInput').value.toLowerCase();
            
            filteredResidents = allResidents.filter(resident => {
                // Status filter
                if (statusFilter && resident.status !== statusFilter) return false;
                
                // Gender filter
                if (genderFilter && resident.gender !== genderFilter) return false;
                
                // Civil status filter
                if (civilStatusFilter && resident.civilStatus !== civilStatusFilter) return false;
                
                // Age range filter
                if (ageRangeFilter) {
                    const age = calculateAge(resident.birthdate);
                    if (age === null) return false;
                    
                    if (ageRangeFilter === '0-17' && age >= 18) return false;
                    if (ageRangeFilter === '18-24' && (age < 18 || age > 24)) return false;
                    if (ageRangeFilter === '25-34' && (age < 25 || age > 34)) return false;
                    if (ageRangeFilter === '35-44' && (age < 35 || age > 44)) return false;
                    if (ageRangeFilter === '45-54' && (age < 45 || age > 54)) return false;
                    if (ageRangeFilter === '55-64' && (age < 55 || age > 64)) return false;
                    if (ageRangeFilter === '65+' && age < 65) return false;
                }
                
                // Program filter
                if (programFilter) {
                    if (programFilter === 'registeredVoter' && !resident.registeredVoter) return false;
                    if (programFilter === 'fourPsMember' && !resident.fourPsMember) return false;
                    if (programFilter === 'pwdMember' && !resident.pwdMember) return false;
                    if (programFilter === 'seniorCitizen' && !resident.seniorCitizen) return false;
                    if (programFilter === 'soloParent' && !resident.soloParent) return false;
                }
                
                // Search filter
                if (searchText) {
                    const searchableText = `${resident.fullName} ${resident.email}`.toLowerCase();
                    if (!searchableText.includes(searchText)) return false;
                }
                
                return true;
            });
            
            // Reset to first page when filters change
            currentPage = 1;
        }
        
        // Function to update report summary cards
        function updateReportSummaryCards(residents) {
            const totalPopulation = residents.length;
            const activeResidents = residents.filter(r => r.status === 'Active').length;
            const inactiveResidents = totalPopulation - activeResidents;
            const femaleCount = residents.filter(r => r.gender === 'Female').length;
            const maleCount = residents.filter(r => r.gender === 'Male').length;
            
            document.getElementById('reportTotalPopulation').textContent = totalPopulation;
            document.getElementById('reportActiveResidents').textContent = activeResidents;
            document.getElementById('reportInactiveResidents').textContent = inactiveResidents;
            document.getElementById('reportFemaleCount').textContent = femaleCount;
            document.getElementById('reportMaleCount').textContent = maleCount;
        }
        
        // Function to update resident table
        function updateResidentTable() {
            const startIndex = (currentPage - 1) * residentsPerPage;
            const endIndex = startIndex + residentsPerPage;
            const pageResidents = filteredResidents.slice(startIndex, endIndex);
            
            // Clear table
            const residentTableBody = document.getElementById('residentTableBody');
            residentTableBody.innerHTML = '';
            
            if (pageResidents.length === 0) {
                residentTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px; color: #6c757d;">No residents found matching the selected filters.</td></tr>';
            } else {
                // Add rows for each resident
                pageResidents.forEach(resident => {
                    const age = calculateAge(resident.birthdate);
                    const programs = getProgramParticipation(resident);
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${resident.fullName || 'N/A'}</td>
                        <td>${age !== null ? age : 'N/A'}</td>
                        <td>${resident.gender || 'N/A'}</td>
                        <td>${resident.civilStatus || 'N/A'}</td>
                        <td><span class="status ${resident.status === 'Active' ? 'status-pending' : 'status-dismissed'}">${resident.status || 'N/A'}</span></td>
                        <td>${programs}</td>
                    `;
                    residentTableBody.appendChild(row);
                });
            }
            
            // Update pagination controls
            updatePaginationControls();
        }
        
        // Function to update pagination controls
        function updatePaginationControls() {
            const totalPages = Math.ceil(filteredResidents.length / residentsPerPage);
            const prevPageBtn = document.getElementById('prevPage');
            const nextPageBtn = document.getElementById('nextPage');
            const pageInfoEl = document.getElementById('pageInfo');
            
            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages || totalPages === 0;
            
            pageInfoEl.textContent = `Page ${currentPage} of ${totalPages || 1}`;
        }
        
        // Function to export to PDF with barangay logo
        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Load and add barangay logo
            const logo = new Image();
            logo.src = '/images/barangay-bg.png';
            
            logo.onload = function() {
                // Add barangay logo (top left)
                doc.addImage(logo, 'PNG', 15, 10, 25, 25);

                // Add title
                doc.setFontSize(20);
                doc.setTextColor(13, 79, 139);
                doc.text('RESIDENT REPORT CARD', 105, 25, { align: 'center' });

                // Add date
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 105, 35, { align: 'center' });

                // Add resident table heading
                doc.setFontSize(14);
                doc.text('RESIDENT DETAILS', 15, 50);

                // Prepare table data
                const tableData = filteredResidents.map(resident => {
                    const age = calculateAge(resident.birthdate);
                    const programs = getProgramParticipation(resident);

                    return [
                        resident.fullName || 'N/A',
                        age !== null ? age.toString() : 'N/A',
                        resident.gender || 'N/A',
                        resident.civilStatus || 'N/A',
                        resident.status || 'N/A',
                        programs
                    ];
                });

                // Add table
                doc.autoTable({
                    head: [['Name', 'Age', 'Gender', 'Civil Status', 'Status', 'Programs']],
                    body: tableData,
                    startY: 55,
                    theme: 'grid',
                    headStyles: {
                        fillColor: [13, 79, 139],
                        textColor: 255,
                        fontStyle: 'bold'
                    },
                    styles: {
                        fontSize: 8,
                        cellPadding: 2,
                        overflow: 'linebreak',
                        cellWidth: 'wrap'
                    },
                    margin: { left: 10, right: 10 },
                    pageBreak: 'auto'
                });

                // Get final Y position after table
                const finalY = doc.lastAutoTable.finalY + 10;

                // Add footer with prepared by section
                if (finalY < 250) {
                    doc.setFontSize(10);
                    doc.text('Prepared by: _________________________', 15, finalY + 10);
                    doc.text('Barangay Secretary', 15, finalY + 20);
                } else {
                    // Add new page for footer if no space
                    doc.addPage();
                    doc.setFontSize(10);
                    doc.text('Prepared by: _________________________', 15, 20);
                    doc.text('Barangay Secretary', 15, 30);
                }

                // Save the PDF
                doc.save(`resident-report-${new Date().toISOString().split('T')[0]}.pdf`);
            };

            // If logo fails to load, generate PDF without logo
            logo.onerror = function() {
                console.error('Failed to load logo image');
                
                // Add title
                doc.setFontSize(20);
                doc.setTextColor(13, 79, 139);
                doc.text('RESIDENT REPORT CARD', 105, 20, { align: 'center' });

                // Add date
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 105, 30, { align: 'center' });

                // Add resident table heading
                doc.setFontSize(14);
                doc.text('RESIDENT DETAILS', 15, 45);

                // Prepare table data
                const tableData = filteredResidents.map(resident => {
                    const age = calculateAge(resident.birthdate);
                    const programs = getProgramParticipation(resident);

                    return [
                        resident.fullName || 'N/A',
                        age !== null ? age.toString() : 'N/A',
                        resident.gender || 'N/A',
                        resident.civilStatus || 'N/A',
                        resident.status || 'N/A',
                        programs
                    ];
                });

                // Add table
                doc.autoTable({
                    head: [['Name', 'Age', 'Gender', 'Civil Status', 'Status', 'Programs']],
                    body: tableData,
                    startY: 50,
                    theme: 'grid',
                    headStyles: {
                        fillColor: [13, 79, 139],
                        textColor: 255,
                        fontStyle: 'bold'
                    },
                    styles: {
                        fontSize: 8,
                        cellPadding: 2,
                        overflow: 'linebreak',
                        cellWidth: 'wrap'
                    },
                    margin: { left: 10, right: 10 },
                    pageBreak: 'auto'
                });

                // Get final Y position after table
                const finalY = doc.lastAutoTable.finalY + 10;

                // Add footer with prepared by section
                if (finalY < 250) {
                    doc.setFontSize(10);
                    doc.text('Prepared by: _________________________', 15, finalY + 10);
                    doc.text('Barangay Secretary', 15, finalY + 20);
                } else {
                    // Add new page for footer if no space
                    doc.addPage();
                    doc.setFontSize(10);
                    doc.text('Prepared by: _________________________', 15, 20);
                    doc.text('Barangay Secretary', 15, 30);
                }

                // Save the PDF
                doc.save(`resident-report-${new Date().toISOString().split('T')[0]}.pdf`);
            };
        }
        
        // Function to export to DOCS (Creates actual Word document)
        function exportToDOCS() {
            // Create HTML content that can be saved as .doc file
            let htmlContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Resident Report Card</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 40px; }
                        .header { text-align: center; color: #0d4f8b; margin-bottom: 30px; }
                        table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
                        th { background-color: #0d4f8b; color: white; padding: 10px; text-align: left; }
                        td { padding: 8px; border: 1px solid #ddd; }
                        .footer { margin-top: 50px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>RESIDENT REPORT CARD</h1>
                        <p>Generated on: ${new Date().toLocaleDateString()}</p>
                    </div>  
                    
                    <h2>RESIDENT DETAILS</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Age</th>
                                <th>Gender</th>
                                <th>Civil Status</th>
                                <th>Status</th>
                                <th>Programs</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // Add table rows
            filteredResidents.forEach(resident => {
                const age = calculateAge(resident.birthdate);
                const programs = getProgramParticipation(resident);
                
                htmlContent += `
                    <tr>
                        <td>${resident.fullName || 'N/A'}</td>
                        <td>${age !== null ? age : 'N/A'}</td>
                        <td>${resident.gender || 'N/A'}</td>
                        <td>${resident.civilStatus || 'N/A'}</td>
                        <td>${resident.status || 'N/A'}</td>
                        <td>${programs}</td>
                    </tr>
                `;
            });
            
            // Close HTML content
            htmlContent += `
                        </tbody>
                    </table>
                    
                    <div class="footer">
                        <p><strong>Prepared by:</strong> _________________________</p>
                        <p><strong>Position:</strong> Barangay Secretary</p>
                    </div>
                </body>
                </html>
            `;
            
            // Create Blob and download
            const blob = new Blob([htmlContent], { type: 'application/msword' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `resident-report-${new Date().toISOString().split('T')[0]}.doc`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Initialize report card when modal opens
        function initializeReportCard() {
            if (allResidents.length === 0) {
                fetchReportData();
            } else {
                processReportData(allResidents);
            }
        }

        // Quick filter function
        function applyQuickFilter(filterType) {
            document.getElementById('programFilter').value = filterType;
            processReportData(allResidents);
        }
        
        // Event listeners for report section
        document.getElementById('applyFilters').addEventListener('click', () => {
            processReportData(allResidents);
        });
        
        document.getElementById('prevPage').addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                updateResidentTable();
            }
        });
        
        document.getElementById('nextPage').addEventListener('click', () => {
            const totalPages = Math.ceil(filteredResidents.length / residentsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                updateResidentTable();
            }
        });
        
        document.getElementById('exportPDF').addEventListener('click', exportToPDF);
        document.getElementById('exportDOCS').addEventListener('click', exportToDOCS);

        // Add event listener for Enter key in search input
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                processReportData(allResidents);
            }
        });

        // Logout functionality
        async function logout() {
            try {
                const response = await fetch('/api/auth/logout', {
                    method: 'POST'
                });

                if (response && response.ok) {
                    localStorage.removeItem('userEmail');
                    localStorage.removeItem('userId');
                    window.location.href = '/';
                }
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        function openLogoutModal() {
            document.getElementById('logoutModal').style.display = 'block';
        }

        function closeLogoutModal() {
            document.getElementById('logoutModal').style.display = 'none';
        }

        function confirmLogout() {
            closeLogoutModal();
            logout();
        }

        // Sidebar logout functionality
        function setupSidebarLogout() {
            const sidebarLogoutBtn = document.getElementById('sidebarLogoutBtn');
            if (sidebarLogoutBtn) {
                sidebarLogoutBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    openLogoutModal();
                });
            }
        }

        // Close modals when clicking outside
        window.addEventListener('click', function(event) {
            const logoutModal = document.getElementById('logoutModal');
            
            if (event.target === logoutModal) {
                closeLogoutModal();
            }
        });

        // Helper function for notifications
        function showNotification(message) {
            // Simple notification implementation
            alert(message);
        }

        // Function to check for unacknowledged alerts and send email after 1 minute
        function setupEmergencyEmailNotification() {
            setInterval(async () => {
                try {
                    const response = await fetch('/api/emergency?status=pending');
                    if (!response.ok) return;
                    
                    const data = await response.json();
                    const pendingAlerts = data.alerts || [];
                    
                    const now = new Date();
                    pendingAlerts.forEach(alert => {
                        const alertTime = new Date(alert.createdAt);
                        const timeDiff = now - alertTime;
                        const oneMinute = 60000; // 1 minute in milliseconds
                        
                        // If alert is older than 1 minute and no email sent yet
                        if (timeDiff > oneMinute && !alert.emailSent) {
                            console.log(`Alert ${alert._id} is unacknowledged for over 1 minute`);
                            // The email sending is handled by the backend, but we can trigger a reminder
                            showNotification(`Emergency alert from ${alert.residentName} requires immediate attention!`);
                        }
                    });
                } catch (error) {
                    console.error('Error checking emergency alerts:', error);
                }
            }, 30000); // Check every 30 seconds
        }

        // Call this function when the dashboard loads
        document.addEventListener('DOMContentLoaded', function() {
            setupEmergencyEmailNotification();
        });
    </script>
</body>
</html>