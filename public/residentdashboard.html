<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#3367D6">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Resident Dashboard</title>
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
  <link rel="stylesheet" href="https://unicons.iconscout.com/release/v4.0.0/css/line.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap');
    
    :root {
      --primary-color: #3367D6;
      --secondary-color: #f3e0b6;
      --dark-color: #333;
      --light-color: #f7f7f7;
      --danger-color: #ff4444;
      --success-color: #5ECF89;
    }
    
    * { 
      margin: 0; 
      padding: 0; 
      box-sizing: border-box; 
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background-color: var(--light-color);
      color: var(--dark-color);
      overflow-x: hidden;
    }

    /* Mobile Nav */
    .mobile-nav {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: white;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      z-index: 1000;
    }

    .mobile-nav ul {
      display: flex;
      justify-content: space-around;
      list-style: none;
      padding: 10px 0;
    }

    .mobile-nav li {
      text-align: center;
    }

    .mobile-nav a {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-decoration: none;
      color: var(--dark-color);
      font-size: 10px;
      padding: 5px;
    }

    .mobile-nav i {
      font-size: 20px;
      margin-bottom: 3px;
    }

    /* Desktop Nav */
    .desktop-nav {
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      width: 250px;
      background-color: var(--dark-color);
      color: white;
      padding-top: 20px;
      transition: transform 0.3s;
      z-index: 1000;
    }

    .desktop-nav.hidden {
      transform: translateX(-100%);
    }

    .logo-name {
      display: flex;
      align-items: center;
      padding: 0 20px;
      margin-bottom: 30px;
    }

    .logo-image img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 10px;
    }

    .logo_name {
      font-weight: 600;
    }

    .menu-items {
      height: calc(100% - 100px);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .nav-links {
      list-style: none;
    }

    .nav-links li a {
      display: flex;
      align-items: center;
      padding: 12px 20px;
      color: white;
      text-decoration: none;
      transition: background 0.3s;
    }

    .nav-links li a:hover {
      background-color: rgba(255,255,255,0.1);
    }

    .nav-links i {
      margin-right: 10px;
      font-size: 18px;
    }

    .link-name {
      font-size: 14px;
    }

    /* Main Content */
    .main-content {
      margin-left: 250px;
      padding: 20px;
      transition: margin 0.3s;
    }

    .main-content.expanded {
      margin-left: 0;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .menu-toggle {
      font-size: 24px;
      cursor: pointer;
      display: none;
    }

    .profile-section {
      display: flex;
      align-items: center;
    }

    .profile-section img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 10px;
    }

    /* Dashboard Content */
    .dash-content {
      margin-top: 20px;
    }

    .title {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
    }

    .title i {
      margin-right: 10px;
      font-size: 20px;
      color: var(--primary-color);
    }

    .title .text {
      font-size: 18px;
      font-weight: 600;
    }

    .boxes {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .box {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      text-align: center;
      transition: transform 0.3s, box-shadow 0.3s;
      cursor: pointer;
    }

    .box:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .box i {
      font-size: 24px;
      margin-bottom: 10px;
    }

    .box .text {
      font-size: 14px;
      margin-bottom: 5px;
      color: #666;
    }

    .box .number {
      font-size: 18px;
      font-weight: 600;
    }

    /* Emergency Button */
    .emergency-button-container {
      position: fixed;
      bottom: 80px;
      right: 20px;
      z-index: 999;
    }

    .emergency-button {
      background-color: var(--danger-color);
      color: white;
      border: none;
      border-radius: 50px;
      padding: 15px 20px;
      font-size: 16px;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(255, 68, 68, 0.3);
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s;
    }

    .emergency-button:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 15px rgba(255, 68, 68, 0.4);
    }

    /* Emergency Notification */
    .emergency-notification {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: var(--success-color);
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1001;
      max-width: 90%;
      width: 350px;
      display: none;
      animation: slideDown 0.3s forwards;
    }

    @keyframes slideDown {
      from { transform: translate(-50%, -100%); opacity: 0; }
      to { transform: translate(-50%, 0); opacity: 1; }
    }

    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }

    /* Responsive Design */
    @media (max-width: 992px) {
      .desktop-nav {
        width: 200px;
      }
      .main-content {
        margin-left: 200px;
      }
    }

    @media (max-width: 768px) {
      .desktop-nav {
        transform: translateX(-100%);
      }
      .desktop-nav.visible {
        transform: translateX(0);
      }
      .main-content {
        margin-left: 0;
        padding-bottom: 70px;
      }
      .menu-toggle {
        display: block;
      }
      .mobile-nav {
        display: block;
      }
    }

    @media (max-width: 576px) {
      .boxes {
        grid-template-columns: 1fr;
      }
      .emergency-button {
        padding: 12px 15px;
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <!-- Desktop Navigation -->
  <nav class="desktop-nav hidden">
    <div class="logo-name">
      <div class="logo-image">
        <img src="images/barangay-bg.png" alt="BTMS Logo">
      </div>
      <span class="logo_name">Resident Panel</span>
    </div>
    
    <div class="menu-items">
      <ul class="nav-links">
        <li><a href="residentdashboard.html"><i class="uil uil-estate"></i><span class="link-name">Dashboard</span></a></li>
        <li><a href="requests.html"><i class="uil uil-file-alt"></i><span class="link-name">Request Document</span></a></li>
        <li><a href="blotter.html"><i class="uil uil-shield-exclamation"></i><span class="link-name">Blotter</span></a></li>
        <li><a href="residentRequests.html"><i class="uil uil-file-alt"></i><span class="link-name">Your Requests</span></a></li>
        <li><a href="resident-blotter.html"><i class="uil uil-shield-exclamation"></i><span class="link-name">Your Blotter</span></a></li>
        <li><a href="announcement.html"><i class="uil uil-bell"></i><span class="link-name">Announcements</span></a></li>
        <li><a href="profile.html"><i class="uil uil-user"></i><span class="link-name">Profile</span></a></li>
      </ul>
      
      <ul class="logout-mode">
        <li><a href="#" id="logoutBtn"><i class="uil uil-signout"></i><span class="link-name">Logout</span></a></li>
      </ul>
    </div>
  </nav>

  <!-- Mobile Navigation -->
  <nav class="mobile-nav">
    <ul>
      <li><a href="residentdashboard.html"><i class="uil uil-estate"></i>Dashboard</a></li>
      <li><a href="requests.html"><i class="uil uil-file-alt"></i>Requests</a></li>
      <li><a href="blotter.html"><i class="uil uil-shield-exclamation"></i>Blotter</a></li>
      <li><a href="profile.html"><i class="uil uil-user"></i>Profile</a></li>
    </ul>
  </nav>

  <!-- Main Content -->
  <main class="main-content">
    <div class="top-bar">
      <i class="uil uil-bars menu-toggle" onclick="toggleMenu()"></i>
      <div class="profile-section">
        <img id="profilePicture" src="" alt="Profile">
        <span id="userName"></span>
      </div>
    </div>

    <div class="dash-content">
      <div class="overview">
        <div class="title">
          <i class="uil uil-dashboard"></i>
          <span class="text">Resident Dashboard</span>
        </div>
        
        <div class="boxes">
          <div class="box" onclick="location.href='residentRequests.html'">
            <i class="uil uil-file-alt"></i>
            <span class="text">My Requests</span>
            <span class="number" id="pendingRequests">0 Pending</span>
          </div>
          
          <div class="box" onclick="location.href='announcement.html'">
            <i class="uil uil-bell"></i>
            <span class="text">New Announcements</span>
            <span class="number" id="newAnnouncements">0</span>
          </div>
          
          <div class="box" onclick="location.href='resident-blotter.html'">
            <i class="uil uil-shield-exclamation"></i>
            <span class="text">Active Blotter Cases</span>
            <span class="number" id="blotterCases">0</span>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Emergency Button -->
  <div class="emergency-button-container">
    <button class="emergency-button" onclick="openEmergencyModal()">
      <i class="uil uil-bell"></i> Emergency
    </button>
  </div>

  <!-- Emergency Notification -->
  <div class="emergency-notification" id="emergencyNotification">
    <div class="emergency-response-content">
      <i class="uil uil-bell"></i>
      <div>
        <h4>Emergency Response</h4>
        <p id="emergencyMessage"></p>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // Service Worker Registration
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(registration => {
            console.log('ServiceWorker registered');
          })
          .catch(err => {
            console.log('ServiceWorker registration failed: ', err);
          });
      });
    }

    // DOM Elements
    const desktopNav = document.querySelector('.desktop-nav');
    const mainContent = document.querySelector('.main-content');
    const emergencyNotification = document.getElementById('emergencyNotification');
    
    // Toggle Mobile Menu
    function toggleMenu() {
      desktopNav.classList.toggle('visible');
      mainContent.classList.toggle('expanded');
    }

    // Fetch Resident Data
    async function fetchResidentData() {
      try {
        const [profileRes, requestsRes, announcementsRes, blotterRes] = await Promise.all([
          fetch('/api/auth/profile', { credentials: 'include' }),
          fetch('/api/requests/user', { credentials: 'include' }),
          fetch('/api/announcements/user', { credentials: 'include' }),
          fetch('/api/blotter/user', { credentials: 'include' })
        ]);

        // Profile Data
        if (profileRes.ok) {
          const profile = await profileRes.json();
          document.getElementById('profilePicture').src = 
            profile.profilePicture ? `/uploads/${profile.profilePicture}` : '/images/default-profile.png';
          document.getElementById('userName').textContent = profile.fullName || 'User';
        }

        // Requests Data
        if (requestsRes.ok) {
          const requests = await requestsRes.json();
          const pending = requests.filter(r => r.status === 'Pending').length;
          document.getElementById('pendingRequests').textContent = `${pending} Pending`;
        }

        // Announcements Data
        if (announcementsRes.ok) {
          const announcements = await announcementsRes.json();
          const viewed = JSON.parse(localStorage.getItem('viewedAnnouncements')) || [];
          const newAnnouncements = announcements.filter(a => 
            !viewed.includes(a._id) && 
            new Date(a.createdAt) > new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)
          ).length;
          document.getElementById('newAnnouncements').textContent = newAnnouncements;
        }

        // Blotter Data
        if (blotterRes.ok) {
          const blotter = await blotterRes.json();
          const activeCases = blotter.filter(b => 
            ['Pending', 'Under Investigation'].includes(b.status)
          ).length;
          document.getElementById('blotterCases').textContent = activeCases;
        }
      } catch (error) {
        console.error('Fetch error:', error);
      }
    }

    // Initialize Socket.IO
    const socket = io({ withCredentials: true });

    socket.on('new_announcement', (announcement) => {
      showNotification(`New announcement: ${announcement.title}`);
      fetchResidentData();
    });

    socket.on('emergencyResponse', (response) => {
      if (response.residentId === localStorage.getItem('userId')) {
        showEmergencyResponse(response.message);
      }
    });

    // Show Notification
    function showNotification(message) {
      if (Notification.permission === 'granted') {
        new Notification('BTMS Notification', { body: message });
      } else if (Notification.permission !== 'denied') {
        Notification.requestPermission().then(permission => {
          if (permission === 'granted') {
            new Notification('BTMS Notification', { body: message });
          }
        });
      }
    }

    // Show Emergency Response
    function showEmergencyResponse(message) {
      const notification = document.getElementById('emergencyNotification');
      document.getElementById('emergencyMessage').textContent = message;
      notification.style.display = 'block';
      
      setTimeout(() => {
        notification.style.animation = 'fadeOut 0.5s forwards';
        setTimeout(() => {
          notification.style.display = 'none';
          notification.style.animation = '';
        }, 500);
      }, 10000);
    }

    // Check Authentication on Load
    document.addEventListener('DOMContentLoaded', () => {
      fetch('/api/auth/check-auth', { credentials: 'include' })
        .then(res => res.json())
        .then(data => {
          if (!data.isAuthenticated) {
            window.location.href = 'index.html';
          } else {
            localStorage.setItem('userId', data.user.id);
            fetchResidentData();
          }
        })
        .catch(() => {
          window.location.href = 'index.html';
        });

      // Logout Handler
      document.getElementById('logoutBtn').addEventListener('click', async (e) => {
        e.preventDefault();
        try {
          await fetch('/api/auth/logout', { 
            method: 'POST',
            credentials: 'include'
          });
          localStorage.clear();
          window.location.href = 'index.html';
        } catch (error) {
          console.error('Logout error:', error);
        }
      });

      // Refresh data every 30 seconds
      setInterval(fetchResidentData, 30000);
    });
  </script>
</body>
</html>