<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/residentdashboard.css">
    <title>Resident Dashboard - Barangay Talipapa</title>
    <style>
        /* Updated CSS for centered changing text */
        .changing-text-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 45px;
            overflow: hidden;
            flex: 1;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }

        .changing-text {
            font-size: 20px;
            font-weight: 600;
            color: var(--primary);
            text-align: center;
            transition: all 0.5s ease-in-out;
            opacity: 1;
            transform: translateY(0);
        }

        .changing-text.hidden {
            opacity: 0;
            transform: translateY(-10px);
        }

        /* Make sure the top section has relative positioning */
        .top {
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        /* Keep header-right on the right */
        .header-right {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 15px;
        }

        /* Red emergency notification bell - UPDATED */
        .notification-icon.emergency {
            background-color: #e74c3c;
            color: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            box-shadow: 0 2px 5px rgba(231, 76, 60, 0.3);
            transition: all 0.3s ease;
        }

        .notification-icon.emergency:hover {
            background-color: #c0392b;
            transform: scale(1.05);
        }

        /* Default state - no animation */
        .notification-icon.emergency .fa-bell {
            animation: none;
        }

        /* Animate only on hover */
        .notification-icon.emergency:hover .fa-bell {
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(5deg); }
            50% { transform: rotate(-5deg); }
            75% { transform: rotate(5deg); }
        }

        /* UPDATED: Floating Chat Widget Styles - Side-Sticking Design */
        .chat-widget-container {
            position: fixed;
            right: 0;
            top: 70%;
            transform: translateY(-50%);
            z-index: 1000;
        }

        .chat-toggle-btn {
            background-color: white;
            color: var(--primary);
            border: none;
            border-radius: 8px 0 0 8px;
            width: 50px;
            height: 60px;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.15);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.3s ease;
            border: 1px solid #e0e0e0;
            border-right: none;
        }

        .chat-toggle-btn:hover {
            background-color: var(--primary);
            color: white;
            width: 55px;
            box-shadow: -3px 0 15px rgba(0, 0, 0, 0.2);
        }

        .chat-toggle-btn.has-messages::after {
            content: '';
            position: absolute;
            top: 10px;
            right: 10px;
            width: 8px;
            height: 8px;
            background-color: #e74c3c;
            border-radius: 50%;
            border: 2px solid white;
        }

        .chat-widget-dashboard {
            position: absolute;
            bottom: 70px;
            right: 0;
            width: 350px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            border: 1px solid #e0e0e0;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-widget-dashboard.active {
            display: flex;
        }

        .chat-header-dashboard {
            background-color: var(--primary);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header-dashboard .text {
            font-weight: 600;
            font-size: 16px;
        }

        .chat-close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
        }

        .chat-body-dashboard {
            max-height: 400px;
            overflow-y: auto;
            padding: 15px;
            background: #f8f9fa;
        }

        .chat-messages-dashboard {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message-dashboard {
            padding: 12px 15px;
            border-radius: 15px;
            max-width: 80%;
            position: relative;
        }

        .message-dashboard.user {
            background-color: var(--primary);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }

        .message-dashboard.admin {
            background-color: #e9ecef;
            color: #333;
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }

        .message-time-dashboard {
            font-size: 0.7rem;
            opacity: 0.7;
            margin-top: 5px;
            display: block;
        }

        .admin-response-dashboard {
            background: white;
            padding: 10px 15px;
            border-radius: 10px;
            margin-top: 8px;
            border-left: 3px solid var(--secondary);
        }

        .response-label {
            font-weight: 600;
            color: var(--secondary);
            margin-bottom: 5px;
            font-size: 0.8rem;
        }

        .no-messages-dashboard {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 40px 20px;
        }

        .chat-input-dashboard {
            display: flex;
            gap: 10px;
            padding: 15px 20px;
            border-top: 1px solid #e0e0e0;
        }

        .chat-input-dashboard input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 25px;
            outline: none;
            font-family: inherit;
        }

        .chat-input-dashboard button {
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }

        .chat-input-dashboard button:hover {
            background-color: #0a3d6c;
        }

        .chat-input-dashboard button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        /* Message Type Selection Modal Styles */
        .message-type-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .message-type-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 25px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            position: relative;
        }

        .message-type-options {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin: 20px 0;
        }

        .message-type-option {
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            background: white;
        }

        .message-type-option:hover {
            border-color: var(--primary);
            background: #f8f9fa;
            transform: translateY(-2px);
        }

        .message-type-option.selected {
            border-color: var(--primary);
            background: #e3f2fd;
        }

        .message-type-icon {
            font-size: 24px;
            margin-bottom: 8px;
            display: block;
        }

        .message-type-title {
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
        }

        .message-type-desc {
            font-size: 12px;
            color: #666;
            line-height: 1.4;
        }

        .message-compose-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .message-compose-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 25px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            position: relative;
        }

        .message-type-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 15px;
        }

        .badge-general { background: #e3f2fd; color: #1976d2; }
        .badge-complaint { background: #fff3e0; color: #f57c00; }
        .badge-suggestion { background: #e8f5e8; color: #388e3c; }

        /* Updated Emergency Modal Styles - More Compact */
        .emergency-modal-tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 15px;
        }

        .emergency-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 14px;
        }

        .emergency-tab.active {
            background: #e74c3c;
            color: white;
        }

        .emergency-tab:first-child {
            border-radius: 4px 0 0 0;
        }

        .emergency-tab:last-child {
            border-radius: 0 4px 0 0;
        }

        .emergency-tab-content {
            display: none;
        }

        .emergency-tab-content.active {
            display: block;
        }

        /* Compact Emergency History Styles */
        .emergency-history-container {
            max-height: 250px;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        .emergency-history-item {
            border-left: 3px solid #e74c3c;
            padding: 12px;
            margin-bottom: 12px;
            background: #f8f9fa;
            border-radius: 0 6px 6px 0;
            font-size: 14px;
        }

        .emergency-history-item.resolved {
            border-left-color: #28a745;
        }

        .emergency-history-item.acknowledged {
            border-left-color: #ffc107;
        }

        .emergency-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .emergency-status {
            padding: 3px 6px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 500;
        }

        .status-pending { background: #fff3cd; color: #856404; }
        .status-acknowledged { background: #d1ecf1; color: #0c5460; }
        .status-resolved { background: #d4edda; color: #155724; }

        .emergency-date {
            color: #6c757d;
            font-size: 11px;
        }

        .emergency-message {
            margin: 6px 0;
            color: #495057;
            font-size: 13px;
            line-height: 1.4;
        }

        .admin-response {
            background: white;
            padding: 8px;
            border-radius: 5px;
            margin-top: 6px;
            border-left: 2px solid #007bff;
            font-size: 13px;
        }

        .no-response {
            color: #6c757d;
            font-style: italic;
            font-size: 12px;
        }

        /* Compact New Alert Form Styles */
        .emergency-form {
            margin-bottom: 15px;
        }

        .emergency-form textarea {
            width: 100%;
            height: 100px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            resize: vertical;
            font-family: inherit;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .emergency-info {
            background: #fff3cd;
            padding: 8px;
            border-radius: 5px;
            margin-bottom: 12px;
            border-left: 3px solid #ffc107;
            font-size: 13px;
        }

        .emergency-info i {
            color: #856404;
            margin-right: 6px;
        }

        /* Make modal content more compact */
        .modal-content {
            max-width: 500px !important;
            padding: 20px !important;
        }

        .modal-content h2 {
            font-size: 20px;
            margin-bottom: 15px;
        }

        /* Compact buttons */
        .btn-secondary, .btn-danger, .btn-primary, .view-button {
            padding: 8px 12px;
            font-size: 14px;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            right: 15px;
            top: 10px;
        }

        .close:hover {
            color: #000;
        }

        /* Button styles */
        .btn-secondary {
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-primary {
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn-primary:hover {
            background: #0069d9;
        }

        .view-button {
            background: #17a2b8;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            padding: 6px 10px;
            font-size: 12px;
            transition: background 0.3s;
        }

        .view-button:hover {
            background: #138496;
        }

        /* Hide changing text on mobile */
        @media (max-width: 768px) {
            .changing-text-container {
                display: none !important;
            }
            
            .top {
                justify-content: space-between;
            }
            
            .header-right {
                flex: 1;
                justify-content: flex-end;
            }

            .emergency-modal-tabs {
                flex-direction: column;
            }

            .emergency-tab {
                border-radius: 4px !important;
                margin-bottom: 4px;
            }
            
            .modal-content {
                max-width: 90% !important;
                margin: 10% auto;
                padding: 15px !important;
            }

            /* Mobile-specific chat widget styles */
            .chat-widget-container {
                right: 0;
                top: auto;
                bottom: 10px;
                transform: none;
            }
            
            .chat-toggle-btn {
                border-radius: 50%;
                width: 50px;
                height: 50px;
                border: 1px solid #e0e0e0;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            }
            
            .chat-toggle-btn:hover {
                width: 50px;
            }
            
            .chat-widget-dashboard {
                width: calc(100vw - 20px);
                max-width: 350px;
                right: 0;
                bottom: 60px;
            }

            .message-dashboard {
                max-width: 90%;
            }

            .message-type-content,
            .message-compose-content {
                margin: 20% auto;
                padding: 20px;
            }
        }

        /* Mobile responsive styles */
        @media (max-width: 480px) {
            .emergency-history-container {
                max-height: 200px;
            }
            
            .emergency-history-item {
                padding: 10px;
            }

            .emergency-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
            }
            
            .modal-content {
                padding: 12px !important;
            }
            
            .emergency-form textarea {
                height: 90px;
            }
            
            .header-right {
                gap: 10px;
            }
            
            .notification-icon.emergency {
                width: 36px;
                height: 36px;
            }

            .chat-body-dashboard {
                max-height: 300px;
            }

            .chat-toggle-btn {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }

            .message-type-options {
                gap: 8px;
            }

            .message-type-option {
                padding: 12px;
            }
        }
    </style>
</head>

<body>
    <!-- Mobile Menu Button -->
    <div class="mobile-menu-btn" onclick="toggleMenu()">
        <i class="fas fa-bars"></i>
    </div>

    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="logo-name">
            <div class="logo-image">
                <img src="images/barangay-bg.png" alt="BTMS Logo">
            </div>
            <span class="logo_name">Brgy. Talipapa</span>
        </div>

        <div class="menu-items">
            <ul class="nav-links">
                <li><a href="/residentdashboard" class="active">
                        <i class="fas fa-home"></i>
                        <span class="link-name">Dashboard</span>
                    </a></li>

                <li><a href="/requests">
                        <i class="fas fa-file-alt"></i>
                        <span class="link-name">Request Document</span>
                    </a></li>

                <li><a href="/announcement">
                        <i class="fas fa-bell"></i>
                        <span class="link-name">Announcements</span>
                    </a></li>
                <li><a href="/blotter">
                        <i class="fas fa-shield-alt"></i>
                        <span class="link-name">Blotter</span>
                    </a></li>
            </ul>

            <!-- Logout Section -->
            <div class="logout-section">
                <a href="#" id="sidebarLogoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                    <span class="link-name">Logout</span>
                </a>
            </div>
        </div>

        <!-- Greeting and Time Section - MOVED TO BOTTOM -->
        <div class="greeting-section">
            <div class="greeting" id="greetingText"></div>
            <div class="current-date" id="currentDate"></div>
            <div class="current-time" id="currentTime"></div>
        </div>
    </nav>

    <!-- Main Content -->
    <section class="main-content">
        <div class="top">
            <i class="fas fa-bars sidebar-toggle" onclick="toggleMenu()"></i>
            <div class="header-right">
                <!-- Changed notification icon to red emergency button -->
                <div class="notification-icon emergency" onclick="openEmergencyModal()" title="Emergency Alert">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge" id="notificationCount" style="display: none;">0</span>
                </div>
                <div class="profile-container">
                    <img id="profilePicture" class="profile-picture" src="" alt="Profile Picture"
                        onclick="toggleProfileDropdown()" />
                    <div class="profile-dropdown" id="profileDropdown">
                        <a href="/profile">
                            <i class="fas fa-user"></i>
                            <span>Profile</span>
                        </a>
                        <a href="#" id="logoutBtn">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Logout</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="dash-content">
            <div class="overview">
                <div class="title">
                    <i class="fas fa-tachometer-alt"></i>
                    <span class="text">Resident Dashboard</span>
                </div>
                <div class="boxes">
                    <div class="box box1" onclick="location.href='/requests'">
                        <i class="fas fa-file-alt"></i>
                        <span class="text"></span>
                        <span class="number" id="pendingRequests">0</span>
                    </div>
                    <div class="box box2" onclick="location.href='/announcement'">
                        <i class="fas fa-bell"></i>
                        <span class="text"></span>
                        <span class="number" id="newAnnouncements">0</span>
                    </div>
                    <div class="box box3" onclick="location.href='/blotter'">
                        <i class="fas fa-shield-alt"></i>
                        <span class="text"></span>
                        <span class="number" id="blotterCases">0</span>
                    </div>
                </div>
            </div>

            <!-- Recent Activity Section -->
            <div class="activity-section">
                <div class="title">
                    <i class="fas fa-clock"></i>
                    <span class="text">Recent Activity</span>
                </div>
                <table class="activity-table">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Description</th>
                            <th>Date</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="recentActivity">
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 20px;">No recent activity</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Floating Chat Widget -->
    <div class="chat-widget-container">
        <div class="chat-widget-dashboard" id="chatWidgetDashboard">
            <div class="chat-header-dashboard">
                <span class="text">Send Message to Barangay Officials</span>
                <button class="chat-close-btn" id="chatCloseBtn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="chat-body-dashboard">
                <div class="chat-messages-dashboard" id="chatMessagesDashboard">
                    <div class="no-messages-dashboard">
                        <i class="fas fa-comments" style="font-size: 48px; margin-bottom: 15px; color: #ddd;"></i>
                        <p>No messages yet. Start a conversation with barangay officials!</p>
                    </div>
                </div>
            </div>
            <div class="chat-input-dashboard">
                <input type="text" id="chatInputDashboard" placeholder="Click here to send a message..." readonly style="cursor: pointer;" onclick="openMessageTypeModal()">
                <button id="sendChatMessageDashboard" onclick="openMessageTypeModal()">
                    <i class="fas fa-edit"></i>
                </button>
            </div>
        </div>
        <button class="chat-toggle-btn" id="chatToggleBtn">
            <i class="fas fa-comments"></i>
        </button>
    </div>

    <!-- Message Type Selection Modal -->
    <div id="messageTypeModal" class="message-type-modal">
        <div class="message-type-content">
            <span class="close" onclick="closeMessageTypeModal()">&times;</span>
            <h2>Choose Message Type</h2>
            <p>Select the type of message you want to send:</p>
            
            <div class="message-type-options">
                <div class="message-type-option" onclick="selectMessageType('general')">
                    <i class="fas fa-envelope message-type-icon" style="color: #1976d2;"></i>
                    <div class="message-type-title">General Inquiry</div>
                    <div class="message-type-desc">For general questions and information requests</div>
                </div>
                
                <div class="message-type-option" onclick="selectMessageType('complaint')">
                    <i class="fas fa-exclamation-triangle message-type-icon" style="color: #f57c00;"></i>
                    <div class="message-type-title">Complaint</div>
                    <div class="message-type-desc">Report issues or concerns that need attention</div>
                </div>
                
                <div class="message-type-option" onclick="selectMessageType('suggestion')">
                    <i class="fas fa-lightbulb message-type-icon" style="color: #388e3c;"></i>
                    <div class="message-type-title">Suggestion</div>
                    <div class="message-type-desc">Share ideas and suggestions for improvement</div>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn-secondary" onclick="closeMessageTypeModal()" style="flex: 1;">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Message Compose Modal -->
    <div id="messageComposeModal" class="message-compose-modal">
        <div class="message-compose-content">
            <span class="close" onclick="closeMessageComposeModal()">&times;</span>
            <h2>Compose Message</h2>
            
            <div id="messageTypeBadge" class="message-type-badge badge-general">
                <i class="fas fa-envelope"></i> General Inquiry
            </div>
            
            <div class="form-group">
                <label for="messageSubject">Subject:</label>
                <input type="text" id="messageSubject" class="form-control" placeholder="Enter message subject...">
            </div>
            
            <div class="form-group">
                <label for="messageContent">Your Message:</label>
                <textarea id="messageContent" class="form-control" rows="6" placeholder="Type your message here..."></textarea>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn-secondary" onclick="closeMessageComposeModal()" style="flex: 1;">
                    Cancel
                </button>
                <button class="btn-primary" onclick="sendMessageToBarangay()" style="flex: 2;">
                    <i class="fas fa-paper-plane"></i> Send Message
                </button>
            </div>
        </div>
    </div>

    <!-- Emergency Modal with Tabs -->
    <div id="emergencyModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEmergencyModal()">&times;</span>
            <h2>🚨 Emergency Alerts</h2>
            
            <div class="emergency-modal-tabs">
                <button class="emergency-tab active" onclick="switchEmergencyTab('new-alert', event)">
                    <i class="fas fa-plus-circle"></i> New Alert
                </button>
                <button class="emergency-tab" onclick="switchEmergencyTab('history', event)">
                    <i class="fas fa-history"></i> Alert History
                </button>
            </div>

            <!-- New Alert Tab -->
            <div id="new-alert-tab" class="emergency-tab-content active">
                <div class="emergency-form">
                    <div class="emergency-info">
                        <i class="fas fa-exclamation-triangle"></i>
                        This will notify barangay admin immediately. Use only for real emergencies.
                    </div>
                    
                    <label for="emergencyMessageInput" style="display: block; margin-bottom: 8px; font-weight: 500;">
                        Describe your emergency:
                    </label>
                    <textarea 
                        id="emergencyMessageInput" 
                        placeholder="Please describe your emergency situation in detail...&#10;"
                    ></textarea>
                    
                    <p style="font-size: 12px; color: #666; margin-top: 5px;">
                        <i class="fas fa-info-circle"></i>
                        Admin will respond within 1 minute. If no response, your emergency will be sent to barangay mobile # and email.
                    </p>
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button class="btn-secondary" onclick="closeEmergencyModal()" style="flex: 1;">
                            Cancel
                        </button>
                        <button class="btn-danger" onclick="sendEmergencyAlertFromModal()" style="flex: 2;">
                            <i class="fas fa-bell"></i> Send Emergency Alert
                        </button>
                    </div>
                </div>
            </div>

            <!-- History Tab -->
            <div id="history-tab" class="emergency-tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0; font-size: 18px;">Your Emergency Alerts</h3>
                    <button class="view-button" onclick="loadEmergencyHistory()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
                
                <div class="emergency-history-container" id="emergencyHistory">
                    <div style="text-align: center; padding: 40px; color: #6c757d;">
                        <i class="fas fa-bell-slash" style="font-size: 48px; margin-bottom: 15px;"></i>
                        <p>No emergency alerts sent yet</p>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 15px;">
                    <button class="btn-primary" onclick="switchEmergencyTab('new-alert', event)">
                        <i class="fas fa-plus"></i> Send New Alert
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Logout Confirmation Modal -->
    <div id="logoutModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeLogoutModal()">&times;</span>
            <h3>Are you sure you want to logout?</h3>
            <div class="modal-actions">
                <button class="confirm" onclick="confirmLogout()">Yes, Logout</button>
                <button class="cancel" onclick="closeLogoutModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Application State
        const appState = {
            changingTexts: [
                "Welcome to Talipapa",
                "Community Dashboard",
                "Resident Services",
                "Barangay Talipapa",
                "Your Neighborhood Hub"
            ],
            currentTextIndex: 0,
            changingTextElement: null,
            changingTextInterval: null,
            emergencyAlerts: [],
            chatMessagesData: [],
            allActivities: [],
            viewedAnnouncements: JSON.parse(localStorage.getItem('viewedAnnouncements')) || [],
            socket: null,
            selectedMessageType: null
        };

        // DOM Elements
        const domElements = {
            // Will be populated on DOMContentLoaded
        };

        // Initialize the application
        function initApp() {
            initializeDOMReferences();
            setupEventListeners();
            initializeFeatures();
            checkAuthentication();
        }

        // Initialize DOM element references
        function initializeDOMReferences() {
            domElements.testTelegramBtn = document.getElementById('testTelegramBtn');
            domElements.testSMSBtn = document.getElementById('testSMSBtn');
            // Add other DOM element references as needed
        }

        // Set up event listeners
        function setupEventListeners() {
            // Emergency modal tab switching
            document.querySelectorAll('.emergency-tab').forEach(tab => {
                tab.addEventListener('click', function(event) {
                    const tabName = this.getAttribute('onclick').match(/'([^']+)'/)[1];
                    switchEmergencyTab(tabName, event);
                });
            });

            // Test buttons with proper event handling
            if (domElements.testTelegramBtn) {
                domElements.testTelegramBtn.addEventListener('click', function(event) {
                    testTelegram(this);
                });
            }

            if (domElements.testSMSBtn) {
                domElements.testSMSBtn.addEventListener('click', function(event) {
                    testTNTSMS(this);
                });
            }

            // Window resize handler
            window.addEventListener('resize', handleResize);
        }

        // Initialize application features
        function initializeFeatures() {
            addMobileCloseButton();
            updateGreetingAndTime();
            setupSidebarLogout();
            initChangingText();
            initChatWidget();
            
            // Start periodic data refresh
            setInterval(fetchResidentData, 30000);
        }

        // Check user authentication
        function checkAuthentication() {
            authFetch('/api/auth/check-auth')
                .then(response => {
                    if (!response) return;
                    return response.json();
                })
                .then(data => {
                    if (!data || !data.isAuthenticated) {
                        window.location.href = '/';
                    } else {
                        localStorage.setItem('userId', data.user.id);
                        localStorage.setItem('userEmail', data.user.email);
                        console.log('User authenticated:', data.user.email);
                        fetchResidentData();
                    }
                })
                .catch(error => {
                    console.error('Auth check error:', error);
                    window.location.href = '/';
                });
        }

        // ==================== MESSAGE TYPE SELECTION FUNCTIONS ====================

        function openMessageTypeModal() {
            const modal = document.getElementById('messageTypeModal');
            modal.style.display = 'block';
            
            // Reset any previously selected type
            appState.selectedMessageType = null;
            document.querySelectorAll('.message-type-option').forEach(option => {
                option.classList.remove('selected');
            });
        }

        function closeMessageTypeModal() {
            document.getElementById('messageTypeModal').style.display = 'none';
        }

        function selectMessageType(type) {
            appState.selectedMessageType = type;
            
            // Update UI to show selected type
            document.querySelectorAll('.message-type-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            // Close type selection modal and open compose modal
            setTimeout(() => {
                closeMessageTypeModal();
                openMessageComposeModal(type);
            }, 300);
        }

        function openMessageComposeModal(type) {
            const modal = document.getElementById('messageComposeModal');
            const badge = document.getElementById('messageTypeBadge');
            
            // Update badge based on type
            switch(type) {
                case 'general':
                    badge.className = 'message-type-badge badge-general';
                    badge.innerHTML = '<i class="fas fa-envelope"></i> General Inquiry';
                    break;
                case 'complaint':
                    badge.className = 'message-type-badge badge-complaint';
                    badge.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Complaint';
                    break;
                case 'suggestion':
                    badge.className = 'message-type-badge badge-suggestion';
                    badge.innerHTML = '<i class="fas fa-lightbulb"></i> Suggestion';
                    break;
            }
            
            // Clear previous inputs
            document.getElementById('messageSubject').value = '';
            document.getElementById('messageContent').value = '';
            
            // Set default subject based on type
            const subjectInput = document.getElementById('messageSubject');
            switch(type) {
                case 'general':
                    subjectInput.placeholder = 'e.g., Question about barangay services...';
                    break;
                case 'complaint':
                    subjectInput.placeholder = 'e.g., Concern about garbage collection...';
                    break;
                case 'suggestion':
                    subjectInput.placeholder = 'e.g., Suggestion for community improvement...';
                    break;
            }
            
            modal.style.display = 'block';
        }

        function closeMessageComposeModal() {
            document.getElementById('messageComposeModal').style.display = 'none';
            appState.selectedMessageType = null;
        }

        async function sendMessageToBarangay() {
            const subject = document.getElementById('messageSubject').value.trim();
            const content = document.getElementById('messageContent').value.trim();
            const type = appState.selectedMessageType;

            if (!subject) {
                showError('Please enter a subject for your message.');
                return;
            }

            if (!content) {
                showError('Please enter your message content.');
                return;
            }

            if (!type) {
                showError('Please select a message type.');
                return;
            }

            // Show loading state
            const sendButton = document.querySelector('#messageComposeModal .btn-primary');
            const originalText = sendButton.innerHTML;
            sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
            sendButton.disabled = true;

            try {
                const response = await authFetch('/api/messages/send', {
                    method: 'POST',
                    body: JSON.stringify({ 
                        subject: subject,
                        content: content,
                        type: type
                    })
                });

                if (!response) {
                    throw new Error('No response from server');
                }

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.success) {
                    showSuccess('Message sent successfully! Barangay officials will respond soon.');
                    
                    // Close modal
                    closeMessageComposeModal();
                    
                    // Reload chat messages to show the new message
                    loadChatMessages();
                    
                    // Update chat widget input placeholder
                    document.getElementById('chatInputDashboard').placeholder = 'Type your message here...';
                    
                } else {
                    throw new Error(data.error || 'Failed to send message');
                }
            } catch (error) {
                console.error('Error sending message:', error);
                showError('Failed to send message: ' + error.message);
            } finally {
                // Restore button state
                sendButton.innerHTML = originalText;
                sendButton.disabled = false;
            }
        }

        // ==================== EMERGENCY MODAL FUNCTIONS ====================

        function openEmergencyModal() {
            const modal = document.getElementById('emergencyModal');
            modal.style.display = 'block';
            
            // Ensure modal is properly sized
            const modalContent = modal.querySelector('.modal-content');
            modalContent.style.maxWidth = '500px';
            
            // Load emergency history when modal opens
            loadEmergencyHistory();
        }

        function closeEmergencyModal() {
            document.getElementById('emergencyModal').style.display = 'none';
            // Clear the message input
            document.getElementById('emergencyMessageInput').value = '';
        }

        function switchEmergencyTab(tabName, event) {
            console.log('Switching to tab:', tabName);
            
            // Hide all tab contents
            document.querySelectorAll('.emergency-tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.emergency-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            const targetTab = document.getElementById(tabName + '-tab');
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            // Add active class to clicked tab
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            // If switching to history tab, refresh the history
            if (tabName === 'history') {
                loadEmergencyHistory();
            }
        }

        // ==================== TESTING FUNCTIONS ====================

        async function testTelegram(button) {
            try {
                console.log('🧪 Testing Telegram Bot functionality...');
                
                // Show loading state
                const testButton = button || event.target;
                const originalText = testButton.innerHTML;
                testButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
                testButton.disabled = true;

                const response = await fetch('/api/emergency/test-telegram', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    credentials: 'include'
                });

                if (!response) {
                    throw new Error('No response from server');
                }

                // Check if response is OK
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Telegram test response:', data);
                
                if (data.success) {
                    showSuccess('✅ Telegram test sent successfully! Check your Telegram app for the test message.');
                } else {
                    throw new Error(data.error || 'Telegram test failed');
                }
                
                return data;
            } catch (error) {
                console.error('Telegram test error:', error);
                showError('❌ Telegram test failed: ' + error.message);
                return { success: false, error: error.message };
            } finally {
                // Restore button state
                const testButton = button || event.target;
                if (testButton) {
                    testButton.innerHTML = '<i class="fab fa-telegram"></i> Test Telegram';
                    testButton.disabled = false;
                }
            }
        }

        async function testTNTSMS(button) {
            try {
                console.log('🧪 Testing TNT SMS functionality...');
                
                // Show loading state
                const testButton = button || event.target;
                const originalText = testButton.innerHTML;
                testButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
                testButton.disabled = true;

                const response = await fetch('/api/emergency/test-tnt-sms', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ test: true })
                });

                if (!response) {
                    throw new Error('No response from server');
                }

                // Check if response is OK
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('SMS test response:', data);
                
                if (data.success) {
                    showSuccess('✅ SMS test sent successfully! Check your TNT phone for test messages via WhatsApp or SMS.');
                } else {
                    throw new Error(data.error || 'SMS test failed');
                }
                
                return data;
            } catch (error) {
                console.error('SMS test error:', error);
                showError('❌ SMS test failed: ' + error.message);
                return { success: false, error: error.message };
            } finally {
                // Restore button state
                const testButton = button || event.target;
                if (testButton) {
                    testButton.innerHTML = '<i class="fas fa-vial"></i> Test SMS System';
                    testButton.disabled = false;
                }
            }
        }

        // ==================== EMERGENCY ALERT FUNCTIONS ====================

        async function sendEmergencyAlertFromModal() {
            const messageInput = document.getElementById('emergencyMessageInput');
            const message = messageInput ? messageInput.value.trim() : '';

            if (!message) {
                showError('Please describe your emergency situation before sending the alert.');
                return;
            }

            // Show loading state with compact styling
            const sendButton = document.querySelector('.btn-danger');
            const originalText = sendButton.innerHTML;
            sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
            sendButton.disabled = true;
            sendButton.style.padding = '8px 12px';
            sendButton.style.fontSize = '14px';

            try {
                const userEmail = localStorage.getItem('userEmail');
                console.log('Sending emergency alert for user:', userEmail);
                
                const response = await authFetch('/api/emergency/send', {
                    method: 'POST',
                    body: JSON.stringify({ 
                        email: userEmail, 
                        message: message 
                    })
                });

                if (!response) {
                    throw new Error('No response from server');
                }

                // Check if response is OK
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Send alert response:', data);
                
                if (data.success) {
                    showSuccess('Emergency alert sent successfully! Barangay officials have been notified and will respond within 1 minute.');
                    
                    // Clear the message input
                    document.getElementById('emergencyMessageInput').value = '';
                    
                    // Add the new alert to local state
                    if (data.alert) {
                        appState.emergencyAlerts.unshift(data.alert);
                        displayEmergencyHistory();
                    }
                    
                    // Switch to history tab without event parameter
                    switchEmergencyTab('history', null);
                    
                    // Close modal after successful send
                    setTimeout(() => {
                        closeEmergencyModal();
                    }, 2000);
                    
                } else {
                    throw new Error(data.error || 'Failed to send emergency alert');
                }
            } catch (error) {
                console.error('Error sending emergency alert:', error);
                showError('Failed to send emergency alert: ' + error.message);
            } finally {
                // Restore button state
                sendButton.innerHTML = originalText;
                sendButton.disabled = false;
            }
        }

        async function loadEmergencyHistory() {
            try {
                console.log('Loading emergency history...');
                const response = await authFetch('/api/emergency/my-alerts');
                
                if (!response) {
                    console.error('No response from server - authentication may have failed');
                    showError('Authentication failed. Please refresh the page.');
                    return;
                }

                const data = await response.json();
                console.log('Emergency history response:', data);
                
                if (response.ok && data.success) {
                    appState.emergencyAlerts = data.alerts || [];
                    displayEmergencyHistory();
                } else {
                    console.error('Failed to load emergency history:', data.error);
                    
                    // Try alternative method if main endpoint fails
                    const userId = localStorage.getItem('userId');
                    if (userId) {
                        console.log('Trying alternative endpoint with user ID:', userId);
                        await loadEmergencyHistoryAlternative(userId);
                    } else {
                        showError('Failed to load emergency history: ' + (data.error || 'Unknown error'));
                    }
                }
            } catch (error) {
                console.error('Error loading emergency history:', error);
                showError('Error loading emergency history: ' + error.message);
            }
        }

        // Alternative method to load emergency history
        async function loadEmergencyHistoryAlternative(userId) {
            try {
                const response = await authFetch(`/api/emergency/user/${userId}/alerts`);
                if (!response) return;

                const data = await response.json();
                if (response.ok && data.success) {
                    appState.emergencyAlerts = data.alerts || [];
                    displayEmergencyHistory();
                } else {
                    showError('Failed to load emergency history');
                }
            } catch (error) {
                console.error('Error in alternative history load:', error);
                showError('Unable to load emergency history');
            }
        }

        // Display emergency alert history
        function displayEmergencyHistory() {
            const historyContainer = document.getElementById('emergencyHistory');
            
            if (appState.emergencyAlerts.length === 0) {
                historyContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6c757d;">
                        <i class="fas fa-bell-slash" style="font-size: 48px; margin-bottom: 15px;"></i>
                        <p>No emergency alerts sent yet</p>
                    </div>
                `;
                return;
            }

            // Sort alerts by date (newest first) and filter out resolved alerts
            const sortedAlerts = appState.emergencyAlerts
                .filter(alert => alert.status !== 'resolved') // Remove resolved alerts
                .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            historyContainer.innerHTML = sortedAlerts.map(alert => {
                const alertDate = new Date(alert.createdAt).toLocaleString();
                let statusClass = 'status-pending';
                let itemClass = '';
                
                if (alert.status === 'acknowledged') {
                    statusClass = 'status-acknowledged';
                    itemClass = 'acknowledged';
                } else if (alert.status === 'resolved') {
                    statusClass = 'status-resolved';
                    itemClass = 'resolved';
                }
                
                return `
                    <div class="emergency-history-item ${itemClass}">
                        <div class="emergency-header">
                            <span class="emergency-status ${statusClass}">${alert.status.toUpperCase()}</span>
                            <span class="emergency-date">${alertDate}</span>
                        </div>
                        <div class="emergency-message">
                            <strong>Your Alert:</strong> ${alert.message}
                        </div>
                        ${alert.adminResponse ? `
                            <div class="admin-response">
                                <div class="response-label">Admin Response:</div>
                                <div>${alert.adminResponse}</div>
                                ${alert.acknowledgedAt ? `
                                    <div style="font-size: 12px; color: #6c757d; margin-top: 5px;">
                                        Responded: ${new Date(alert.acknowledgedAt).toLocaleString()}
                                    </div>
                                ` : ''}
                            </div>
                        ` : `
                            <div class="admin-response">
                                <div class="no-response">Waiting for admin response...</div>
                            </div>
                        `}
                    </div>
                `;
            }).join('');

            // Show message if all alerts are resolved
            if (sortedAlerts.length === 0) {
                historyContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6c757d;">
                        <i class="fas fa-check-circle" style="font-size: 48px; margin-bottom: 15px; color: #28a745;"></i>
                        <p>All your emergency alerts have been resolved</p>
                        <p style="font-size: 14px; margin-top: 10px;">You can send a new emergency alert if needed</p>
                    </div>
                `;
            }
        }

        // ==================== CHAT FUNCTIONALITY ====================

        // Initialize chat functionality
        function initChatWidget() {
            const chatWidget = document.getElementById('chatWidgetDashboard');
            const chatToggle = document.getElementById('chatToggleBtn');
            const chatClose = document.getElementById('chatCloseBtn');
            const chatInput = document.getElementById('chatInputDashboard');

            // Toggle chat widget
            chatToggle.addEventListener('click', function() {
                chatWidget.classList.toggle('active');
                if (chatWidget.classList.contains('active')) {
                    loadChatMessages();
                }
            });

            // Close chat widget
            chatClose.addEventListener('click', function() {
                chatWidget.classList.remove('active');
            });

            // Close chat when clicking outside
            document.addEventListener('click', function(event) {
                if (!event.target.closest('.chat-widget-dashboard') && 
                    !event.target.closest('.chat-toggle-btn')) {
                    chatWidget.classList.remove('active');
                }
            });

            // Make input clickable to open message type modal
            chatInput.addEventListener('click', openMessageTypeModal);

            // Load messages initially
            loadChatMessages();
        }

        // Load chat messages for dashboard
        async function loadChatMessages() {
            try {
                const response = await authFetch('/api/messages/my-messages');
                
                if (response && response.ok) {
                    const data = await response.json();
                    appState.chatMessagesData = data.data || [];
                    displayChatMessages();
                }
            } catch (error) {
                console.error('Error loading chat messages:', error);
            }
        }

        // Display chat messages in dashboard
        function displayChatMessages() {
            const chatMessages = document.getElementById('chatMessagesDashboard');
            
            if (appState.chatMessagesData.length === 0) {
                chatMessages.innerHTML = `
                    <div class="no-messages-dashboard">
                        <i class="fas fa-comments" style="font-size: 48px; margin-bottom: 15px; color: #ddd;"></i>
                        <p>No messages yet. Start a conversation with barangay officials!</p>
                    </div>
                `;
                return;
            }

            chatMessages.innerHTML = '';
            appState.chatMessagesData.forEach(message => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message-dashboard user`;
                
                const time = new Date(message.createdAt).toLocaleTimeString([], { 
                    hour: '2-digit', minute: '2-digit' 
                });
                
                // Add message type badge
                let typeBadge = '';
                if (message.type) {
                    let badgeClass = 'badge-general';
                    let badgeText = 'General';
                    let badgeIcon = 'fa-envelope';
                    
                    switch(message.type) {
                        case 'complaint':
                            badgeClass = 'badge-complaint';
                            badgeText = 'Complaint';
                            badgeIcon = 'fa-exclamation-triangle';
                            break;
                        case 'suggestion':
                            badgeClass = 'badge-suggestion';
                            badgeText = 'Suggestion';
                            badgeIcon = 'fa-lightbulb';
                            break;
                    }
                    
                    typeBadge = `<span class="message-type-badge ${badgeClass}" style="font-size: 10px; margin-bottom: 5px; display: inline-block;">
                        <i class="fas ${badgeIcon}"></i> ${badgeText}
                    </span>`;
                }
                
                let messageContent = `
                    ${typeBadge}
                    <div>${message.content}</div>
                    <span class="message-time-dashboard">${time}</span>
                `;
                
                // Add admin response if exists
                if (message.adminResponse) {
                    messageContent += `
                        <div class="admin-response-dashboard">
                            <div class="response-label">Admin Response:</div>
                            <div>${message.adminResponse}</div>
                            <span class="message-time-dashboard">
                                ${new Date(message.respondedAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                            </span>
                        </div>
                    `;
                }
                
                messageDiv.innerHTML = messageContent;
                chatMessages.appendChild(messageDiv);
            });

            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // ==================== CHANGING TEXT EFFECT ====================

        function initChangingText() {
            // Check if we're on mobile - don't show changing text on mobile
            if (window.innerWidth <= 768) {
                return; // Exit function on mobile
            }

            // Create changing text container and element
            const topSection = document.querySelector('.top');
            const changingTextContainer = document.createElement('div');
            changingTextContainer.className = 'changing-text-container';
            
            appState.changingTextElement = document.createElement('span');
            appState.changingTextElement.className = 'changing-text';
            appState.changingTextElement.textContent = appState.changingTexts[0];
            
            changingTextContainer.appendChild(appState.changingTextElement);
            
            // Append to the top section
            topSection.appendChild(changingTextContainer);
            
            // Start the text rotation
            appState.changingTextInterval = setInterval(updateChangingText, 4000);
        }

        function updateChangingText() {
            // Check if we're on mobile - stop animation if so
            if (window.innerWidth <= 768) {
                clearInterval(appState.changingTextInterval);
                return;
            }

            // Fade out current text
            appState.changingTextElement.classList.add('hidden');
            
            setTimeout(() => {
                // Change text
                appState.currentTextIndex = (appState.currentTextIndex + 1) % appState.changingTexts.length;
                appState.changingTextElement.textContent = appState.changingTexts[appState.currentTextIndex];
                
                // Fade in new text
                appState.changingTextElement.classList.remove('hidden');
            }, 500);
        }

        // Handle window resize to stop/start changing text
        function handleResize() {
            const changingTextContainer = document.querySelector('.changing-text-container');
            
            if (window.innerWidth <= 768) {
                // Mobile view - hide changing text and clear interval
                if (changingTextContainer) {
                    changingTextContainer.style.display = 'none';
                }
                if (appState.changingTextInterval) {
                    clearInterval(appState.changingTextInterval);
                }
            } else {
                // Desktop view - show changing text and restart interval
                if (changingTextContainer) {
                    changingTextContainer.style.display = 'flex';
                }
                // Reinitialize if not already initialized
                if (!appState.changingTextElement && changingTextContainer) {
                    initChangingText();
                } else if (appState.changingTextElement && !appState.changingTextInterval) {
                    appState.changingTextInterval = setInterval(updateChangingText, 4000);
                }
            }
        }

        // ==================== UTILITY FUNCTIONS ====================

        // Enhanced authFetch function with better error handling
        async function authFetch(url, options = {}) {
            try {
                // Ensure URL is properly formatted
                if (!url.startsWith('/')) {
                    url = '/' + url;
                }
                
                // Remove any double slashes
                url = url.replace(/([^:]\/)\/+/g, "$1");
                
                console.log(`🔗 Making request to: ${url}`);
                
                const response = await fetch(url, {
                    ...options,
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    }
                });
                
                if (response.status === 401) {
                    console.log('Authentication failed, redirecting to login');
                    window.location.href = "/";
                    return null;
                }
                
                if (response.status === 404) {
                    console.error('Endpoint not found:', url);
                    throw new Error(`API endpoint not found: ${url}`);
                }
                
                return response;
            } catch (error) {
                console.error('Auth fetch error:', error);
                
                // Show specific error messages
                if (error.message.includes('Failed to fetch')) {
                    showError('Network error: Cannot connect to server. Please check your internet connection.');
                } else if (error.message.includes('API endpoint not found')) {
                    showError('Server error: API endpoint not found. Please contact administrator.');
                } else {
                    showError('Connection error: ' + error.message);
                }
                
                return null;
            }
        }

        // Simple notification functions
        function showSuccess(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #28a745;
                color: white;
                padding: 15px 20px;
                border-radius: 5px;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                max-width: 400px;
                animation: slideInRight 0.5s ease-out;
            `;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-check-circle"></i>
                    <span>${message}</span>
                </div>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }

        function showError(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #e74c3c;
                color: white;
                padding: 15px 20px;
                border-radius: 5px;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                max-width: 400px;
                animation: slideInRight 0.5s ease-out;
            `;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>${message}</span>
                </div>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }

        // Toggle sidebar menu
        function toggleMenu() {
            const sidebar = document.querySelector('.sidebar');
            const menuBtn = document.querySelector('.mobile-menu-btn');
            sidebar.classList.toggle('active');

            if (sidebar.classList.contains('active')) {
                menuBtn.style.display = 'none';
            } else {
                menuBtn.style.display = 'flex';
            }
        }

        // Create and add mobile close button to sidebar
        function addMobileCloseButton() {
            const sidebar = document.querySelector('.sidebar');
            const closeBtn = document.createElement('div');
            closeBtn.className = 'mobile-close-btn';
            closeBtn.innerHTML = '<i class="fas fa-times"></i>';
            closeBtn.onclick = toggleMenu;
            
            const logoName = document.querySelector('.logo-name');
            logoName.appendChild(closeBtn);
        }

        // Close sidebar when clicking on a link (mobile)
        document.querySelectorAll('.nav-links a').forEach(link => {
            link.addEventListener('click', () => {
                if (window.innerWidth <= 768) {
                    toggleMenu();
                }
            });
        });

        // Toggle profile dropdown
        function toggleProfileDropdown() {
            document.getElementById('profileDropdown').classList.toggle('active');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function (event) {
            const profileContainer = document.querySelector('.profile-container');
            const profileDropdown = document.getElementById('profileDropdown');

            if (!profileContainer.contains(event.target)) {
                profileDropdown.classList.remove('active');
            }
        });

        // Update greeting and time
        function updateGreetingAndTime() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');

            // Set greeting based on time of day
            let greeting;
            if (hours < 12) {
                greeting = "Good Morning";
            } else if (hours < 18) {
                greeting = "Good Afternoon";
            } else {
                greeting = "Good Evening";
            }

            // Format date
            const options = { weekday: 'long', year: 'numeric', month: 'short', day: 'numeric' };
            const dateString = now.toLocaleDateString('en-US', options);

            // Format time with AM/PM
            const ampm = hours >= 12 ? 'PM' : 'AM';
            const formattedHours = hours % 12 || 12;
            const timeString = `${formattedHours}:${minutes}:${seconds} ${ampm}`;

            // Update DOM elements
            const greetingText = document.getElementById('greetingText');
            const currentDate = document.getElementById('currentDate');
            const currentTime = document.getElementById('currentTime');

            if (greetingText) greetingText.textContent = greeting;
            if (currentDate) currentDate.textContent = dateString;
            if (currentTime) currentTime.textContent = timeString;
        }

        // Update time every second
        setInterval(updateGreetingAndTime, 1000);
        updateGreetingAndTime(); // Initial call

        // ==================== DASHBOARD DATA FUNCTIONS ====================

        async function fetchResidentData() {
            try {
                const [profileResponse, requestsResponse, announcementsResponse, blotterResponse] = await Promise.all([
                    authFetch('/api/auth/profile'),
                    authFetch('/api/requests/user'),
                    authFetch('/api/announcements/user'),
                    authFetch('/api/blotter/user')
                ]);

                if (!profileResponse || !requestsResponse || !announcementsResponse || !blotterResponse) {
                    return;
                }

                const profileData = profileResponse.ok ? await profileResponse.json() : null;
                const requests = requestsResponse.ok ? await requestsResponse.json() : [];
                const announcements = announcementsResponse.ok ? await announcementsResponse.json() : [];
                let blotterCases = [];

                if (blotterResponse.ok) {
                    try {
                        blotterCases = await blotterResponse.json();
                        if (!Array.isArray(blotterCases)) {
                            console.error('Blotter data is not an array:', blotterCases);
                            blotterCases = [];
                        }
                    } catch (e) {
                        console.error('Error parsing blotter response:', e);
                        blotterCases = [];
                    }
                }

                if (profileData) {
                    const profilePic = document.getElementById('profilePicture');
                    if (profileData.profilePicture) {
                        if (profileData.profilePicture.startsWith('http') || profileData.profilePicture.startsWith('/')) {
                            profilePic.src = profileData.profilePicture;
                        } else {
                            profilePic.src = '/uploads/' + profileData.profilePicture;
                        }
                    } else {
                        profilePic.src = 'images/profile.jpg';
                    }
                }

                const pendingRequests = requests.filter(r => r.status === "Pending").length;
                document.getElementById('pendingRequests').textContent = `${pendingRequests} Pending`;

                const recentAnnouncements = announcements.filter(a =>
                    new Date(a.createdAt) > new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)
                );
                const unviewedAnnouncements = recentAnnouncements.filter(a =>
                    !appState.viewedAnnouncements.includes(a._id)
                );
                document.getElementById('newAnnouncements').textContent = `${unviewedAnnouncements.length} Announcement${unviewedAnnouncements.length !== 1 ? 's' : ''}`;

                const activeBlotterCases = Array.isArray(blotterCases) ?
                    blotterCases.filter(b =>
                        b.status === "Pending" || b.status === "Under Investigation"
                    ).length : 0;

                document.getElementById('blotterCases').textContent = `${activeBlotterCases} Blotter Case${activeBlotterCases !== 1 ? 's' : ''}`;

                // Update recent activity (show only 3 most recent)
                updateRecentActivity(requests, blotterCases);

            } catch (error) {
                console.error('Fetch error:', error);
                document.getElementById('blotterCases').textContent = '0 Blotter Cases';
            }
        }

        function updateRecentActivity(requests, blotterCases) {
            const activityTable = document.getElementById('recentActivity');
            if (!activityTable) return;

            // Combine activities
            appState.allActivities = [];

            // Add requests
            requests.forEach(request => {
                appState.allActivities.push({
                    type: 'Request',
                    description: `Request for ${request.documentType || 'Document'}`,
                    date: new Date(request.createdAt || request.date).toLocaleDateString(),
                    status: request.status,
                    id: request._id
                });
            });

            // Add blotter cases
            if (Array.isArray(blotterCases)) {
                blotterCases.forEach(blotter => {
                    appState.allActivities.push({
                        type: 'Blotter',
                        description: `Blotter Case: ${blotter.incidentType || 'Incident Report'}`,
                        date: new Date(blotter.createdAt || blotter.date).toLocaleDateString(),
                        status: blotter.status,
                        id: blotter._id
                    });
                });
            }

            // Sort by date (newest first) and take only 3
            appState.allActivities.sort((a, b) => new Date(b.date) - new Date(a.date));
            const displayActivities = appState.allActivities.slice(0, 3);

            // Clear table
            activityTable.innerHTML = '';

            if (displayActivities.length === 0) {
                activityTable.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">No recent activity</td></tr>';
                return;
            }

            // Add activities to table
            displayActivities.forEach(activity => {
                const row = document.createElement('tr');

                // Status badge
                let statusClass = 'status-pending';
                if (activity.status === 'Under Investigation') statusClass = 'status-under-investigation';
                else if (activity.status === 'Resolved') statusClass = 'status-resolved';
                else if (activity.status === 'Dismissed') statusClass = 'status-dismissed';

                row.innerHTML = `
                    <td>${activity.type}</td>
                    <td>${activity.description}</td>
                    <td>${activity.date}</td>
                    <td><span class="status ${statusClass}">${activity.status}</span></td>
                    <td>
                        <button class="view-button" onclick="viewActivity('${activity.type}', '${activity.id}')">
                            View
                        </button>
                    </td>
                `;

                activityTable.appendChild(row);
            });
        }

        function viewActivity(type, id) {
            if (type === 'Request') {
                window.location.href = `/requests#${id}`;
            } else if (type === 'Blotter') {
                window.location.href = `/blotter#${id}`;
            }
        }

        // ==================== LOGOUT FUNCTIONALITY ====================

        // Logout functionality
        function openLogoutModal() {
            document.getElementById('logoutModal').style.display = 'block';
        }

        function closeLogoutModal() {
            document.getElementById('logoutModal').style.display = 'none';
        }

        async function confirmLogout() {
            try {
                const response = await fetch('/api/auth/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    window.location.href = '/login';
                } else {
                    throw new Error('Logout failed');
                }
            } catch (error) {
                console.error('Logout error:', error);
                alert('Failed to logout. Please try again.');
            }
        }

        // Sidebar logout functionality
        function setupSidebarLogout() {
            const sidebarLogoutBtn = document.getElementById('sidebarLogoutBtn');
            if (sidebarLogoutBtn) {
                sidebarLogoutBtn.addEventListener('click', function (e) {
                    e.preventDefault();
                    openLogoutModal();
                });
            }
        }

        // Close modals when clicking outside
        window.addEventListener('click', function (event) {
            const logoutModal = document.getElementById('logoutModal');
            const emergencyModal = document.getElementById('emergencyModal');
            const messageTypeModal = document.getElementById('messageTypeModal');
            const messageComposeModal = document.getElementById('messageComposeModal');

            if (event.target === logoutModal) {
                closeLogoutModal();
            }
            if (event.target === emergencyModal) {
                closeEmergencyModal();
            }
            if (event.target === messageTypeModal) {
                closeMessageTypeModal();
            }
            if (event.target === messageComposeModal) {
                closeMessageComposeModal();
            }
        });

        // Set up logout button
        document.getElementById('logoutBtn').addEventListener('click', function (e) {
            e.preventDefault();
            openLogoutModal();
        });

        // ==================== SOCKET.IO FUNCTIONALITY ====================

        // Initialize Socket.io connection
        appState.socket = io({ withCredentials: true });

        // Request notification permission
        if (Notification.permission !== "granted") {
            Notification.requestPermission().then(permission => {
                console.log('Notification permission:', permission);
            });
        }

        // Socket event listeners for real-time updates
        appState.socket.on('request-updated', (request) => {
            if (request.userId === localStorage.getItem('userId')) {
                showNotification(`Your request status updated to ${request.status}`);
                fetchResidentData();
            }
        });

        appState.socket.on('new_announcement', (announcement) => {
            showNotification(`New announcement: ${announcement.title}`);
            fetchResidentData();
        });

        appState.socket.on('emergencyResponse', (response) => {
            console.log('Received emergency response:', response);
            if (response.residentId === localStorage.getItem('userId')) {
                showEmergencyResponseNotification(response.message, response.alertId);
                // Reload emergency history to reflect the update
                loadEmergencyHistory();
            }
        });

        appState.socket.on('alertResolved', (alertId) => {
            console.log('Alert resolved:', alertId);
            handleAlertResolved(alertId);
        });

        appState.socket.on('blotter-updated', (blotter) => {
            if (blotter.complainant === localStorage.getItem('userId')) {
                showNotification(`Your blotter report status updated to ${blotter.status}`);
                fetchResidentData();
            }
        });

        // Listen for new chat messages
        appState.socket.on('newMessage', (message) => {
            if (message.userId === localStorage.getItem('userId')) {
                loadChatMessages(); // Reload chat messages
                showNotification('New message response from barangay');
            }
        });

        // Listen for admin responses to messages
        appState.socket.on('messageResponse', (response) => {
            if (response.userId === localStorage.getItem('userId')) {
                loadChatMessages(); // Reload chat messages
                showNotification('New response to your message');
            }
        });

        // Listen for new emergency alerts (for testing)
        appState.socket.on('newEmergencyAlert', (alert) => {
            console.log('New emergency alert received (for testing):', alert);
        });

        // Enhanced notification for emergency responses
        function showEmergencyResponseNotification(message, alertId) {
            // Create a prominent notification for emergency responses
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #007bff;
                color: white;
                padding: 20px;
                border-radius: 8px;
                z-index: 10000;
                box-shadow: 0 8px 25px rgba(0,0,0,0.3);
                max-width: 400px;
                border-left: 5px solid #0056b3;
                animation: slideInRight 0.5s ease-out;
            `;
            notification.innerHTML = `
                <div style="display: flex; align-items: flex-start; gap: 15px;">
                    <i class="fas fa-bell" style="font-size: 24px; margin-top: 2px;"></i>
                    <div style="flex: 1;">
                        <h4 style="margin: 0 0 8px 0; font-size: 16px;">🚨 Emergency Response Received</h4>
                        <p style="margin: 0; font-size: 14px; line-height: 1.4;">${message}</p>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                style="margin-top: 10px; background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
                            Dismiss
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(notification);
            
            // Auto remove after 10 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 10000);

            // Update the specific alert in the history
            const alertIndex = appState.emergencyAlerts.findIndex(alert => alert._id === alertId);
            if (alertIndex !== -1) {
                appState.emergencyAlerts[alertIndex].adminResponse = message;
                appState.emergencyAlerts[alertIndex].status = 'acknowledged';
                appState.emergencyAlerts[alertIndex].acknowledgedAt = new Date();
                displayEmergencyHistory();
            }

            // Also show browser notification
            if (Notification.permission === "granted") {
                new Notification("🚨 Emergency Response", {
                    body: message,
                    icon: '/images/barangay-bg.png',
                    tag: 'emergency-response'
                });
            }
        }

        // Handle alert resolution
        function handleAlertResolved(alertId) {
            // Remove resolved alert from local state
            const alertIndex = appState.emergencyAlerts.findIndex(alert => alert._id === alertId);
            if (alertIndex !== -1) {
                appState.emergencyAlerts.splice(alertIndex, 1);
                displayEmergencyHistory();
                
                // Show resolution notification
                showSuccess('Your emergency alert has been resolved by the admin.');
            }
        }

        function showNotification(message) {
            if (Notification.permission === "granted") {
                new Notification("BTMS Notification", { 
                    body: message,
                    icon: '/images/barangay-bg.png'
                });
            } else {
                // Fallback to better notification
                showSuccess(message);
            }
        }

        // ==================== INITIALIZATION ====================

        // Initialize the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', function () {
            initApp();
        });

        // Add CSS animation for notifications
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            
            .form-group {
                margin-bottom: 15px;
            }
            
            .form-group label {
                display: block;
                margin-bottom: 5px;
                font-weight: 500;
                color: #333;
            }
            
            .form-control {
                width: 100%;
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 5px;
                font-family: inherit;
                font-size: 14px;
            }
            
            .form-control:focus {
                outline: none;
                border-color: var(--primary);
                box-shadow: 0 0 0 2px rgba(13, 79, 139, 0.1);
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>