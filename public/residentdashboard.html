<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/residentdashboard.css">
    <title>Resident Dashboard - Barangay Talipapa</title>
</head>

<body>
    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="logo-name">
            <div class="logo-image">
                <img src="images/barangay-bg.png" alt="BTMS Logo">
            </div>
            <span class="logo_name">Brgy. Talipapa</span>
        </div>

        <div class="menu-items">
            <ul class="nav-links">
                <li><a href="/residentdashboard" class="active">
                        <i class="fas fa-home"></i>
                        <span class="link-name">Dashboard</span>
                    </a></li>

                <li><a href="/requests">
                        <i class="fas fa-file-alt"></i>
                        <span class="link-name">Request Document</span>
                    </a></li>

                <li><a href="/blotter">
                        <i class="fas fa-shield-alt"></i>
                        <span class="link-name">Blotter</span>
                    </a></li>



                <li><a href="/announcement">
                        <i class="fas fa-bell"></i>
                        <span class="link-name">Announcements</span>
                    </a></li>
            </ul>

            <!-- Logout Section -->
            <div class="logout-section">
                <a href="#" id="sidebarLogoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                    <span class="link-name">Logout</span>
                </a>
            </div>
        </div>

        <!-- Greeting and Time Section - MOVED TO BOTTOM -->
        <div class="greeting-section">
            <div class="greeting" id="greetingText"></div>
            <div class="current-date" id="currentDate"></div>
            <div class="current-time" id="currentTime"></div>
        </div>
    </nav>

    <!-- Main Content -->
    <section class="main-content">
        <div class="top">
            <i class="fas fa-bars sidebar-toggle" onclick="toggleMenu()"></i>
            <div class="header-right">
                <div class="notification-icon" onclick="toggleNotifications()">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge" id="notificationCount" style="display: none;">0</span>
                </div>
                <div class="profile-container">
                    <img id="profilePicture" class="profile-picture" src="" alt="Profile Picture"
                        onclick="toggleProfileDropdown()" />
                    <div class="profile-dropdown" id="profileDropdown">
                        <a href="/profile">
                            <i class="fas fa-user"></i>
                            <span>Profile</span>
                        </a>
                        <a href="#" id="logoutBtn">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Logout</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="dash-content">
            <div class="overview">
                <div class="title">
                    <i class="fas fa-tachometer-alt"></i>
                    <span class="text">Resident Dashboard</span>
                </div>
                <div class="boxes">
                    <div class="box box1" onclick="location.href='/Requests'">
                        <i class="fas fa-file-alt"></i>
                        <span class="text"></span>
                        <span class="number" id="pendingRequests">0</span>
                    </div>
                    <div class="box box2" onclick="location.href='/announcement'">
                        <i class="fas fa-bell"></i>
                        <span class="text"></span>
                        <span class="number" id="newAnnouncements">0</span>
                    </div>
                    <div class="box box3" onclick="location.href='/blotter'">
                        <i class="fas fa-shield-alt"></i>
                        <span class="text"></span>
                        <span class="number" id="blotterCases">0</span>
                    </div>
                </div>
            </div>

            <!-- Recent Activity Section -->
            <div class="activity-section">
                <div class="title">
                    <i class="fas fa-clock"></i>
                    <span class="text">Recent Activity</span>
                </div>
                <table class="activity-table">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Description</th>
                            <th>Date</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="recentActivity">
                        <!-- Activity data will be populated by JavaScript -->
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 20px;">No recent activity</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Emergency Button -->
    <div class="emergency-button-container">
        <button class="emergency-button" onclick="openEmergencyModal()">
            <i class="fas fa-bell"></i> <span>Emergency</span>
        </button>
    </div>

    <!-- Emergency Modal -->
    <div id="emergencyModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEmergencyModal()">&times;</span>
            <h2>Send Emergency Alert</h2>
            <textarea id="emergencyMessage" placeholder="Describe your emergency..."></textarea>
            <button onclick="sendEmergencyAlert()">Send Alert</button>
        </div>
    </div>

    <!-- Logout Confirmation Modal -->
    <div id="logoutModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeLogoutModal()">&times;</span>
            <h3>Are you sure you want to logout?</h3>
            <div class="modal-actions">
                <button class="confirm" onclick="confirmLogout()">Yes</button>
                <button class="cancel" onclick="closeLogoutModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Toggle sidebar on mobile
        function toggleMenu() {
            document.querySelector('.sidebar').classList.toggle('active');
        }

        // Toggle profile dropdown
        function toggleProfileDropdown() {
            document.getElementById('profileDropdown').classList.toggle('active');
        }

        // Toggle notifications (placeholder for future feature)
        function toggleNotifications() {
            alert('Notification feature will be implemented soon!');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function (event) {
            const profileContainer = document.querySelector('.profile-container');
            const profileDropdown = document.getElementById('profileDropdown');

            if (!profileContainer.contains(event.target)) {
                profileDropdown.classList.remove('active');
            }
        });

        // Update greeting and time
        function updateGreetingAndTime() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');

            // Set greeting based on time of day
            let greeting;
            if (hours < 12) {
                greeting = "Good Morning";
            } else if (hours < 18) {
                greeting = "Good Afternoon";
            } else {
                greeting = "Good Evening";
            }

            // Format date
            const options = { weekday: 'long', year: 'numeric', month: 'short', day: 'numeric' };
            const dateString = now.toLocaleDateString('en-US', options);

            // Format time with AM/PM
            const ampm = hours >= 12 ? 'PM' : 'AM';
            const formattedHours = hours % 12 || 12;
            const timeString = `${formattedHours}:${minutes}:${seconds} ${ampm}`;

            // Update DOM elements
            const greetingText = document.getElementById('greetingText');
            const currentDate = document.getElementById('currentDate');
            const currentTime = document.getElementById('currentTime');

            if (greetingText) greetingText.textContent = greeting;
            if (currentDate) currentDate.textContent = dateString;
            if (currentTime) currentTime.textContent = timeString;
        }

        // Update time every second
        setInterval(updateGreetingAndTime, 1000);
        updateGreetingAndTime(); // Initial call

        let allActivities = [];
        let viewedAnnouncements = JSON.parse(localStorage.getItem('viewedAnnouncements')) || [];

        async function authFetch(url, options = {}) {
            const response = await fetch(url, {
                ...options,
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            });
            if (response.status === 401) {
                window.location.href = "/";
                return null;
            }
            return response;
        }

        async function fetchResidentData() {
            try {
                const [profileResponse, requestsResponse, announcementsResponse, blotterResponse] = await Promise.all([
                    authFetch('/api/auth/profile'),
                    authFetch('/api/requests/user'),
                    authFetch('/api/announcements/user'),
                    authFetch('/api/blotter/user')
                ]);

                if (!profileResponse || !requestsResponse || !announcementsResponse || !blotterResponse) {
                    return;
                }

                const profileData = profileResponse.ok ? await profileResponse.json() : null;
                const requests = requestsResponse.ok ? await requestsResponse.json() : [];
                const announcements = announcementsResponse.ok ? await announcementsResponse.json() : [];
                let blotterCases = [];

                if (blotterResponse.ok) {
                    try {
                        blotterCases = await blotterResponse.json();
                        if (!Array.isArray(blotterCases)) {
                            console.error('Blotter data is not an array:', blotterCases);
                            blotterCases = [];
                        }
                    } catch (e) {
                        console.error('Error parsing blotter response:', e);
                        blotterCases = [];
                    }
                }

                if (profileData) {
                    const profilePic = document.getElementById('profilePicture');
                    if (profileData.profilePicture) {
                        if (profileData.profilePicture.startsWith('http') || profileData.profilePicture.startsWith('/')) {
                            profilePic.src = profileData.profilePicture;
                        } else {
                            profilePic.src = '/uploads/' + profileData.profilePicture;
                        }
                    } else {
                        profilePic.src = 'images/profile.jpg';
                    }
                }

                const pendingRequests = requests.filter(r => r.status === "Pending").length;
                document.getElementById('pendingRequests').textContent = `${pendingRequests} Pending`;

                const recentAnnouncements = announcements.filter(a =>
                    new Date(a.createdAt) > new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)
                );
                const unviewedAnnouncements = recentAnnouncements.filter(a =>
                    !viewedAnnouncements.includes(a._id)
                );
                document.getElementById('newAnnouncements').textContent = `${unviewedAnnouncements.length} Announcement${unviewedAnnouncements.length !== 1 ? 's' : ''}`;

                const activeBlotterCases = Array.isArray(blotterCases) ?
                    blotterCases.filter(b =>
                        b.status === "Pending" || b.status === "Under Investigation"
                    ).length : 0;

                document.getElementById('blotterCases').textContent = `${activeBlotterCases} Blotter Case${activeBlotterCases !== 1 ? 's' : ''}`;

                // Update recent activity (show only 3 most recent)
                updateRecentActivity(requests, blotterCases);

            } catch (error) {
                console.error('Fetch error:', error);
                document.getElementById('blotterCases').textContent = '0 Blotter Cases';
            }
        }

        function updateRecentActivity(requests, blotterCases) {
            const activityTable = document.getElementById('recentActivity');
            if (!activityTable) return;

            // Combine activities
            allActivities = [];

            // Add requests
            requests.forEach(request => {
                allActivities.push({
                    type: 'Request',
                    description: `Request for ${request.documentType || 'Document'}`,
                    date: new Date(request.createdAt || request.date).toLocaleDateString(),
                    status: request.status,
                    id: request._id
                });
            });

            // Add blotter cases
            if (Array.isArray(blotterCases)) {
                blotterCases.forEach(blotter => {
                    allActivities.push({
                        type: 'Blotter',
                        description: `Blotter Case: ${blotter.incidentType || 'Incident Report'}`,
                        date: new Date(blotter.createdAt || blotter.date).toLocaleDateString(),
                        status: blotter.status,
                        id: blotter._id
                    });
                });
            }

            // Sort by date (newest first) and take only 3
            allActivities.sort((a, b) => new Date(b.date) - new Date(a.date));
            const displayActivities = allActivities.slice(0, 3);

            // Clear table
            activityTable.innerHTML = '';

            if (displayActivities.length === 0) {
                activityTable.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">No recent activity</td></tr>';
                return;
            }

            // Add activities to table
            displayActivities.forEach(activity => {
                const row = document.createElement('tr');

                // Status badge
                let statusClass = 'status-pending';
                if (activity.status === 'Under Investigation') statusClass = 'status-under-investigation';
                else if (activity.status === 'Resolved') statusClass = 'status-resolved';
                else if (activity.status === 'Dismissed') statusClass = 'status-dismissed';

                row.innerHTML = `
                    <td>${activity.type}</td>
                    <td>${activity.description}</td>
                    <td>${activity.date}</td>
                    <td><span class="status ${statusClass}">${activity.status}</span></td>
                    <td>
                        <button class="view-button" onclick="viewActivity('${activity.type}', '${activity.id}')">
                            View
                        </button>
                    </td>
                `;

                activityTable.appendChild(row);
            });
        }

        function viewActivity(type, id) {
            if (type === 'Request') {
                window.location.href = `/residentRequests#${id}`;
            } else if (type === 'Blotter') {
                window.location.href = `/resident-blotter#${id}`;
            }
        }

        // Modal System for Resident Dashboard
        const residentModal = {
            show: function (type, title, message, buttons = []) {
                // Close any existing modal first
                this.hideAll();

                const modalOverlay = document.createElement('div');
                modalOverlay.className = `modal-overlay ${type}-modal`;
                modalOverlay.id = 'residentModalOverlay';
                modalOverlay.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>${title}</h2>
                            <button class="modal-close" onclick="residentModal.hide(this)">&times;</button>
                        </div>
                        <div class="modal-body">
                            ${message}
                        </div>
                        ${buttons.length > 0 ? `
                        <div class="modal-footer">
                            ${buttons.map(btn => `
                                <button class="btn ${btn.class || 'btn-primary'}" onclick="${btn.onclick}">
                                    ${btn.text}
                                </button>
                            `).join('')}
                        </div>
                        ` : ''}
                    </div>
                `;

                document.body.appendChild(modalOverlay);
                modalOverlay.style.display = 'flex';

                modalOverlay.addEventListener('click', function (e) {
                    if (e.target === modalOverlay) {
                        residentModal.hide(this);
                    }
                });

                return modalOverlay;
            },

            hide: function (element) {
                const modal = element.closest('.modal-overlay') || element;
                if (modal) {
                    modal.style.animation = 'modalSlideOut 0.3s ease-out';
                    setTimeout(() => {
                        if (modal.parentNode) {
                            modal.parentNode.removeChild(modal);
                        }
                    }, 300);
                }
            },

            hideAll: function () {
                const modals = document.querySelectorAll('.modal-overlay');
                modals.forEach(modal => this.hide(modal));
            },

            success: function (message, title = 'Success') {
                return this.show('success', title, `<p>${message}</p>`, [
                    { text: 'OK', class: 'btn-success', onclick: 'residentModal.hide(this)' }
                ]);
            },

            error: function (message, title = 'Error') {
                return this.show('error', title, `<p>${message}</p>`, [
                    { text: 'OK', class: 'btn-danger', onclick: 'residentModal.hide(this)' }
                ]);
            },

            info: function (message, title = 'Information') {
                return this.show('info', title, `<p>${message}</p>`, [
                    { text: 'OK', class: 'btn-primary', onclick: 'residentModal.hide(this)' }
                ]);
            }
        };

        // Enhanced emergency modal
        function openEmergencyModal() {
            residentModal.show('emergency', 'ðŸš¨ Send Emergency Alert', `
                <div style="margin-bottom: 15px;">
                    <p style="color: #e74c3c; font-weight: 500; margin-bottom: 10px;">
                        <i class="fas fa-exclamation-triangle"></i> 
                        This will notify barangay admin immediately.
                    </p>
                    <label for="emergencyMessageInput" style="display: block; margin-bottom: 8px; font-weight: 500;">
                        Describe your emergency:
                    </label>
                    <textarea 
                        id="emergencyMessageInput" 
                        style="width: 100%; height: 120px; padding: 12px; border: 1px solid #ddd; border-radius: 8px; resize: vertical; font-family: inherit;"
                        placeholder="Please describe your emergency situation in detail...&#10;Example: Medical emergency, fire, security threat, etc."
                    ></textarea>
                    <p style="font-size: 12px; color: #666; margin-top: 5px;">
                        <i class="fas fa-info-circle"></i>
                        Admin will respond within 1 minute. If no response, your emergency will be sent to baragay email.
                    </p>
                </div>
            `, [
                {
                    text: 'Cancel',
                    class: 'btn-secondary',
                    onclick: 'residentModal.hide(this)'
                },
                {
                    text: 'Send Emergency Alert',
                    class: 'btn-danger',
                    onclick: 'sendEmergencyAlertFromModal()'
                }
            ]);
        }

        // Enhanced send emergency alert with modal feedback
        async function sendEmergencyAlertFromModal() {
            const messageInput = document.getElementById('emergencyMessageInput');
            const message = messageInput ? messageInput.value.trim() : '';

            if (!message) {
                residentModal.error('Please describe your emergency situation before sending the alert.');
                return;
            }

            try {
                const userEmail = localStorage.getItem('userEmail');
                const response = await authFetch('/api/emergency/send', {
                    method: 'POST',
                    body: JSON.stringify({ email: userEmail, message })
                });

                if (!response) return;

                const data = await response.json();
                if (response.ok) {
                    residentModal.success(
                        'Emergency alert sent successfully! Barangay officials have been notified and will respond within 1 minute.',
                        'Alert Sent Successfully'
                    );
                    // Don't hide the modal immediately, let the user see the success message
                } else {
                    throw new Error(data.error || 'Failed to send emergency alert');
                }
            } catch (error) {
                console.error('Error:', error);
                residentModal.error('Failed to send emergency alert: ' + error.message);
            }
        }

        // Enhanced notification for emergency responses
        function showEmergencyResponseNotification(message) {
            residentModal.info(
                `Admin Response: ${message}`,
                'ðŸš¨ Emergency Response Received'
            );

            // Also show the existing notification
            if (Notification.permission === "granted") {
                new Notification("Emergency Response", {
                    body: `Admin response: ${message}`
                });
            }
        }

        // ========== UPDATED LOGOUT FUNCTIONALITY ==========
        // Logout functionality
        async function logout() {
            try {
                const response = await fetch('/api/auth/logout', {
                    method: 'POST'
                });

                if (response && response.ok) {
                    localStorage.removeItem('userEmail');
                    localStorage.removeItem('userId');
                    window.location.href = '/';
                }
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        function openLogoutModal() {
            document.getElementById('logoutModal').style.display = 'block';
        }

        function closeLogoutModal() {
            document.getElementById('logoutModal').style.display = 'none';
        }

        function confirmLogout() {
            closeLogoutModal();
            logout();
        }

        // Sidebar logout functionality
        function setupSidebarLogout() {
            const sidebarLogoutBtn = document.getElementById('sidebarLogoutBtn');
            if (sidebarLogoutBtn) {
                sidebarLogoutBtn.addEventListener('click', function (e) {
                    e.preventDefault();
                    openLogoutModal();
                });
            }
        }

        // Close modals when clicking outside
        window.addEventListener('click', function (event) {
            const logoutModal = document.getElementById('logoutModal');

            if (event.target === logoutModal) {
                closeLogoutModal();
            }
        });

        // Set up logout button
        document.getElementById('logoutBtn').addEventListener('click', function (e) {
            e.preventDefault();
            openLogoutModal();
        });
        // ========== END UPDATED LOGOUT FUNCTIONALITY ==========

        const socket = io({ withCredentials: true });

        if (Notification.permission !== "granted") {
            Notification.requestPermission();
        }

        socket.on('request-updated', (request) => {
            if (request.userId === localStorage.getItem('userId')) {
                showNotification(`Your request status updated to ${request.status}`);
                fetchResidentData();
            }
        });

        socket.on('new_announcement', (announcement) => {
            showNotification(`New announcement: ${announcement.title}`);
            fetchResidentData();
        });

        socket.on('emergencyResponse', (response) => {
            if (response.residentId === localStorage.getItem('userId')) {
                showEmergencyResponseNotification(response.message);
            }
        });

        socket.on('blotter-updated', (blotter) => {
            if (blotter.complainant === localStorage.getItem('userId')) {
                showNotification(`Your blotter report status updated to ${blotter.status}`);
                fetchResidentData();
            }
        });

        function showNotification(message) {
            if (Notification.permission === "granted") {
                new Notification("BTMS Notification", { body: message });
            } else {
                // Fallback to modal notification
                residentModal.info(message, 'Notification');
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            // Initialize greeting and time
            updateGreetingAndTime();

            // Setup sidebar logout
            setupSidebarLogout();

            authFetch('/api/auth/check-auth')
                .then(response => {
                    if (!response) return;
                    return response.json();
                })
                .then(data => {
                    if (!data || !data.isAuthenticated) {
                        window.location.href = '/';
                    } else {
                        localStorage.setItem('userId', data.user.id);
                        fetchResidentData();
                    }
                })
                .catch(error => {
                    console.error('Auth check error:', error);
                    window.location.href = '/';
                });

            // Remove the duplicate logout button event listener since we're using setupSidebarLogout
            // The setupSidebarLogout function already handles the sidebar logout button
        });

        setInterval(fetchResidentData, 30000);
    </script>
</body>

</html>