<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/png" href="images/barangay-bg.png">
    <title>Document Requests - Barangay Talipapa</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        
        :root {
            --primary: #0d4f8b;
            --secondary: #e6a919;
            --light: #f8f9fa;
            --dark: #343a40;
            --success: #28a745;
            --danger: #e74c3c;
            --warning: #ffa000;
            --info: #17a2b8;
            --sidebar-width: 250px;
            --header-height: 70px;
        }
        
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        body { 
            font-family: 'Poppins', sans-serif; 
            background: linear-gradient(135deg, #e6f2ff 0%, #f0f8ff 100%);
            background-attachment: fixed;
            color: #333;
            overflow-x: hidden;
        }

        /* Sidebar Styles */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            width: var(--sidebar-width);
            background: linear-gradient(180deg, #0F172A 0%, #1E3A8A 100%);
            color: #F8FAFC;
            box-shadow: 2px 0 12px rgba(0, 0, 0, 0.15);
            overflow-y: auto;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .sidebar a {
            display: flex;
            align-items: center;
            color: #E2E8F0;
            padding: 12px 18px;
            margin: 6px 12px;
            border-radius: 10px;
            transition: 0.3s ease;
            position: relative;
            text-decoration: none;
        }

        .sidebar a:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            transform: translateX(4px);
        }

        .sidebar a i {
            margin-right: 12px;
            transition: all 0.3s ease;
        }

        .sidebar a:hover i {
            color: #60A5FA;
            transform: translateX(4px);
            text-shadow: 0 0 10px #60A5FA;
        }

        .logo-name {
            display: flex;
            align-items: center;
            padding: 20px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo-image img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 10px;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .logo_name {
            font-size: 18px;
            font-weight: 600;
        }

        .menu-items {
            padding: 15px 0;
        }

        .nav-links {
            list-style: none;
        }

        .nav-links li {
            margin-bottom: 5px;
        }

        .nav-links a {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }

        .nav-links a:hover,
        .nav-links a.active {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            border-left-color: var(--secondary);
        }

        .nav-links i {
            font-size: 18px;
            margin-right: 12px;
            width: 20px;
            text-align: center;
        }

        .link-name {
            font-size: 14px;
            font-weight: 500;
        }

        .logout-section {
            padding: 15px 0;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Main Content */
        .main-content {
            margin-left: var(--sidebar-width);
            padding: 20px;
            min-height: 100vh;
            transition: all 0.3s ease;
        }

        .top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        .sidebar-toggle {
            font-size: 24px;
            cursor: pointer;
            color: var(--primary);
            display: none;
        }

        /* Dashboard Content */
        .dash-content {
            margin-top: 10px;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .page-title {
            font-size: 24px;
            font-weight: 600;
            color: #333;
        }

        /* Archive controls */
        .archive-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px 20px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .archive-toggle {
            display: flex;
            gap: 10px;
        }

        .archive-toggle button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .active-archive {
            background-color: var(--primary);
            color: white;
        }

        .inactive-archive {
            background-color: #e9ecef;
            color: #495057;
        }

        .automation-btn, .export-btn, .cleanup-btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .automation-btn:hover, .export-btn:hover {
            background-color: #1c6ea4;
            transform: translateY(-2px);
        }

        .cleanup-btn {
            background-color: var(--warning);
        }

        .cleanup-btn:hover {
            background-color: #e69500;
            transform: translateY(-2px);
        }

        /* Filter Controls */
        .filter-controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 150px;
        }

        .filter-group label {
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 14px;
        }

        .filter-group select, .filter-group input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: white;
        }

        .filter-button {
            padding: 8px 15px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
            margin-top: 20px;
        }

        .filter-button:hover {
            background-color: #1c6ea4;
        }

        /* Selected Request Actions */
        .selected-request-actions {
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            display: none;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
        }

        .selected-request-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-profile {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary);
        }

        .selected-request-details h3 {
            margin: 0;
            font-size: 18px;
            color: var(--dark);
        }

        .selected-request-details p {
            margin: 0;
            font-size: 14px;
            color: #666;
        }

        .selected-request-buttons {
            display: flex;
            gap: 10px;
        }

        /* Table Styles */
        .table-container {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 14px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        tr:hover {
            background-color: #f1f1f1;
        }

        tr.selected {
            background-color: #e6f7ff;
            border-left: 4px solid var(--primary);
        }

        .checkbox-cell {
            text-align: center;
            width: 40px;
        }

        .checkbox-cell input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .user-profile-cell {
            width: 50px;
        }

        .user-profile-small {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 1px solid #ddd;
        }

        .status {
            padding: 0.4rem 0.8rem;
            border-radius: 2rem;
            font-size: 0.8rem;
            font-weight: 500;
            display: inline-block;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-approved {
            background: #d4edda;
            color: #155724;
        }

        .status-rejected {
            background: #f8d7da;
            color: #721c24;
        }

        .status-ready-to-claim {
            background: #cce5ff;
            color: #004085;
        }

        .status-scheduled {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-claimed {
            background: #e2e3e5;
            color: #383d41;
        }

        .status-processing {
            background: #fff3cd;
            color: #856404;
        }

        .status-archived {
            background: #e2e3e5;
            color: #383d41;
        }

        .status-expired {
            background: #f8d7da;
            color: #721c24;
        }

        /* Priority Indicators */
        .priority-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .priority-high { background-color: #e74c3c; }
        .priority-medium { background-color: #f39c12; }
        .priority-low { background-color: #27ae60; }

        /* NEW: Pickup Period Badge */
        .pickup-period-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: #e6f7ff;
            color: #0050b3;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            margin-left: 5px;
        }

        /* Button Styles */
        .action-button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 5px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .approve-btn {
            background-color: var(--success);
            color: white;
        }

        .approve-btn:hover {
            background-color: #218838;
        }

        .reject-btn {
            background-color: var(--danger);
            color: white;
        }

        .reject-btn:hover {
            background-color: #c82333;
        }

        .ready-btn {
            background-color: var(--info);
            color: white;
        }

        .ready-btn:hover {
            background-color: #138496;
        }

        .claim-btn {
            background-color: var(--primary);
            color: white;
        }

        .claim-btn:hover {
            background-color: #1c6ea4;
        }

        .process-btn {
            background-color: var(--warning);
            color: white;
        }

        .process-btn:hover {
            background-color: #e69500;
        }

        /* NEW: Set Period Button */
        .set-period-btn {
            background-color: #17a2b8;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .set-period-btn:hover {
            background-color: #138496;
            transform: translateY(-1px);
        }

        /* Export Button */
        .export-btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .export-btn:hover {
            background-color: #1c6ea4;
            transform: translateY(-2px);
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background-color: var(--success);
            color: white;
            border-radius: 5px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 1000;
            display: none;
            animation: slideIn 0.5s forwards;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .notification.hide {
            animation: slideOut 0.5s forwards;
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* Error message styling */
        .error-message {
            text-align: center;
            color: var(--danger);
            padding: 20px;
            font-weight: 500;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .modal-content h2 {
            margin-bottom: 15px;
            color: var(--dark);
        }

        .modal-content textarea {
            width: 100%;
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-height: 100px;
            font-family: 'Poppins', sans-serif;
        }

        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 15px;
        }

        .modal-buttons button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .modal-cancel {
            background: #ccc;
            color: #333;
        }

        .modal-cancel:hover {
            background: #b3b3b3;
        }

        .modal-submit {
            background: var(--danger);
            color: white;
        }

        .modal-submit:hover {
            background: #c82333;
        }

        /* NEW: Set Pickup Period Modal */
        .pickup-period-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .period-notes {
            margin-top: 10px;
        }

        .period-notes textarea {
            min-height: 80px;
            resize: vertical;
        }

        /* Logout Modal */
        #logoutModal .modal-content {
            max-width: 350px;
            text-align: center;
        }

        #logoutModal .modal-content h3 {
            margin-bottom: 20px;
            font-size: 18px;
            color: var(--dark);
        }

        #logoutModal .modal-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        #logoutModal .modal-actions button {
            flex: 1;
            padding: 10px;
            font-size: 14px;
            border-radius: 6px;
            cursor: pointer;
            border: none;
            transition: all 0.3s ease;
        }

        #logoutModal .confirm {
            background: linear-gradient(135deg, var(--danger) 0%, #c0392b 100%);
            color: #fff;
        }

        #logoutModal .cancel {
            background-color: #ddd;
            color: #333;
        }

        #logoutModal .confirm:hover, #logoutModal .cancel:hover {
            transform: translateY(-2px);
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .filter-controls {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .filter-group {
                width: 100%;
            }

            .selected-request-actions {
                flex-direction: column;
                align-items: flex-start;
            }

            .selected-request-buttons {
                width: 100%;
                justify-content: flex-start;
                margin-top: 10px;
            }

            .pickup-period-group {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                left: -100%;
                width: 280px;
                border-radius: 0 20px 20px 0;
            }
            
            .sidebar.active {
                left: 0;
            }
            
            .main-content {
                margin-left: 0;
                padding: 15px;
            }
            
            .sidebar-toggle {
                display: block;
            }
            
            .top {
                padding: 12px 15px;
            }
            
            .archive-controls {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .filter-controls {
                padding: 15px;
            }
            
            table {
                display: block;
                overflow-x: auto;
            }

            .selected-request-info {
                flex-direction: column;
                align-items: flex-start;
            }
        }

        @media (max-width: 576px) {
            .main-content {
                padding: 10px;
            }
            
            .top {
                padding: 10px 12px;
            }
            
            .table-container {
                padding: 15px;
            }
            
            th, td {
                padding: 8px 10px;
                font-size: 13px;
            }
            
            .archive-toggle {
                flex-direction: column;
                width: 100%;
            }
            
            .archive-toggle button {
                width: 100%;
            }

            .selected-request-buttons {
                flex-direction: column;
            }

            .selected-request-buttons button {
                width: 100%;
            }

            .action-button, .set-period-btn {
                width: 100%;
                margin: 2px 0;
                justify-content: center;
            }
        }
    </style>
    
    <!-- Load socket.io client -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <!-- Load jsPDF library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="logo-name">
            <div class="logo-image">
                <img src="images/barangay-bg.png" alt="BTMS Logo">
            </div>
            <span class="logo_name">Admin Panel</span>
        </div>
        
        <div class="menu-items">
            <ul class="nav-links">
                <li><a href="/admin-dashboard" class="active">
                    <i class="fas fa-home"></i>
                    <span class="link-name">Dashboard</span>
                </a></li>
                <li><a href="/manage-residents">
                    <i class="fas fa-users"></i>
                    <span class="link-name">Manage Residents</span>
                </a></li>
                <li><a href="/adminRequests">
                    <i class="fas fa-file-alt"></i>
                    <span class="link-name">Document Requests</span>
                </a></li>
                <li><a href="/admin-blotter">
                    <i class="fas fa-shield-alt"></i>
                    <span class="link-name">Blotter Reports</span>
                </a></li>
                <li><a href="/adminAnnounce">
                    <i class="fas fa-bell"></i>
                    <span class="link-name">Announcement</span>
                </a></li>
                <li><a href="/admin-approvals">
                    <i class="fas fa-user-check"></i>
                    <span class="link-name">Approval</span>
                </a></li>
                <li><a href="/emergency">
                    <i class="fas fa-bell"></i>
                    <span class="link-name">Emergency Alerts</span>
                </a></li>
                <li><a href="/admin-messages">
                    <i class="fas fa-envelope"></i>
                    <span class="link-name">Resident Messages</span>
                </a></li>
            </ul>
            
            <!-- Logout Section -->
            <div class="logout-section">
                <a href="#" id="sidebarLogoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                    <span class="link-name">Logout</span>
                </a>
            </div>
        </div>
        
        <!-- Greeting and Time Section -->
        <div class="greeting-section">
            <div class="greeting" id="greetingText">Welcome Admin</div>
            <div class="current-date" id="currentDate"></div>
            <div class="current-time" id="currentTime"></div>
        </div>
    </nav>

    <!-- Main Content -->
    <section class="main-content">
        <div class="top">
            <i class="fas fa-bars sidebar-toggle" onclick="toggleMenu()"></i>
            <div class="header">
                <h1><i class="fas fa-file-alt"></i> Document Requests</h1>
            </div>
        </div>

        <div class="dash-content">
            <div class="page-header">
                <div>
                </div>
            </div>
            
            <!-- Archive Toggle -->
            <div class="archive-controls">
                <div class="archive-toggle">
                    <button id="activeRequestsBtn" class="active-archive">Active Requests</button>
                    <button id="archivedRequestsBtn" class="inactive-archive">Archive</button>
                </div>
                <div>
                    <button id="exportPDF" class="export-btn" style="display: none;">
                        <i class="fas fa-file-pdf"></i> Export to PDF
                    </button>
                    <button id="cleanupArchive" class="cleanup-btn" style="display: none;">
                        <i class="fas fa-broom"></i> Cleanup Archive
                    </button>
                </div>
            </div>
            
            <!-- Filter Controls -->
            <div class="filter-controls">
                <div class="filter-group">
                    <label for="searchInput">Search:</label>
                    <input type="text" id="searchInput" placeholder="Search by name or address">
                </div>
                
                <div class="filter-group">
                    <label for="statusFilter">Status:</label>
                    <select id="statusFilter">
                        <option value="">All Statuses</option>
                        <option value="Pending">Pending</option>
                        <option value="Approved">Approved</option>
                        <option value="Rejected">Rejected</option>
                        <option value="Processing">Processing</option>
                        <option value="Ready to Claim">Ready to Claim</option>
                        <option value="Scheduled for Pickup">Scheduled for Pickup</option>
                        <option value="Claimed">Claimed</option>
                        <option value="Archived">Archived</option>
                        <option value="Expired">Expired</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="documentTypeFilter">Document Type:</label>
                    <select id="documentTypeFilter">
                        <option value="">All Types</option>
                        <option value="Barangay Clearance">Barangay Clearance</option>
                        <option value="Business Permit">Business Permit</option>
                        <option value="Certificate of Residency">Certificate of Residency</option>
                        <option value="Certificate of Indigency">Certificate of Indigency</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="priorityFilter">Priority:</label>
                    <select id="priorityFilter">
                        <option value="">All Priorities</option>
                        <option value="high">High (8-10)</option>
                        <option value="medium">Medium (4-7)</option>
                        <option value="low">Low (1-3)</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="startDate">From:</label>
                    <input type="date" id="startDate">
                </div>
                
                <div class="filter-group">
                    <label for="endDate">To:</label>
                    <input type="date" id="endDate">
                </div>
                
                <button id="applyFilters" class="filter-button">
                    <i class="fas fa-filter"></i> Apply Filters
                </button>
                <button id="resetFilters" class="filter-button">
                    <i class="fas fa-redo"></i> Reset
                </button>
            </div>
            
            <!-- Selected Request Actions -->
            <div class="selected-request-actions" id="selectedRequestActions">
                <div class="selected-request-info">
                    <img src="/images/default-profile.png" alt="User Profile" class="user-profile" id="selectedUserProfile">
                    <div class="selected-request-details">
                        <h3 id="selectedUserName">Selected Requests (<span id="selectedCount">0</span>)</h3>
                        <p id="selectedRequestDetails">Select requests to perform actions</p>
                    </div>
                </div>
                <div class="selected-request-buttons">
                    <button class="action-button approve-btn" id="selectedApproveBtn">Approve</button>
                    <button class="action-button reject-btn" id="selectedRejectBtn">Reject</button>
                    <button class="action-button process-btn" id="selectedProcessBtn">Mark as Processing</button>
                    <button class="action-button set-period-btn" id="selectedSetPeriodBtn">
                        <i class="fas fa-calendar-alt"></i> Set Pickup Period
                    </button>
                    <button class="action-button claim-btn" id="selectedClaimBtn" style="display: none;">Mark as Claimed</button>
                </div>
            </div>
            
            <div class="table-container">
                <table id="requestsTable">
                    <thead>
                        <tr>
                            <th class="checkbox-cell">
                                <input type="checkbox" id="selectAllCheckbox">
                            </th>
                            <th class="user-profile-cell">Profile</th>
                            <th>Full Name</th>
                            <th>Address</th>
                            <th>Document Type</th>
                            <th>Purpose</th>
                            <th>Date Requested</th>
                            <th>Status</th>
                            <th>Priority</th>
                            <th>Pickup Period</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data will be dynamically inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Rejection Reason Modal -->
    <div id="rejectModal" class="modal">
        <div class="modal-content">
            <h2>Reject Request</h2>
            <p>Please provide a reason for rejection:</p>
            <textarea id="rejectionReason" placeholder="Enter the reason for rejecting this request..."></textarea>
            <div class="modal-buttons">
                <button class="modal-cancel" onclick="document.getElementById('rejectModal').style.display = 'none'">Cancel</button>
                <button class="modal-submit" onclick="submitRejection()">Submit Rejection</button>
            </div>
        </div>
    </div>

    <!-- NEW: Set Pickup Period Modal -->
    <div id="setPickupPeriodModal" class="modal">
        <div class="modal-content">
            <h2><i class="fas fa-calendar-alt"></i> Set Pickup Period</h2>
            <p>Set the time period when the resident can choose their pickup slot:</p>
            
            <div class="pickup-period-group">
                <div class="filter-group">
                    <label for="periodStartDate">Start Date:</label>
                    <input type="date" id="periodStartDate" required>
                </div>
                <div class="filter-group">
                    <label for="periodEndDate">End Date:</label>
                    <input type="date" id="periodEndDate" required>
                </div>
            </div>
            
            <div class="period-notes">
                <label for="periodNotes">Additional Notes (Optional):</label>
                <textarea id="periodNotes" placeholder="Any special instructions for the resident..."></textarea>
            </div>
            
            <div class="modal-buttons">
                <button class="modal-cancel" onclick="document.getElementById('setPickupPeriodModal').style.display = 'none'">Cancel</button>
                <button class="modal-submit" onclick="submitPickupPeriod()">Set Pickup Period</button>
            </div>
        </div>
    </div>

    <!-- Bulk Rejection Reason Modal -->
    <div id="bulkRejectModal" class="modal">
        <div class="modal-content">
            <h2>Reject Selected Requests</h2>
            <p>Please provide a reason for rejection:</p>
            <textarea id="bulkRejectionReason" placeholder="Enter the reason for rejecting these requests..."></textarea>
            <div class="modal-buttons">
                <button class="modal-cancel" onclick="document.getElementById('bulkRejectModal').style.display = 'none'">Cancel</button>
                <button class="modal-submit" onclick="submitBulkRejection()">Submit Rejection</button>
            </div>
        </div>
    </div>

    <!-- NEW: Bulk Set Pickup Period Modal -->
    <div id="bulkSetPeriodModal" class="modal">
        <div class="modal-content">
            <h2><i class="fas fa-calendar-alt"></i> Set Pickup Period for Selected Requests</h2>
            <p>Set the time period when residents can choose their pickup slots:</p>
            
            <div class="pickup-period-group">
                <div class="filter-group">
                    <label for="bulkPeriodStartDate">Start Date:</label>
                    <input type="date" id="bulkPeriodStartDate" required>
                </div>
                <div class="filter-group">
                    <label for="bulkPeriodEndDate">End Date:</label>
                    <input type="date" id="bulkPeriodEndDate" required>
                </div>
            </div>
            
            <div class="period-notes">
                <label for="bulkPeriodNotes">Additional Notes (Optional):</label>
                <textarea id="bulkPeriodNotes" placeholder="Any special instructions for residents..."></textarea>
            </div>
            
            <div class="modal-buttons">
                <button class="modal-cancel" onclick="document.getElementById('bulkSetPeriodModal').style.display = 'none'">Cancel</button>
                <button class="modal-submit" onclick="submitBulkPickupPeriod()">Set Pickup Period</button>
            </div>
        </div>
    </div>

    <!-- Logout Confirmation Modal -->
    <div id="logoutModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeLogoutModal()">&times;</span>
            <h3>Are you sure you want to logout?</h3>
            <div class="modal-actions">
                <button class="confirm" onclick="confirmLogout()">Yes</button>
                <button class="cancel" onclick="closeLogoutModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Real-time Notification -->
    <div id="notification" class="notification"></div>

    <script>
    const socket = io();
    
    const requestsTable = document.getElementById('requestsTable');
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');
    const documentTypeFilter = document.getElementById('documentTypeFilter');
    const priorityFilter = document.getElementById('priorityFilter');
    const startDate = document.getElementById('startDate');
    const endDate = document.getElementById('endDate');
    const applyFilters = document.getElementById('applyFilters');
    const resetFilters = document.getElementById('resetFilters');
    const notification = document.getElementById('notification');
    const activeRequestsBtn = document.getElementById('activeRequestsBtn');
    const archivedRequestsBtn = document.getElementById('archivedRequestsBtn');
    const cleanupArchive = document.getElementById('cleanupArchive');
    const sidebarLogoutBtn = document.getElementById('sidebarLogoutBtn');
    const selectedRequestActions = document.getElementById('selectedRequestActions');
    const selectedUserProfile = document.getElementById('selectedUserProfile');
    const selectedUserName = document.getElementById('selectedUserName');
    const selectedRequestDetails = document.getElementById('selectedRequestDetails');
    const selectedCount = document.getElementById('selectedCount');
    const selectedApproveBtn = document.getElementById('selectedApproveBtn');
    const selectedRejectBtn = document.getElementById('selectedRejectBtn');
    const selectedProcessBtn = document.getElementById('selectedProcessBtn');
    const selectedSetPeriodBtn = document.getElementById('selectedSetPeriodBtn');
    const selectedClaimBtn = document.getElementById('selectedClaimBtn');
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    const exportPDF = document.getElementById('exportPDF');

    let currentFilters = {
        search: '',
        status: '',
        documentType: '',
        priority: '',
        startDate: '',
        endDate: '',
        archive: false
    };

    let currentRejectRequestId = null;
    let currentSetPeriodRequestId = null;
    let selectedRequestIds = new Set();
    let allRequests = [];

    document.addEventListener('DOMContentLoaded', () => {
        checkAuthStatus();
        setupEventListeners();
        setupWebSocketListeners();
        fetchRequests();
    });

    function checkAuthStatus() {
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/admin-login.html';
            return;
        }
    }

    function setupEventListeners() {
        applyFilters.addEventListener('click', applyFiltersHandler);
        resetFilters.addEventListener('click', resetFiltersHandler);
        searchInput.addEventListener('input', debounce(applyFiltersHandler, 300));

        activeRequestsBtn.addEventListener('click', () => {
            currentFilters.archive = false;
            updateArchiveUI();
            fetchRequests();
            clearSelection();
        });

        archivedRequestsBtn.addEventListener('click', () => {
            currentFilters.archive = true;
            updateArchiveUI();
            fetchRequests();
            clearSelection();
        });

        cleanupArchive.addEventListener('click', cleanupArchiveHandler);
        sidebarLogoutBtn.addEventListener('click', openLogoutModal);
        exportPDF.addEventListener('click', exportRequestsToPDF);
        
        selectedApproveBtn.addEventListener('click', () => {
            if (selectedRequestIds.size > 0) {
                handleBulkAction('approve');
            }
        });
        
        selectedRejectBtn.addEventListener('click', () => {
            if (selectedRequestIds.size > 0) {
                handleBulkAction('reject');
            }
        });

        selectedProcessBtn.addEventListener('click', () => {
            if (selectedRequestIds.size > 0) {
                handleBulkAction('process');
            }
        });
        
        selectedSetPeriodBtn.addEventListener('click', () => {
            if (selectedRequestIds.size > 0) {
                openBulkSetPeriodModal();
            }
        });

        selectedClaimBtn.addEventListener('click', () => {
            if (selectedRequestIds.size > 0) {
                handleBulkAction('claim');
            }
        });
        
        selectAllCheckbox.addEventListener('change', toggleSelectAll);

        // Set minimum dates for period inputs
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('periodStartDate').min = today;
        document.getElementById('periodEndDate').min = today;
        document.getElementById('bulkPeriodStartDate').min = today;
        document.getElementById('bulkPeriodEndDate').min = today;
    }

    function updateArchiveUI() {
        const isArchive = currentFilters.archive;
        activeRequestsBtn.classList.toggle('active-archive', !isArchive);
        activeRequestsBtn.classList.toggle('inactive-archive', isArchive);
        archivedRequestsBtn.classList.toggle('active-archive', isArchive);
        archivedRequestsBtn.classList.toggle('inactive-archive', !isArchive);
        
        // Show/hide cleanup button and export PDF button based on archive mode
        cleanupArchive.style.display = isArchive ? 'flex' : 'none';
        exportPDF.style.display = isArchive ? 'flex' : 'none';
        
        // Hide action buttons in archive mode
        if (isArchive) {
            hideSelectedRequestActions();
        }
    }

    async function cleanupArchiveHandler() {
        if (!confirm('WARNING: This will permanently delete ALL archived requests. Continue?')) {
            return;
        }

        try {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/admin-login.html';
                return;
            }

            const response = await fetch('/api/requests/cleanup', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Failed to clean up archive');
            }

            const result = await response.json();
            showNotification(`Successfully deleted ${result.deletedCount} archived requests`);
            if (currentFilters.archive) fetchRequests();
        } catch (error) {
            console.error('Cleanup error:', error);
            showNotification(`Error: ${error.message}`);
        }
    }

    function debounce(func, timeout = 300) {
        let timer;
        return (...args) => {
            clearTimeout(timer);
            timer = setTimeout(() => { func.apply(this, args); }, timeout);
        };
    }

    function setupWebSocketListeners() {
        socket.on('request-update', (data) => {
            let message = '';
            switch (data.type) {
                case 'created':
                    message = `New request from ${data.request.fullName}`;
                    break;
                case 'updated':
                    message = `Request from ${data.request.fullName} was ${data.request.status}`;
                    break;
                case 'deleted':
                    message = `Cleaned up ${data.count} archived requests`;
                    break;
            }
            showNotification(message);
            if (!currentFilters.archive) fetchRequests();
        });

        // NEW: Handle admin notifications
        socket.on('admin-notification', (data) => {
            showNotification(data.message);
            fetchRequests(); // Refresh to show updated status
        });
    }

    function showNotification(message) {
        notification.textContent = message;
        notification.style.display = 'block';

        setTimeout(() => {
            notification.classList.add('hide');
            setTimeout(() => {
                notification.style.display = 'none';
                notification.classList.remove('hide');
            }, 500);
        }, 3000);
    }

    function applyFiltersHandler() {
        currentFilters = {
            ...currentFilters,
            search: searchInput.value.trim(),
            status: statusFilter.value,
            documentType: documentTypeFilter.value,
            priority: priorityFilter.value,
            startDate: startDate.value,
            endDate: endDate.value
        };
        fetchRequests();
        clearSelection();
    }

    function resetFiltersHandler() {
        searchInput.value = '';
        statusFilter.value = '';
        documentTypeFilter.value = '';
        priorityFilter.value = '';
        startDate.value = '';
        endDate.value = '';
        currentFilters = {
            ...currentFilters,
            search: '',
            status: '',
            documentType: '',
            priority: '',
            startDate: '',
            endDate: ''
        };
        fetchRequests();
        clearSelection();
    }

    // Add authFetch function for consistent authentication
    async function authFetch(url, options = {}) {
        const response = await fetch(url, {
            ...options,
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json',
                ...options.headers
            }
        });
        if (response.status === 401) {
            window.location.href = "/admin-login.html";
            return null;
        }
        return response;
    }

    async function fetchRequests() {
        try {
            const queryParams = new URLSearchParams();

            if (currentFilters.search) queryParams.append('search', currentFilters.search);
            if (currentFilters.status) queryParams.append('status', currentFilters.status);
            if (currentFilters.documentType) queryParams.append('documentType', currentFilters.documentType);
            if (currentFilters.startDate) queryParams.append('startDate', currentFilters.startDate);
            if (currentFilters.endDate) queryParams.append('endDate', currentFilters.endDate);
            queryParams.append('archive', currentFilters.archive);
            queryParams.append('priority', 'true'); // Always sort by priority

            const response = await authFetch(`/api/requests?${queryParams.toString()}`);
            
            if (!response) return;

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || `Error: ${response.status}`);
            }

            const requests = await response.json();
            allRequests = requests;
            
            // Apply client-side filtering for priority
            let filteredRequests = requests;
            
            if (currentFilters.priority) {
                filteredRequests = filteredRequests.filter(request => {
                    const score = request.priorityScore || 0;
                    switch (currentFilters.priority) {
                        case 'high': return score >= 8;
                        case 'medium': return score >= 4 && score < 8;
                        case 'low': return score < 4;
                        default: return true;
                    }
                });
            }
            
            renderRequests(filteredRequests);
        } catch (error) {
            console.error('Fetch error:', error);
            showErrorInTable(error.message);
        }
    }

    function renderRequests(requests) {
        const tbody = requestsTable.querySelector('tbody');
        tbody.innerHTML = '';

        if (requests.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="11" class="error-message">
                        No ${currentFilters.archive ? 'archived' : 'active'} requests found
                    </td>
                </tr>
            `;
            return;
        }

        requests.forEach(request => {
            const row = document.createElement('tr');
            row.setAttribute('data-id', request.id);
            
            // Use the populated userProfile data from the backend
            const userProfile = request.userProfile || {
                profilePicture: '/images/default-profile.png',
                fullName: request.fullName || 'Unknown User'
            };
            
            const isSelected = selectedRequestIds.has(request.id);
            if (isSelected) {
                row.classList.add('selected');
            }

            const statusClass = `status-${request.status.toLowerCase().replace(/\s+/g, '-')}`;
            
            // Determine priority indicator
            let priorityClass = '';
            let priorityText = '';
            const priorityScore = request.priorityScore || 0;
            if (priorityScore >= 8) {
                priorityClass = 'priority-high';
                priorityText = 'High';
            } else if (priorityScore >= 4) {
                priorityClass = 'priority-medium';
                priorityText = 'Medium';
            } else {
                priorityClass = 'priority-low';
                priorityText = 'Low';
            }

            // NEW: Pickup period display
            let pickupPeriodHTML = 'Not set';
            if (request.hasAdminPickupPeriod) {
                pickupPeriodHTML = `
                    ${request.formattedAdminPickupPeriod}
                    <span class="pickup-period-badge">
                        <i class="fas fa-calendar-check"></i> Set
                    </span>
                `;
            }

            row.innerHTML = `
                <td class="checkbox-cell">
                    <input type="checkbox" class="request-checkbox" data-id="${request.id}" ${isSelected ? 'checked' : ''}>
                </td>
                <td class="user-profile-cell">
                    <img src="${userProfile.profilePicture}" alt="User Profile" class="user-profile-small" 
                         onerror="this.src='/images/default-profile.png'">
                </td>
                <td>${userProfile.fullName}</td>
                <td>${request.address || 'N/A'}</td>
                <td>${request.documentType || 'N/A'}</td>
                <td>${request.purpose || 'N/A'}</td>
                <td class="date-cell">
                    <div>${request.formattedDate || 'N/A'}</div>
                    <div style="font-size: 0.8em; color: #666;">${request.formattedTime || ''}</div>
                </td>
                <td><span class="status ${statusClass}">${request.status || 'Pending'}</span></td>
                <td>
                    <span class="priority-indicator ${priorityClass}"></span>
                    ${priorityText}
                    ${priorityScore ? `<div style="font-size: 0.7em; color: #666;">(${priorityScore})</div>` : ''}
                </td>
                <td>${pickupPeriodHTML}</td>
                <td class="actions-cell">
                    ${renderActionButtons(request)}
                </td>
            `;

            tbody.appendChild(row);
        });

        // Add event listeners to checkboxes
        document.querySelectorAll('.request-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', (e) => {
                const requestId = e.target.getAttribute('data-id');
                const row = e.target.closest('tr');
                
                if (e.target.checked) {
                    selectedRequestIds.add(requestId);
                    row.classList.add('selected');
                } else {
                    selectedRequestIds.delete(requestId);
                    row.classList.remove('selected');
                    selectAllCheckbox.checked = false;
                }
                
                updateSelectedRequestActions();
            });
        });
        
        // Update select all checkbox state
        updateSelectAllCheckbox();
    }

    // NEW: Render action buttons based on request status - UPDATED WITH EXPIRED STATUS
    function renderActionButtons(request) {
        let buttons = '';
        
        switch (request.status) {
            case 'Pending':
                buttons = `
                    <button class="action-button approve-btn" onclick="performSingleAction('${request.id}', 'approve')">Approve</button>
                    <button class="action-button reject-btn" onclick="openRejectModal('${request.id}')">Reject</button>
                `;
                break;
                
            case 'Approved':
                buttons = `
                    <button class="action-button process-btn" onclick="performSingleAction('${request.id}', 'process')">Processing</button>
                `;
                break;
                
            case 'Processing':
                buttons = `
                    <button class="set-period-btn" onclick="openSetPeriodModal('${request.id}')">
                        <i class="fas fa-calendar-alt"></i> Set Pickup Period
                    </button>
                `;
                break;
                
            case 'Ready to Claim':
                if (request.hasAdminPickupPeriod) {
                    buttons = `
                        <span style="color: #28a745; font-weight: 500;">Pickup Period Set</span>
                        <button class="action-button claim-btn" onclick="performSingleAction('${request.id}', 'claim')">Claimed</button>
                    `;
                } else {
                    buttons = `
                        <button class="set-period-btn" onclick="openSetPeriodModal('${request.id}')">
                            <i class="fas fa-calendar-alt"></i> Set Pickup Period
                        </button>
                    `;
                }
                break;
                
            case 'Scheduled for Pickup':
                buttons = `
                    <button class="action-button claim-btn" onclick="performSingleAction('${request.id}', 'claim')">Mark as Claimed</button>
                `;
                break;
                
            case 'Rejected':
                buttons = `<span style="color: #666;">Rejected</span>`;
                break;
                
            case 'Expired':
                buttons = `<span class="status status-expired">Expired</span>`;
                break;
                
            default:
                buttons = `<span style="color: #666;">No actions</span>`;
        }
        
        return buttons;
    }
    
    function toggleSelectAll() {
        const checkboxes = document.querySelectorAll('.request-checkbox');
        const isChecked = selectAllCheckbox.checked;
        
        checkboxes.forEach(checkbox => {
            checkbox.checked = isChecked;
            const requestId = checkbox.getAttribute('data-id');
            const row = checkbox.closest('tr');
            
            if (isChecked) {
                selectedRequestIds.add(requestId);
                row.classList.add('selected');
            } else {
                selectedRequestIds.delete(requestId);
                row.classList.remove('selected');
            }
        });
        
        updateSelectedRequestActions();
    }
    
    function updateSelectAllCheckbox() {
        const checkboxes = document.querySelectorAll('.request-checkbox');
        if (checkboxes.length === 0) {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.disabled = true;
        } else {
            selectAllCheckbox.disabled = false;
            const allChecked = checkboxes.length === selectedRequestIds.size;
            selectAllCheckbox.checked = allChecked;
        }
    }
    
    function updateSelectedRequestActions() {
        const selectedCountValue = selectedRequestIds.size;
        selectedCount.textContent = selectedCountValue;
        
        if (selectedCountValue === 0) {
            hideSelectedRequestActions();
            return;
        }
        
        if (currentFilters.archive) {
            hideSelectedRequestActions();
            return;
        }
        
        // Show appropriate buttons based on selected requests
        const selectedRequests = allRequests.filter(req => selectedRequestIds.has(req.id));
        const hasPending = selectedRequests.some(req => req.status === 'Pending');
        const hasApproved = selectedRequests.some(req => req.status === 'Approved');
        const hasProcessing = selectedRequests.some(req => req.status === 'Processing');
        const hasReady = selectedRequests.some(req => req.status === 'Ready to Claim');
        const hasScheduled = selectedRequests.some(req => req.status === 'Scheduled for Pickup');
        
        selectedApproveBtn.style.display = hasPending ? 'inline-block' : 'none';
        selectedRejectBtn.style.display = hasPending ? 'inline-block' : 'none';
        selectedProcessBtn.style.display = hasApproved ? 'inline-block' : 'none';
        selectedSetPeriodBtn.style.display = (hasProcessing || hasReady) ? 'inline-block' : 'none';
        selectedClaimBtn.style.display = hasScheduled ? 'inline-block' : 'none';
        
        // Update user profile if only one request is selected
        if (selectedCountValue === 1) {
            const requestId = Array.from(selectedRequestIds)[0];
            const request = allRequests.find(req => req.id === requestId);
            if (request) {
                const userProfile = request.userProfile || {
                    profilePicture: '/images/default-profile.png',
                    fullName: request.fullName || 'Unknown User'
                };
                selectedUserProfile.src = userProfile.profilePicture;
                selectedUserName.textContent = userProfile.fullName;
                selectedRequestDetails.textContent = `${request.documentType} • ${request.purpose} • ${request.formattedDate}`;
            }
        } else {
            selectedUserProfile.src = '/images/default-profile.png';
            selectedUserName.textContent = `Selected Requests (${selectedCountValue})`;
            selectedRequestDetails.textContent = `${selectedCountValue} requests selected for actions`;
        }
        
        selectedRequestActions.style.display = 'flex';
    }

    function hideSelectedRequestActions() {
        selectedRequestActions.style.display = 'none';
        selectedRequestIds.clear();
        
        // Remove selected class from all rows
        document.querySelectorAll('#requestsTable tbody tr').forEach(row => {
            row.classList.remove('selected');
        });
        
        // Uncheck all checkboxes
        document.querySelectorAll('.request-checkbox').forEach(checkbox => {
            checkbox.checked = false;
        });
        
        selectAllCheckbox.checked = false;
    }
    
    function clearSelection() {
        selectedRequestIds.clear();
        updateSelectedRequestActions();
    }

    // NEW: Open set pickup period modal for single request
    function openSetPeriodModal(requestId) {
        currentSetPeriodRequestId = requestId;
        document.getElementById('setPickupPeriodModal').style.display = 'flex';
        
        // Reset form
        document.getElementById('periodStartDate').value = '';
        document.getElementById('periodEndDate').value = '';
        document.getElementById('periodNotes').value = '';
    }

    // NEW: Open bulk set pickup period modal
    function openBulkSetPeriodModal() {
        document.getElementById('bulkSetPeriodModal').style.display = 'flex';
        
        // Reset form
        document.getElementById('bulkPeriodStartDate').value = '';
        document.getElementById('bulkPeriodEndDate').value = '';
        document.getElementById('bulkPeriodNotes').value = '';
    }

    function openRejectModal(requestId) {
        currentRejectRequestId = requestId;
        document.getElementById('rejectModal').style.display = 'flex';
        document.getElementById('rejectionReason').value = '';
    }

    function handleBulkAction(action) {
        let requestIds = Array.from(selectedRequestIds);
            
        if (requestIds.length === 0) {
            showNotification('No requests selected for this action');
            return;
        }
        
        if (action === 'reject') {
            // For selected requests reject, show modal
            currentRejectRequestId = 'bulk'; // Special value for bulk rejection
            document.getElementById('rejectModal').style.display = 'flex';
            document.getElementById('rejectionReason').value = '';
            return;
        }
        
        if (!confirm(`Are you sure you want to ${action} ${requestIds.length} request(s)?`)) return;
        
        performBulkAction(requestIds, action);
    }

    function submitRejection() {
        const reason = document.getElementById('rejectionReason').value.trim();
        if (!reason) {
            alert('Please provide a rejection reason');
            return;
        }
        
        document.getElementById('rejectModal').style.display = 'none';
        
        if (currentRejectRequestId === 'bulk') {
            // Bulk rejection of selected requests
            performBulkAction(Array.from(selectedRequestIds), 'reject', reason);
        } else {
            // Single request rejection
            performSingleAction(currentRejectRequestId, 'reject', reason);
        }
    }

    // NEW: Submit pickup period for single request
    function submitPickupPeriod() {
        const startDate = document.getElementById('periodStartDate').value;
        const endDate = document.getElementById('periodEndDate').value;
        const notes = document.getElementById('periodNotes').value.trim();
        
        if (!startDate || !endDate) {
            alert('Please provide both start and end dates');
            return;
        }
        
        if (new Date(startDate) >= new Date(endDate)) {
            alert('End date must be after start date');
            return;
        }
        
        document.getElementById('setPickupPeriodModal').style.display = 'none';
        performSetPickupPeriod(currentSetPeriodRequestId, startDate, endDate, notes);
    }

    // NEW: Submit bulk pickup period
    function submitBulkPickupPeriod() {
        const startDate = document.getElementById('bulkPeriodStartDate').value;
        const endDate = document.getElementById('bulkPeriodEndDate').value;
        const notes = document.getElementById('bulkPeriodNotes').value.trim();
        
        if (!startDate || !endDate) {
            alert('Please provide both start and end dates');
            return;
        }
        
        if (new Date(startDate) >= new Date(endDate)) {
            alert('End date must be after start date');
            return;
        }
        
        document.getElementById('bulkSetPeriodModal').style.display = 'none';
        performBulkSetPickupPeriod(Array.from(selectedRequestIds), startDate, endDate, notes);
    }
    
    function submitBulkRejection() {
        const reason = document.getElementById('bulkRejectionReason').value.trim();
        if (!reason) {
            alert('Please provide a rejection reason');
            return;
        }
        
        document.getElementById('bulkRejectModal').style.display = 'none';
        
        // Get all requests that can be rejected (Pending status)
        const requestIds = allRequests.filter(req => 
            !currentFilters.archive && req.status === 'Pending').map(req => req.id);
            
        performBulkAction(requestIds, 'reject', reason);
    }

    // NEW: Perform set pickup period for single request
    async function performSetPickupPeriod(requestId, startDate, endDate, notes) {
        try {
            const response = await authFetch(`/api/requests/${requestId}/set-pickup-period`, {
                method: 'PUT',
                body: JSON.stringify({
                    startDate: startDate,
                    endDate: endDate,
                    notes: notes
                })
            });

            if (!response) return;

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Failed to set pickup period');
            }

            const result = await response.json();
            showNotification(result.message || "Pickup period set successfully!");
            fetchRequests();
            clearSelection();
        } catch (error) {
            console.error('Set pickup period error:', error);
            showNotification(`Error: ${error.message}`);
        }
    }

    // NEW: Perform bulk set pickup period
    async function performBulkSetPickupPeriod(requestIds, startDate, endDate, notes) {
        try {
            // For bulk operations, we need to call the API for each request
            const promises = requestIds.map(requestId => 
                authFetch(`/api/requests/${requestId}/set-pickup-period`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        startDate: startDate,
                        endDate: endDate,
                        notes: notes
                    })
                })
            );

            const results = await Promise.allSettled(promises);
            const successful = results.filter(result => result.status === 'fulfilled' && result.value?.ok).length;
            
            showNotification(`Successfully set pickup period for ${successful} request(s)`);
            fetchRequests();
            clearSelection();
        } catch (error) {
            console.error('Bulk set pickup period error:', error);
            showNotification(`Error: ${error.message}`);
        }
    }

    async function performBulkAction(requestIds, action, rejectionReason = '') {
        try {
            const response = await authFetch('/api/requests/bulk-action', {
                method: 'POST',
                body: JSON.stringify({
                    requestIds,
                    action,
                    rejectionReason
                })
            });

            if (!response) return;

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || `Failed to ${action} requests`);
            }

            const result = await response.json();
            showNotification(`Successfully ${action === 'ready' ? 'marked as ready to claim' : action === 'claim' ? 'marked as claimed' : action === 'process' ? 'marked as processing' : action + 'd'} ${result.processedCount} request(s)`);
            fetchRequests();
            clearSelection();
        } catch (error) {
            console.error(`${action} error:`, error);
            showNotification(`Error: ${error.message}`);
        }
    }
    
    async function performSingleAction(requestId, action, rejectionReason = '') {
        try {
            let url = `/api/requests/${requestId}`;
            
            switch (action) {
                case 'approve':
                    url += '/approve';
                    break;
                case 'reject':
                    url += '/reject';
                    break;
                case 'process':
                    url += '/process';
                    break;
                case 'claim':
                    url += '/claim';
                    break;
                default:
                    throw new Error('Invalid action');
            }

            const options = {
                method: 'PUT',
                body: JSON.stringify({ rejectionReason })
            };

            const response = await authFetch(url, options);

            if (!response) return;

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || `Failed to ${action}`);
            }

            showNotification(`Request ${action === 'ready' ? 'marked as ready to claim' : action === 'claim' ? 'marked as claimed' : action === 'process' ? 'marked as processing' : action + 'd'} successfully`);
            fetchRequests();
            clearSelection();
        } catch (error) {
            console.error(`${action} error:`, error);
            showNotification(`Error: ${error.message}`);
        }
    }

    function showErrorInTable(message) {
        const tbody = requestsTable.querySelector('tbody');
        tbody.innerHTML = `
            <tr>
                <td colspan="11" class="error-message">
                    ${message}
                </td>
            </tr>
        `;
    }

    // PDF Export Function
    function exportRequestsToPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Load and add barangay logo
        const logo = new Image();
        logo.src = '/images/barangay-bg.png';
        
        logo.onload = function() {
            // Add barangay logo (top left)
            doc.addImage(logo, 'PNG', 15, 10, 25, 25);

            // Add title
            doc.setFontSize(20);
            doc.setTextColor(13, 79, 139);
            doc.text('DOCUMENT REQUESTS REPORT', 105, 25, { align: 'center' });

            // Add date and filter info
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 105, 35, { align: 'center' });
            
            // Add filter information if any filters are applied
            let filterInfo = 'All Requests';
            if (currentFilters.archive) {
                filterInfo = 'Archived Requests';
            } else {
                filterInfo = 'Active Requests';
            }
            
            if (currentFilters.status) {
                filterInfo += ` | Status: ${currentFilters.status}`;
            }
            if (currentFilters.documentType) {
                filterInfo += ` | Document Type: ${currentFilters.documentType}`;
            }
            if (currentFilters.startDate && currentFilters.endDate) {
                filterInfo += ` | Date Range: ${currentFilters.startDate} to ${currentFilters.endDate}`;
            }
            
            doc.text(filterInfo, 105, 42, { align: 'center' });

            // Add table heading
            doc.setFontSize(14);
            doc.text('REQUEST DETAILS', 15, 55);

            // Prepare table data
            const tableData = allRequests.map(request => {
                const userProfile = request.userProfile || {
                    fullName: request.fullName || 'Unknown User'
                };

                return [
                    userProfile.fullName,
                    request.address || 'N/A',
                    request.documentType || 'N/A',
                    request.purpose || 'N/A',
                    request.formattedDate || 'N/A',
                    request.status || 'Pending',
                    request.priorityScore ? (request.priorityScore >= 8 ? 'High' : request.priorityScore >= 4 ? 'Medium' : 'Low') : 'N/A',
                    request.hasAdminPickupPeriod ? request.formattedAdminPickupPeriod : 'Not set',
                    request.scheduledClaimDate ? 
                        `${request.formattedScheduledDate} ${request.formattedScheduledTime}` : 
                        'Not scheduled'
                ];
            });

            // Add table
            doc.autoTable({
                head: [['Name', 'Address', 'Document Type', 'Purpose', 'Date Requested', 'Status', 'Priority', 'Pickup Period', 'Scheduled Pickup']],
                body: tableData,
                startY: 60,
                theme: 'grid',
                headStyles: {
                    fillColor: [13, 79, 139],
                    textColor: 255,
                    fontStyle: 'bold'
                },
                styles: {
                    fontSize: 8,
                    cellPadding: 2,
                    overflow: 'linebreak',
                    cellWidth: 'wrap'
                },
                margin: { left: 10, right: 10 },
                pageBreak: 'auto'
            });

            // Get final Y position after table
            const finalY = doc.lastAutoTable.finalY + 10;

            // Add summary statistics
            const totalRequests = allRequests.length;
            const statusCounts = {};
            const priorityCounts = { high: 0, medium: 0, low: 0 };
            const pickupPeriodSet = allRequests.filter(req => req.hasAdminPickupPeriod).length;
            
            allRequests.forEach(request => {
                const status = request.status || 'Pending';
                statusCounts[status] = (statusCounts[status] || 0) + 1;
                
                const priorityScore = request.priorityScore || 0;
                if (priorityScore >= 8) priorityCounts.high++;
                else if (priorityScore >= 4) priorityCounts.medium++;
                else priorityCounts.low++;
            });

            // Add summary section
            doc.setFontSize(12);
            doc.setTextColor(13, 79, 139);
            doc.text('SUMMARY STATISTICS', 15, finalY + 5);
            
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            let summaryY = finalY + 15;
            
            doc.text(`Total Requests: ${totalRequests}`, 15, summaryY);
            summaryY += 7;
            doc.text(`Pickup Periods Set: ${pickupPeriodSet} (${((pickupPeriodSet / totalRequests) * 100).toFixed(1)}%)`, 15, summaryY);
            summaryY += 7;
            
            // Priority distribution
            doc.text(`High Priority: ${priorityCounts.high} (${((priorityCounts.high / totalRequests) * 100).toFixed(1)}%)`, 15, summaryY);
            summaryY += 7;
            doc.text(`Medium Priority: ${priorityCounts.medium} (${((priorityCounts.medium / totalRequests) * 100).toFixed(1)}%)`, 15, summaryY);
            summaryY += 7;
            doc.text(`Low Priority: ${priorityCounts.low} (${((priorityCounts.low / totalRequests) * 100).toFixed(1)}%)`, 15, summaryY);
            summaryY += 10;
            
            // Status distribution
            Object.entries(statusCounts).forEach(([status, count]) => {
                doc.text(`${status}: ${count} (${((count / totalRequests) * 100).toFixed(1)}%)`, 15, summaryY);
                summaryY += 7;
            });

            // Add footer with prepared by section
            if (summaryY < 250) {
                doc.setFontSize(10);
                doc.text('Prepared by: _________________________', 15, summaryY + 10);
                doc.text('Barangay Secretary', 15, summaryY + 20);
            } else {
                // Add new page for footer if no space
                doc.addPage();
                doc.setFontSize(10);
                doc.text('Prepared by: _________________________', 15, 20);
                doc.text('Barangay Secretary', 15, 30);
            }

            // Save the PDF
            const fileName = `document-requests-${currentFilters.archive ? 'archive' : 'active'}-${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);
        };

        // If logo fails to load, generate PDF without logo
        logo.onerror = function() {
            console.error('Failed to load logo image');
            
            // Add title
            doc.setFontSize(20);
            doc.setTextColor(13, 79, 139);
            doc.text('DOCUMENT REQUESTS REPORT', 105, 20, { align: 'center' });

            // Add date and filter info
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 105, 30, { align: 'center' });
            
            let filterInfo = 'All Requests';
            if (currentFilters.archive) {
                filterInfo = 'Archived Requests';
            } else {
                filterInfo = 'Active Requests';
            }
            
            if (currentFilters.status) {
                filterInfo += ` | Status: ${currentFilters.status}`;
            }
            if (currentFilters.documentType) {
                filterInfo += ` | Document Type: ${currentFilters.documentType}`;
            }
            
            doc.text(filterInfo, 105, 37, { align: 'center' });

            // Add table heading
            doc.setFontSize(14);
            doc.text('REQUEST DETAILS', 15, 50);

            // Prepare table data
            const tableData = allRequests.map(request => {
                const userProfile = request.userProfile || {
                    fullName: request.fullName || 'Unknown User'
                };

                return [
                    userProfile.fullName,
                    request.address || 'N/A',
                    request.documentType || 'N/A',
                    request.purpose || 'N/A',
                    request.formattedDate || 'N/A',
                    request.status || 'Pending',
                    request.priorityScore ? (request.priorityScore >= 8 ? 'High' : request.priorityScore >= 4 ? 'Medium' : 'Low') : 'N/A',
                    request.hasAdminPickupPeriod ? request.formattedAdminPickupPeriod : 'Not set',
                    request.scheduledClaimDate ? 
                        `${request.formattedScheduledDate} ${request.formattedScheduledTime}` : 
                        'Not scheduled'
                ];
            });

            // Add table
            doc.autoTable({
                head: [['Name', 'Address', 'Document Type', 'Purpose', 'Date Requested', 'Status', 'Priority', 'Pickup Period', 'Scheduled Pickup']],
                body: tableData,
                startY: 55,
                theme: 'grid',
                headStyles: {
                    fillColor: [13, 79, 139],
                    textColor: 255,
                    fontStyle: 'bold'
                },
                styles: {
                    fontSize: 8,
                    cellPadding: 2,
                    overflow: 'linebreak',
                    cellWidth: 'wrap'
                },
                margin: { left: 10, right: 10 },
                pageBreak: 'auto'
            });

            // Get final Y position after table
            const finalY = doc.lastAutoTable.finalY + 10;

            // Add summary statistics
            const totalRequests = allRequests.length;
            const statusCounts = {};
            const priorityCounts = { high: 0, medium: 0, low: 0 };
            const pickupPeriodSet = allRequests.filter(req => req.hasAdminPickupPeriod).length;
            
            allRequests.forEach(request => {
                const status = request.status || 'Pending';
                statusCounts[status] = (statusCounts[status] || 0) + 1;
                
                const priorityScore = request.priorityScore || 0;
                if (priorityScore >= 8) priorityCounts.high++;
                else if (priorityScore >= 4) priorityCounts.medium++;
                else priorityCounts.low++;
            });

            // Add summary section
            doc.setFontSize(12);
            doc.setTextColor(13, 79, 139);
            doc.text('SUMMARY STATISTICS', 15, finalY + 5);
            
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            let summaryY = finalY + 15;
            
            doc.text(`Total Requests: ${totalRequests}`, 15, summaryY);
            summaryY += 7;
            doc.text(`Pickup Periods Set: ${pickupPeriodSet} (${((pickupPeriodSet / totalRequests) * 100).toFixed(1)}%)`, 15, summaryY);
            summaryY += 7;
            
            // Priority distribution
            doc.text(`High Priority: ${priorityCounts.high} (${((priorityCounts.high / totalRequests) * 100).toFixed(1)}%)`, 15, summaryY);
            summaryY += 7;
            doc.text(`Medium Priority: ${priorityCounts.medium} (${((priorityCounts.medium / totalRequests) * 100).toFixed(1)}%)`, 15, summaryY);
            summaryY += 7;
            doc.text(`Low Priority: ${priorityCounts.low} (${((priorityCounts.low / totalRequests) * 100).toFixed(1)}%)`, 15, summaryY);
            summaryY += 10;
            
            // Status distribution
            Object.entries(statusCounts).forEach(([status, count]) => {
                doc.text(`${status}: ${count} (${((count / totalRequests) * 100).toFixed(1)}%)`, 15, summaryY);
                summaryY += 7;
            });

            // Add footer with prepared by section
            if (summaryY < 250) {
                doc.setFontSize(10);
                doc.text('Prepared by: _________________________', 15, summaryY + 10);
                doc.text('Barangay Secretary', 15, summaryY + 20);
            } else {
                // Add new page for footer if no space
                doc.addPage();
                doc.setFontSize(10);
                doc.text('Prepared by: _________________________', 15, 20);
                doc.text('Barangay Secretary', 15, 30);
            }

            // Save the PDF
            const fileName = `document-requests-${currentFilters.archive ? 'archive' : 'active'}-${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);
        };
    }

    function toggleMenu() {
        document.querySelector('.sidebar').classList.toggle('active');
    }

    // Logout functionality
    async function logout() {
        try {
            const response = await fetch('/api/auth/logout', {
                method: 'POST'
            });

            if (response && response.ok) {
                localStorage.removeItem('token');
                window.location.href = '/';
            }
        } catch (error) {
            console.error('Logout error:', error);
        }
    }

    function openLogoutModal() {
        document.getElementById('logoutModal').style.display = 'block';
    }

    function closeLogoutModal() {
        document.getElementById('logoutModal').style.display = 'none';
    }

    function confirmLogout() {
        closeLogoutModal();
        logout();
    }

    // Close modals when clicking outside
    window.addEventListener('click', function(event) {
        const logoutModal = document.getElementById('logoutModal');
        const rejectModal = document.getElementById('rejectModal');
        const bulkRejectModal = document.getElementById('bulkRejectModal');
        const setPickupPeriodModal = document.getElementById('setPickupPeriodModal');
        const bulkSetPeriodModal = document.getElementById('bulkSetPeriodModal');
        
        if (event.target === logoutModal) {
            closeLogoutModal();
        }
        if (event.target === rejectModal) {
            document.getElementById('rejectModal').style.display = 'none';
        }
        if (event.target === bulkRejectModal) {
            document.getElementById('bulkRejectModal').style.display = 'none';
        }
        if (event.target === setPickupPeriodModal) {
            document.getElementById('setPickupPeriodModal').style.display = 'none';
        }
        if (event.target === bulkSetPeriodModal) {
            document.getElementById('bulkSetPeriodModal').style.display = 'none';
        }
    });
</script>
</body>
</html>