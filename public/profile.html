<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile - Barangay Talipapa</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        
        :root {
            --primary: #0d4f8b;
            --secondary: #e6a919;
            --light: #f8f9fa;
            --dark: #343a40;
            --success: #28a745;
            --danger: #e74c3c;
            --warning: #ffa000;
            --sidebar-width: 250px;
        }
        
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        body { 
            font-family: 'Poppins', sans-serif; 
            background: linear-gradient(135deg, #e6f2ff 0%, #f0f8ff 100%);
            background-attachment: fixed;
            color: #333;
            overflow-x: hidden;
        }

        /* Sidebar Styles */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            width: var(--sidebar-width);
            background: linear-gradient(180deg, #0F172A 0%, #1E3A8A 100%);
            color: #F8FAFC;
            box-shadow: 2px 0 12px rgba(0, 0, 0, 0.15);
            overflow-y: auto;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .sidebar a {
            display: flex;
            align-items: center;
            color: #E2E8F0;
            padding: 12px 18px;
            margin: 6px 12px;
            border-radius: 10px;
            transition: 0.3s ease;
            position: relative;
        }

        .sidebar a:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            transform: translateX(4px);
        }

        .sidebar a i {
            margin-right: 12px;
            transition: all 0.3s ease;
        }

        .sidebar a:hover i {
            color: #60A5FA;
            transform: translateX(4px);
            text-shadow: 0 0 10px #60A5FA;
        }

        .greeting-section {
            padding: 20px 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: auto;
        }

        .greeting {
            font-size: 16px;
            color: #E2E8F0;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .current-date {
            font-size: 14px;
            color: #94A3B8;
            margin-bottom: 3px;
        }

        .current-time {
            font-size: 14px;
            color: #94A3B8;
            font-weight: 500;
        }

        .logo-name {
            display: flex;
            align-items: center;
            padding: 20px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo-image img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 10px;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .logo_name {
            font-size: 18px;
            font-weight: 600;
        }

        .menu-items {
            padding: 15px 0;
            flex-grow: 1;
        }

        .nav-links {
            list-style: none;
        }

        .nav-links li {
            margin-bottom: 5px;
        }

        .nav-links a {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }

        .nav-links a:hover,
        .nav-links a.active {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            border-left-color: var(--secondary);
        }

        .nav-links i {
            font-size: 18px;
            margin-right: 12px;
            width: 20px;
            text-align: center;
        }

        .link-name {
            font-size: 14px;
            font-weight: 500;
        }

        .logout-section {
            padding: 15px 0;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Main Content */
        .main-content {
            margin-left: var(--sidebar-width);
            padding: 20px;
            min-height: 100vh;
            transition: all 0.3s ease;
        }

        /* Mobile Menu Button */
        .mobile-menu-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            font-size: 24px;
            cursor: pointer;
            color: var(--primary);
            z-index: 99;
            background: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        /* Header */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .page-title {
            color: var(--primary);
            font-size: 24px;
            font-weight: 600;
        }

        /* Profile Container */
        .profile-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 30px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .profile-header {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .profile-picture-container {
            position: relative;
            margin-right: 30px;
        }

        .profile-picture {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid var(--primary);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .profile-upload-btn {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: var(--secondary);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .profile-upload-btn:hover {
            transform: scale(1.1);
            background: #d89c17;
        }

        .profile-info-header {
            flex: 1;
        }

        .profile-name {
            font-size: 28px;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .profile-email {
            font-size: 16px;
            color: #666;
            margin-bottom: 15px;
        }

        .profile-status {
            display: inline-block;
            padding: 5px 12px;
            background-color: #e8f5e8;
            color: #2e7d32;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }

        /* Profile Form */
        .profile-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-section {
            margin-bottom: 25px;
        }

        .form-section-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #f0f0f0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            font-family: 'Poppins', sans-serif;
            transition: all 0.3s ease;
            background-color: #f9f9f9;
        }

        .form-control:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(13, 79, 139, 0.2);
            outline: none;
            background-color: white;
        }

        .readonly-field {
            background-color: #f0f0f0;
            cursor: not-allowed;
        }

        .profile-value {
            padding: 12px 15px;
            background-color: #f9f9f9;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
            min-height: 46px;
            display: flex;
            align-items: center;
        }

        .edit-field {
            display: none;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
        }

        .checkbox-item input {
            margin-right: 8px;
        }

        .radio-group {
            display: flex;
            gap: 15px;
        }

        .radio-item {
            display: flex;
            align-items: center;
        }

        .radio-item input {
            margin-right: 8px;
        }

        /* Change Password Section */
        .change-password-section {
            margin-top: 30px;
            padding: 25px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            background-color: #f9f9f9;
            position: relative;
        }

        .change-password-toggle {
            color: var(--primary);
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
        }

        .change-password-toggle:hover {
            color: #0b3d6b;
        }

        .change-password-form {
            display: none;
            margin-top: 15px;
        }

        .change-password-form.active {
            display: block;
        }

        .password-requirements {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .requirement {
            margin-bottom: 3px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .requirement.met {
            color: var(--success);
        }

        .requirement.not-met {
            color: var(--danger);
        }

        .requirement i {
            font-size: 10px;
        }

        .message {
            padding: 12px 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: none;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* Action Buttons */
        .profile-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }

        .btn {
            padding: 12px 25px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, #1c6ea4 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(13, 79, 139, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #20c997 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
        }

        .btn-secondary {
            background-color: #f8f9fa;
            color: #333;
            border: 1px solid #ddd;
        }

        .btn-secondary:hover {
            background-color: #e9ecef;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #c0392b 100%);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(231, 76, 60, 0.3);
        }

        /* Logout Modal */
        #logoutModal .modal-content {
            max-width: 350px;
            text-align: center;
        }

        #logoutModal .modal-content h3 {
            margin-bottom: 20px;
            font-size: 18px;
            color: var(--dark);
        }

        #logoutModal .modal-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        #logoutModal .modal-actions button {
            flex: 1;
            padding: 10px;
            font-size: 14px;
            border-radius: 6px;
            cursor: pointer;
            border: none;
            transition: all 0.3s ease;
        }

        #logoutModal .confirm {
            background: linear-gradient(135deg, var(--danger) 0%, #c0392b 100%);
            color: #fff;
        }

        #logoutModal .cancel {
            background-color: #ddd;
            color: #333;
        }

        #logoutModal .confirm:hover, #logoutModal .cancel:hover {
            transform: translateY(-2px);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 30px;
            border-radius: 10px;
            width: 80%;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .sidebar {
                left: -100%;
                width: 280px;
            }
            
            .sidebar.active {
                left: 0;
            }
            
            .main-content {
                margin-left: 0;
                padding: 15px;
                padding-top: 80px;
            }
            
            .mobile-menu-btn {
                display: flex;
            }
            
            .profile-container {
                padding: 20px;
            }
            
            .profile-header {
                flex-direction: column;
                text-align: center;
            }
            
            .profile-picture-container {
                margin-right: 0;
                margin-bottom: 20px;
            }
            
            .profile-form {
                grid-template-columns: 1fr;
            }
            
            .profile-actions {
                flex-direction: column;
                gap: 15px;
            }
            
            .profile-actions .btn {
                width: 100%;
                justify-content: center;
            }
        }

        @media (max-width: 576px) {
            .main-content {
                padding: 10px;
                padding-top: 70px;
            }
            
            .profile-container {
                padding: 15px;
            }
            
            .modal-content {
                width: 95%;
                margin: 20% auto;
                padding: 20px;
            }
            
            .page-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- Mobile Menu Button -->
    <div class="mobile-menu-btn" onclick="toggleMenu()">
        <i class="fas fa-bars"></i>
    </div>

    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="logo-name">
            <div class="logo-image">
                <img src="images/barangay-bg.png" alt="BTMS Logo">
            </div>
            <span class="logo_name">Brgy. Talipapa</span>
        </div>
        
        <div class="menu-items">
            <ul class="nav-links">
                <li><a href="/residentdashboard">
                    <i class="fas fa-home"></i>
                    <span class="link-name">Dashboard</span>
                </a></li>
            
                <li><a href="/requests">
                    <i class="fas fa-file-alt"></i>
                    <span class="link-name">Request Document</span>
                </a></li>
            
                <li><a href="/blotter">
                    <i class="fas fa-shield-alt"></i>
                    <span class="link-name">Blotter</span>
                </a></li>
            
                <li><a href="/announcement">
                    <i class="fas fa-bell"></i>
                    <span class="link-name">Announcements</span>
                </a></li>
            
                <li><a href="/profile" class="active">
                    <i class="fas fa-user"></i>
                    <span class="link-name">Profile</span>
                </a></li>
            </ul>
            
            <!-- Logout Section -->
            <div class="logout-section">
                <a href="#" id="sidebarLogoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                    <span class="link-name">Logout</span>
                </a>
            </div>
        </div>
        
        <!-- Greeting and Time Section - MOVED TO BOTTOM -->
        <div class="greeting-section">
            <div class="greeting" id="greetingText">Good Morning</div>
            <div class="current-date" id="currentDate">Thursday, Jul 09, 2020</div>
            <div class="current-time" id="currentTime">07:08:09 AM</div>
        </div>
    </nav>
    
    <!-- Main Content -->
    <section class="main-content">
        <div class="page-header">
            <h1 class="page-title">User Profile</h1>
        </div>

        <!-- Profile Container -->
        <div class="profile-container">
            <!-- Profile Header -->
            <div class="profile-header">
                <div class="profile-picture-container">
                    <img id="profilePicture" src="" alt="Profile Picture" class="profile-picture">
                    <div class="profile-upload-btn" onclick="document.getElementById('newProfilePicture').click()">
                        <i class="fas fa-camera"></i>
                    </div>
                    <input type="file" id="newProfilePicture" accept="image/*" class="d-none">
                </div>
                <div class="profile-info-header">
                    <h2 class="profile-name" id="profileNameDisplay">Loading...</h2>
                    <p class="profile-email" id="profileEmailDisplay">Loading...</p>
                    <span class="profile-status">Active Account</span>
                </div>
            </div>

            <!-- Profile Form -->
            <form id="profileForm">
                <div class="profile-form">
                    <!-- Personal Information -->
                    <div class="form-section">
                        <h3 class="form-section-title">Personal Information</h3>
                        
                        <div class="form-group">
                            <label class="form-label">Full Name</label>
                            <div class="profile-value" id="fullNameDisplay">Loading...</div>
                            <input type="text" class="form-control edit-field" id="fullName" placeholder="Enter full name">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Email Address</label>
                            <div class="profile-value" id="emailDisplay">Loading...</div>
                            <input type="email" class="form-control edit-field readonly-field" id="email" placeholder="Enter email" readonly>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Contact Number</label>
                            <div class="profile-value" id="contactNumberDisplay">Loading...</div>
                            <input type="tel" class="form-control edit-field" id="contactNumber" placeholder="Enter contact number">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Birthdate</label>
                            <div class="profile-value" id="birthdateDisplay">Loading...</div>
                            <input type="date" class="form-control edit-field" id="birthdate">
                        </div>
                    </div>

                    <!-- Additional Information -->
                    <div class="form-section">
                        <h3 class="form-section-title">Additional Information</h3>
                        
                        <div class="form-group">
                            <label class="form-label">Civil Status</label>
                            <div class="profile-value" id="civilStatusDisplay">Loading...</div>
                            <select class="form-control edit-field" id="civilStatus">
                                <option value="">Select civil status</option>
                                <option value="Single">Single</option>
                                <option value="Married">Married</option>
                                <option value="Divorced">Divorced</option>
                                <option value="Widowed">Widowed</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Occupation</label>
                            <div class="profile-value" id="occupationDisplay">Loading...</div>
                            <select class="form-control edit-field" id="occupation">
                                <option value="">Select occupation</option>
                                <option value="Student">Student</option>
                                <option value="Employed">Employed</option>
                                <option value="Unemployed">Unemployed</option>
                                <option value="Self-employed">Self-employed</option>
                                <option value="Retired">Retired</option>
                                <option value="Government Employee">Government Employee</option>
                                <option value="Private Employee">Private Employee</option>
                                <option value="Business Owner">Business Owner</option>
                                <option value="Farmer">Farmer</option>
                                <option value="Fisherman">Fisherman</option>
                                <option value="Housewife/Househusband">Housewife/Househusband</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Educational Attainment</label>
                            <div class="profile-value" id="educationalAttainmentDisplay">Loading...</div>
                            <select class="form-control edit-field" id="educationalAttainment">
                                <option value="">Select educational attainment</option>
                                <option value="Elementary Graduate">Elementary Graduate</option>
                                <option value="High School Graduate">High School Graduate</option>
                                <option value="Vocational Graduate">Vocational Graduate</option>
                                <option value="College Graduate">College Graduate</option>
                                <option value="Post Graduate">Post Graduate</option>
                                <option value="None">None</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Monthly Income</label>
                            <div class="profile-value" id="monthlyIncomeDisplay">Loading...</div>
                            <select class="form-control edit-field" id="monthlyIncome">
                                <option value="">Select monthly income</option>
                                <option value="Below 5,000">Below ₱5,000</option>
                                <option value="5,000-10,000">₱5,000 - ₱10,000</option>
                                <option value="10,001-20,000">₱10,001 - ₱20,000</option>
                                <option value="20,001-30,000">₱20,001 - ₱30,000</option>
                                <option value="30,001-50,000">₱30,001 - ₱50,000</option>
                                <option value="Above 50,000">Above ₱50,000</option>
                            </select>
                        </div>
                    </div>

                    <!-- Address Information -->
                    <div class="form-section" style="grid-column: 1 / -1;">
                        <h3 class="form-section-title">Address Information</h3>
                        
                        <div class="form-group">
                            <label class="form-label">Complete Address</label>
                            <div class="profile-value" id="addressDisplay">Loading...</div>
                            <textarea class="form-control edit-field" id="address" placeholder="Enter complete address" rows="3"></textarea>
                        </div>
                    </div>

                    <!-- Government Programs -->
                    <div class="form-section" style="grid-column: 1 / -1;">
                        <h3 class="form-section-title">Government Program Participation</h3>
                        
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="registeredVoter" name="registeredVoter">
                                <label for="registeredVoter">Registered Voter</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="fourPsMember" name="fourPsMember">
                                <label for="fourPsMember">4Ps Member</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="pwdMember" name="pwdMember">
                                <label for="pwdMember">PWD Member</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="seniorCitizen" name="seniorCitizen">
                                <label for="seniorCitizen">Senior Citizen</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="soloParent" name="soloParent">
                                <label for="soloParent">Solo Parent</label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Change Password Section -->
                <div class="change-password-section">
                    <div class="change-password-toggle" onclick="togglePasswordForm()">
                        <i class="fas fa-key"></i>
                        <span>Change Password</span>
                        <i class="fas fa-chevron-down" id="passwordToggleIcon"></i>
                    </div>
                    
                    <div class="change-password-form" id="changePasswordForm">
                        <div id="passwordMessage" class="message"></div>
                        
                        <div class="form-group">
                            <label class="form-label" for="currentPassword">Current Password</label>
                            <input type="password" id="currentPassword" name="currentPassword" class="form-control" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="newPassword">New Password</label>
                            <input type="password" id="newPassword" name="newPassword" class="form-control" required oninput="validatePassword()">
                            <div class="password-requirements">
                                <div id="reqLength" class="requirement not-met">
                                    <i class="fas fa-circle"></i> At least 8 characters
                                </div>
                                <div id="reqUppercase" class="requirement not-met">
                                    <i class="fas fa-circle"></i> At least one uppercase letter
                                </div>
                                <div id="reqSpecial" class="requirement not-met">
                                    <i class="fas fa-circle"></i> At least one special character
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="confirmPassword">Confirm New Password</label>
                            <input type="password" id="confirmPassword" name="confirmPassword" class="form-control" required oninput="checkPasswordMatch()">
                            <div id="passwordMatch" class="password-requirements"></div>
                        </div>
                        
                        <button type="button" class="btn btn-primary" onclick="handlePasswordChange()" id="changePasswordBtn">
                            <i class="fas fa-save"></i> Change Password
                        </button>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="profile-actions">
                    <button type="button" class="btn btn-primary" id="editProfileBtn">
                        <i class="fas fa-edit"></i> Edit Profile
                    </button>
                    <button type="button" class="btn btn-success" id="saveProfileBtn" style="display: none;">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                    <button type="button" class="btn btn-secondary" id="cancelEditBtn" style="display: none;">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button type="button" class="btn btn-danger" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </form>
        </div>
    </section>

    <!-- Logout Confirmation Modal -->
    <div id="logoutModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeLogoutModal()">&times;</span>
            <h3>Are you sure you want to logout?</h3>
            <div class="modal-actions">
                <button class="confirm" onclick="confirmLogout()">Yes</button>
                <button class="cancel" onclick="closeLogoutModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        let originalData = {}; // To store original values when editing
        let isPasswordFormOpen = false;

        // Toggle sidebar menu
        function toggleMenu() {
            const sidebar = document.querySelector('.sidebar');
            sidebar.classList.toggle('active');
        }

        // Close sidebar when clicking on a link (mobile)
        document.querySelectorAll('.nav-links a').forEach(link => {
            link.addEventListener('click', () => {
                if (window.innerWidth <= 768) {
                    toggleMenu();
                }
            });
        });

        // Update greeting and time
        function updateGreetingAndTime() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            
            // Set greeting based on time of day
            let greeting;
            if (hours < 12) {
                greeting = "Good Morning";
            } else if (hours < 18) {
                greeting = "Good Afternoon";
            } else {
                greeting = "Good Evening";
            }
            
            // Format date
            const options = { weekday: 'long', year: 'numeric', month: 'short', day: 'numeric' };
            const dateString = now.toLocaleDateString('en-US', options);
            
            // Format time with AM/PM
            const ampm = hours >= 12 ? 'PM' : 'AM';
            const formattedHours = hours % 12 || 12;
            const timeString = `${formattedHours}:${minutes}:${seconds} ${ampm}`;
            
            // Update DOM elements
            document.getElementById('greetingText').textContent = greeting;
            document.getElementById('currentDate').textContent = dateString;
            document.getElementById('currentTime').textContent = timeString;
        }

        // Update time every second
        setInterval(updateGreetingAndTime, 1000);
        updateGreetingAndTime(); // Initial call

        // Check authentication status when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                const response = await fetch('/api/auth/check-auth', {
                    credentials: 'include'
                });
                
                const authData = await response.json();
                
                if (!authData.isAuthenticated) {
                    window.location.href = '/login';
                    return;
                }
                
                // Fetch user profile if authenticated
                await fetchUserProfile();
                
                // Set up event listeners
                setupEventListeners();
            } catch (error) {
                console.error('Error checking auth status:', error);
                window.location.href = '/login';
            }
        });

        function setupEventListeners() {
            document.getElementById('newProfilePicture').addEventListener('change', function() {
                if (this.files[0]) {
                    updateProfilePicture();
                }
            });

            document.getElementById('editProfileBtn').addEventListener('click', function() {
                toggleEditMode(true);
            });

            document.getElementById('saveProfileBtn').addEventListener('click', function(e) {
                e.preventDefault();
                saveProfile();
            });

            document.getElementById('cancelEditBtn').addEventListener('click', function(e) {
                e.preventDefault();
                cancelEdit();
            });

            // Add logout event listener
            document.getElementById('sidebarLogoutBtn').addEventListener('click', function(e) {
                e.preventDefault();
                openLogoutModal();
            });
        }

        async function fetchUserProfile() {
            try {
                const response = await fetch('/api/auth/profile', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });

                const result = await response.json();
                
                if (response.ok) {
                    // Store the original data
                    originalData = {
                        fullName: result.fullName || '',
                        email: result.email || '',
                        contactNumber: result.contactNumber || '',
                        address: result.address || '',
                        birthdate: result.birthdate || '',
                        civilStatus: result.civilStatus || '',
                        occupation: result.occupation || '',
                        educationalAttainment: result.educationalAttainment || '',
                        monthlyIncome: result.monthlyIncome || '',
                        registeredVoter: result.registeredVoter || false,
                        fourPsMember: result.fourPsMember || false,
                        pwdMember: result.pwdMember || false,
                        seniorCitizen: result.seniorCitizen || false,
                        soloParent: result.soloParent || false
                    };

                    // Display values
                    document.getElementById('profileNameDisplay').textContent = originalData.fullName || 'Not provided';
                    document.getElementById('fullNameDisplay').textContent = originalData.fullName || 'Not provided';
                    document.getElementById('profileEmailDisplay').textContent = originalData.email || 'Not provided';
                    document.getElementById('emailDisplay').textContent = originalData.email || 'Not provided';
                    document.getElementById('contactNumberDisplay').textContent = originalData.contactNumber || 'Not provided';
                    document.getElementById('addressDisplay').textContent = originalData.address || 'Not provided';
                    document.getElementById('birthdateDisplay').textContent = originalData.birthdate ? 
                        formatDate(originalData.birthdate) : 'Not provided';
                    document.getElementById('civilStatusDisplay').textContent = originalData.civilStatus || 'Not provided';
                    document.getElementById('occupationDisplay').textContent = originalData.occupation || 'Not provided';
                    document.getElementById('educationalAttainmentDisplay').textContent = 
                        originalData.educationalAttainment || 'Not provided';
                    document.getElementById('monthlyIncomeDisplay').textContent = originalData.monthlyIncome || 'Not provided';

                    // Set form field values
                    document.getElementById('fullName').value = originalData.fullName;
                    document.getElementById('email').value = originalData.email;
                    document.getElementById('contactNumber').value = originalData.contactNumber;
                    document.getElementById('address').value = originalData.address;
                    document.getElementById('birthdate').value = originalData.birthdate ? 
                        formatDateForInput(originalData.birthdate) : '';
                    document.getElementById('civilStatus').value = originalData.civilStatus;
                    document.getElementById('occupation').value = originalData.occupation;
                    document.getElementById('educationalAttainment').value = originalData.educationalAttainment;
                    document.getElementById('monthlyIncome').value = originalData.monthlyIncome;

                    // Set checkbox values
                    document.getElementById('registeredVoter').checked = originalData.registeredVoter;
                    document.getElementById('fourPsMember').checked = originalData.fourPsMember;
                    document.getElementById('pwdMember').checked = originalData.pwdMember;
                    document.getElementById('seniorCitizen').checked = originalData.seniorCitizen;
                    document.getElementById('soloParent').checked = originalData.soloParent;

                    // Set profile picture - add timestamp to prevent caching
                    const timestamp = new Date().getTime();
                    const profilePicUrl = result.profilePictureUrl || 
                                        `images/default-profile.png?${timestamp}`;
                    document.getElementById('profilePicture').src = profilePicUrl;
                } else {
                    alert(result.error || 'Failed to fetch profile data');
                    if (response.status === 401) {
                        window.location.href = '/login';
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while fetching user profile.');
                window.location.href = '/login';
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function formatDateForInput(dateString) {
            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        async function updateProfilePicture() {
            const fileInput = document.getElementById('newProfilePicture');
            const file = fileInput.files[0];
            
            if (!file) {
                return;
            }

            if (file.size > 2 * 1024 * 1024) {
                alert('File size must be less than 2MB.');
                return;
            }

            const formData = new FormData();
            formData.append('profilePicture', file);

            try {
                const response = await fetch('/api/auth/update-profile-picture', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });

                const result = await response.json();
                if (response.ok) {
                    alert('Profile picture updated successfully!');
                    // Update the displayed image immediately
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('profilePicture').src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                    
                    // Clear the file input
                    fileInput.value = '';
                } else {
                    alert(result.error || 'Failed to update profile picture');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while updating the profile picture.');
            }
        }

        function toggleEditMode(edit) {
            const displayFields = document.querySelectorAll('.profile-value');
            const editFields = document.querySelectorAll('.edit-field');
            const editBtn = document.getElementById('editProfileBtn');
            const saveBtn = document.getElementById('saveProfileBtn');
            const cancelBtn = document.getElementById('cancelEditBtn');

            if (edit) {
                // Enter edit mode
                displayFields.forEach(field => field.style.display = 'none');
                editFields.forEach(field => field.style.display = 'block');
                editBtn.style.display = 'none';
                saveBtn.style.display = 'block';
                cancelBtn.style.display = 'block';
            } else {
                // Exit edit mode
                displayFields.forEach(field => field.style.display = 'flex');
                editFields.forEach(field => field.style.display = 'none');
                editBtn.style.display = 'block';
                saveBtn.style.display = 'none';
                cancelBtn.style.display = 'none';
            }
        }

        async function saveProfile() {
            // Prepare the update data with proper formatting
            const updatedData = {
                fullName: document.getElementById('fullName').value.trim(),
                contactNumber: document.getElementById('contactNumber').value.trim(),
                address: document.getElementById('address').value.trim(),
                birthdate: document.getElementById('birthdate').value || null,
                civilStatus: document.getElementById('civilStatus').value || null,
                occupation: document.getElementById('occupation').value.trim() || null,
                educationalAttainment: document.getElementById('educationalAttainment').value || null,
                monthlyIncome: document.getElementById('monthlyIncome').value || null,
                registeredVoter: document.getElementById('registeredVoter').checked,
                fourPsMember: document.getElementById('fourPsMember').checked,
                pwdMember: document.getElementById('pwdMember').checked,
                seniorCitizen: document.getElementById('seniorCitizen').checked,
                soloParent: document.getElementById('soloParent').checked
            };

            // Validate required fields
            if (!updatedData.fullName) {
                alert('Full name is required');
                return;
            }

            if (!updatedData.contactNumber) {
                alert('Contact number is required');
                return;
            }

            if (!updatedData.address) {
                alert('Address is required');
                return;
            }

            try {
                const response = await fetch('/api/residents/profile', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updatedData),
                    credentials: 'include'
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Error response:', errorData);
                    throw new Error(errorData.message || 'Failed to update profile');
                }

                const result = await response.json();
                alert('Profile updated successfully!');
                fetchUserProfile();
                toggleEditMode(false);
            } catch (error) {
                console.error('Error:', error);
                alert(error.message || 'An error occurred while updating the profile.');
            }
        }

        function cancelEdit() {
            // Restore original values
            document.getElementById('fullName').value = originalData.fullName;
            document.getElementById('contactNumber').value = originalData.contactNumber;
            document.getElementById('address').value = originalData.address;
            document.getElementById('birthdate').value = originalData.birthdate ? 
                formatDateForInput(originalData.birthdate) : '';
            document.getElementById('civilStatus').value = originalData.civilStatus;
            document.getElementById('occupation').value = originalData.occupation;
            document.getElementById('educationalAttainment').value = originalData.educationalAttainment;
            document.getElementById('monthlyIncome').value = originalData.monthlyIncome;

            // Restore checkbox values
            document.getElementById('registeredVoter').checked = originalData.registeredVoter;
            document.getElementById('fourPsMember').checked = originalData.fourPsMember;
            document.getElementById('pwdMember').checked = originalData.pwdMember;
            document.getElementById('seniorCitizen').checked = originalData.seniorCitizen;
            document.getElementById('soloParent').checked = originalData.soloParent;

            toggleEditMode(false);
        }

        // ==================== PASSWORD CHANGE FUNCTIONS ====================
        
        function togglePasswordForm() {
            const passwordForm = document.getElementById('changePasswordForm');
            const toggleIcon = document.getElementById('passwordToggleIcon');
            
            isPasswordFormOpen = !isPasswordFormOpen;
            
            if (isPasswordFormOpen) {
                passwordForm.classList.add('active');
                toggleIcon.classList.remove('fa-chevron-down');
                toggleIcon.classList.add('fa-chevron-up');
            } else {
                passwordForm.classList.remove('active');
                toggleIcon.classList.remove('fa-chevron-up');
                toggleIcon.classList.add('fa-chevron-down');
                // Reset form when closing
                document.getElementById('changePasswordForm').reset();
                validatePassword();
                document.getElementById('passwordMatch').textContent = '';
                document.getElementById('passwordMessage').style.display = 'none';
            }
        }

        // Password validation
        function validatePassword() {
            const password = document.getElementById('newPassword').value;
            
            const lengthReq = document.getElementById('reqLength');
            const uppercaseReq = document.getElementById('reqUppercase');
            const specialReq = document.getElementById('reqSpecial');
            
            // Check length
            if (password.length >= 8) {
                lengthReq.className = 'requirement met';
                lengthReq.innerHTML = '<i class="fas fa-check-circle"></i> At least 8 characters';
            } else {
                lengthReq.className = 'requirement not-met';
                lengthReq.innerHTML = '<i class="fas fa-circle"></i> At least 8 characters';
            }
            
            // Check uppercase
            if (/[A-Z]/.test(password)) {
                uppercaseReq.className = 'requirement met';
                uppercaseReq.innerHTML = '<i class="fas fa-check-circle"></i> At least one uppercase letter';
            } else {
                uppercaseReq.className = 'requirement not-met';
                uppercaseReq.innerHTML = '<i class="fas fa-circle"></i> At least one uppercase letter';
            }
            
            // Check special character
            if (/[!@#$%^&*(),.?":{}|<>]/.test(password)) {
                specialReq.className = 'requirement met';
                specialReq.innerHTML = '<i class="fas fa-check-circle"></i> At least one special character';
            } else {
                specialReq.className = 'requirement not-met';
                specialReq.innerHTML = '<i class="fas fa-circle"></i> At least one special character';
            }
        }

        // Check password match
        function checkPasswordMatch() {
            const password = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const matchElement = document.getElementById('passwordMatch');
            
            if (confirmPassword === '') {
                matchElement.textContent = '';
                return;
            }
            
            if (password === confirmPassword) {
                matchElement.textContent = '✓ Passwords match';
                matchElement.style.color = '#28a745';
            } else {
                matchElement.textContent = '✗ Passwords do not match';
                matchElement.style.color = '#dc3545';
            }
        }

        // Handle password change
        async function handlePasswordChange() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const messageElement = document.getElementById('passwordMessage');
            const changePasswordBtn = document.getElementById('changePasswordBtn');
            
            // Validate password requirements
            if (newPassword.length < 8 || 
                !/[A-Z]/.test(newPassword) || 
                !/[!@#$%^&*(),.?":{}|<>]/.test(newPassword)) {
                showMessage(messageElement, 'Please ensure your password meets all requirements.', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showMessage(messageElement, 'Passwords do not match.', 'error');
                return;
            }
            
            try {
                changePasswordBtn.disabled = true;
                changePasswordBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Changing...';
                
                const response = await fetch('/api/auth/change-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        currentPassword,
                        newPassword
                    }),
                    credentials: 'include'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showMessage(messageElement, 'Password changed successfully!', 'success');
                    document.getElementById('changePasswordForm').reset();
                    validatePassword();
                    document.getElementById('passwordMatch').textContent = '';
                    
                    // Close the password form after successful change
                    setTimeout(() => {
                        togglePasswordForm();
                    }, 2000);
                } else {
                    showMessage(messageElement, result.message || 'Failed to change password', 'error');
                }
            } catch (error) {
                console.error('Error changing password:', error);
                showMessage(messageElement, 'An error occurred while changing password', 'error');
            } finally {
                changePasswordBtn.disabled = false;
                changePasswordBtn.innerHTML = '<i class="fas fa-save"></i> Change Password';
            }
        }

        // Helper function to show messages
        function showMessage(element, message, type) {
            element.textContent = message;
            element.className = `message ${type}`;
            element.style.display = 'block';
            
            setTimeout(() => {
                element.style.display = 'none';
            }, 5000);
        }

        // ==================== LOGOUT FUNCTIONS ====================
        
        function openLogoutModal() {
            document.getElementById('logoutModal').style.display = 'block';
        }

        function closeLogoutModal() {
            document.getElementById('logoutModal').style.display = 'none';
        }

        function confirmLogout() {
            logout();
        }

        function logout() {
            fetch('/api/auth/logout', {
                method: 'POST',
                credentials: 'include'
            })
            .then(response => {
                if (response.ok) {
                    window.location.href = '/login';
                } else {
                    alert('Failed to logout. Please try again.');
                }
            })
            .catch(error => {
                console.error('Logout error:', error);
                alert('An error occurred during logout.');
            });
        }

        // Close logout modal when clicking outside
        window.addEventListener('click', function(event) {
            const logoutModal = document.getElementById('logoutModal');
            if (event.target === logoutModal) {
                closeLogoutModal();
            }
        });
    </script>
</body>
</html>