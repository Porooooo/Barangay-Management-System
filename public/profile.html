<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile - Barangay Talipapa</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/profile.css">
</head>
<body>
    <!-- Mobile Menu Button -->
    <div class="mobile-menu-btn" onclick="toggleMenu()">
        <i class="fas fa-bars"></i>
    </div>

    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="logo-name">
            <div class="logo-image">
                <img src="images/barangay-bg.png" alt="BTMS Logo">
            </div>
            <span class="logo_name">Brgy. Talipapa</span>
            <div class="mobile-close-btn">
                <i class="fas fa-times"></i>
            </div>
        </div>
        
        <div class="menu-items">
            <ul class="nav-links">
                <li><a href="/residentdashboard">
                    <i class="fas fa-home"></i>
                    <span class="link-name">Dashboard</span>
                </a></li>
            
                <li><a href="/requests">
                    <i class="fas fa-file-alt"></i>
                    <span class="link-name">Request Document</span>
                </a></li>
            
                <li><a href="/blotter">
                    <i class="fas fa-shield-alt"></i>
                    <span class="link-name">Blotter</span>
                </a></li>
            
                <li><a href="/announcement">
                    <i class="fas fa-bell"></i>
                    <span class="link-name">Announcements</span>
                </a></li>
            
                <li><a href="/profile" class="active">
                    <i class="fas fa-user"></i>
                    <span class="link-name">Profile</span>
                </a></li>
            </ul>
            
            <!-- Logout Section -->
            <div class="logout-section">
                <a href="#" id="sidebarLogoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                    <span class="link-name">Logout</span>
                </a>
            </div>
        </div>
        
        <!-- Greeting and Time Section - MOVED TO BOTTOM -->
        <div class="greeting-section">
            <div class="greeting" id="greetingText">Good Morning</div>
            <div class="current-date" id="currentDate">Thursday, Jul 09, 2020</div>
            <div class="current-time" id="currentTime">07:08:09 AM</div>
        </div>
    </nav>
    
    <!-- Main Content -->
    <section class="main-content">
        <div class="page-header">
            <h1 class="page-title">User Profile</h1>
        </div>

        <!-- Profile Container -->
        <div class="profile-container">
            <!-- Profile Header -->
            <div class="profile-header">
                <div class="profile-picture-container">
                    <img id="profilePicture" src="" alt="Profile Picture" class="profile-picture">
                    <div class="profile-upload-btn" onclick="document.getElementById('newProfilePicture').click()">
                        <i class="fas fa-camera"></i>
                    </div>
                    <input type="file" id="newProfilePicture" accept="image/*" class="d-none">
                </div>
                <div class="profile-info-header">
                    <h2 class="profile-name" id="profileNameDisplay">Loading...</h2>
                    <p class="profile-email" id="profileEmailDisplay">Loading...</p>
                    <span class="profile-status">Active Account</span>
                </div>
            </div>

            <!-- Profile Form -->
            <form id="profileForm">
                <div class="profile-form">
                    <!-- Personal Information -->
                    <div class="form-section">
                        <h3 class="form-section-title">Personal Information</h3>
                        
                        <div class="form-group">
                            <label class="form-label">Full Name</label>
                            <div class="profile-value" id="fullNameDisplay">Loading...</div>
                            <input type="text" class="form-control edit-field" id="fullName" placeholder="Enter full name">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Email Address</label>
                            <div class="profile-value" id="emailDisplay">Loading...</div>
                            <input type="email" class="form-control edit-field readonly-field" id="email" placeholder="Enter email" readonly>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Contact Number</label>
                            <div class="profile-value" id="contactNumberDisplay">Loading...</div>
                            <input type="tel" class="form-control edit-field" id="contactNumber" placeholder="Enter contact number">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Birthdate</label>
                            <div class="profile-value" id="birthdateDisplay">Loading...</div>
                            <input type="date" class="form-control edit-field" id="birthdate">
                        </div>
                    </div>

                    <!-- Additional Information -->
                    <div class="form-section">
                        <h3 class="form-section-title">Additional Information</h3>
                        
                        <div class="form-group">
                            <label class="form-label">Civil Status</label>
                            <div class="profile-value" id="civilStatusDisplay">Loading...</div>
                            <select class="form-control edit-field" id="civilStatus">
                                <option value="">Select civil status</option>
                                <option value="Single">Single</option>
                                <option value="Married">Married</option>
                                <option value="Divorced">Divorced</option>
                                <option value="Widowed">Widowed</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Occupation</label>
                            <div class="profile-value" id="occupationDisplay">Loading...</div>
                            <select class="form-control edit-field" id="occupation">
                                <option value="">Select occupation</option>
                                <option value="Student">Student</option>
                                <option value="Employed">Employed</option>
                                <option value="Unemployed">Unemployed</option>
                                <option value="Self-employed">Self-employed</option>
                                <option value="Retired">Retired</option>
                                <option value="Government Employee">Government Employee</option>
                                <option value="Private Employee">Private Employee</option>
                                <option value="Business Owner">Business Owner</option>
                                <option value="Farmer">Farmer</option>
                                <option value="Fisherman">Fisherman</option>
                                <option value="Housewife/Househusband">Housewife/Househusband</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Educational Attainment</label>
                            <div class="profile-value" id="educationalAttainmentDisplay">Loading...</div>
                            <select class="form-control edit-field" id="educationalAttainment">
                                <option value="">Select educational attainment</option>
                                <option value="Elementary Graduate">Elementary Graduate</option>
                                <option value="High School Graduate">High School Graduate</option>
                                <option value="Vocational Graduate">Vocational Graduate</option>
                                <option value="College Graduate">College Graduate</option>
                                <option value="Post Graduate">Post Graduate</option>
                                <option value="None">None</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Monthly Income</label>
                            <div class="profile-value" id="monthlyIncomeDisplay">Loading...</div>
                            <select class="form-control edit-field" id="monthlyIncome">
                                <option value="">Select monthly income</option>
                                <option value="Below 5,000">Below ₱5,000</option>
                                <option value="5,000-10,000">₱5,000 - ₱10,000</option>
                                <option value="10,001-20,000">₱10,001 - ₱20,000</option>
                                <option value="20,001-30,000">₱20,001 - ₱30,000</option>
                                <option value="30,001-50,000">₱30,001 - ₱50,000</option>
                                <option value="Above 50,000">Above ₱50,000</option>
                            </select>
                        </div>
                    </div>

                    <!-- Address Information -->
                    <div class="form-section" style="grid-column: 1 / -1;">
                        <h3 class="form-section-title">Address Information</h3>
                        
                        <div class="form-group">
                            <label class="form-label">Complete Address</label>
                            <div class="profile-value" id="addressDisplay">Loading...</div>
                            <textarea class="form-control edit-field" id="address" placeholder="Enter complete address" rows="3"></textarea>
                        </div>
                    </div>

                    <!-- Government Programs -->
                    <div class="form-section" style="grid-column: 1 / -1;">
                        <h3 class="form-section-title">Government Program Participation</h3>
                        
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="registeredVoter" name="registeredVoter">
                                <label for="registeredVoter">Registered Voter</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="fourPsMember" name="fourPsMember">
                                <label for="fourPsMember">4Ps Member</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="pwdMember" name="pwdMember">
                                <label for="pwdMember">PWD Member</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="seniorCitizen" name="seniorCitizen">
                                <label for="seniorCitizen">Senior Citizen</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="soloParent" name="soloParent">
                                <label for="soloParent">Solo Parent</label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Change Password Section -->
                <div class="change-password-section">
                    <div class="change-password-toggle" onclick="togglePasswordForm()">
                        <i class="fas fa-key"></i>
                        <span>Change Password</span>
                        <i class="fas fa-chevron-down" id="passwordToggleIcon"></i>
                    </div>
                    
                    <div class="change-password-form" id="changePasswordForm">
                        <div id="passwordMessage" class="message"></div>
                        
                        <div class="form-group">
                            <label class="form-label" for="currentPassword">Current Password</label>
                            <input type="password" id="currentPassword" name="currentPassword" class="form-control" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="newPassword">New Password</label>
                            <input type="password" id="newPassword" name="newPassword" class="form-control" required oninput="validatePassword()">
                            <div class="password-requirements">
                                <div id="reqLength" class="requirement not-met">
                                    <i class="fas fa-circle"></i> At least 8 characters
                                </div>
                                <div id="reqUppercase" class="requirement not-met">
                                    <i class="fas fa-circle"></i> At least one uppercase letter
                                </div>
                                <div id="reqSpecial" class="requirement not-met">
                                    <i class="fas fa-circle"></i> At least one special character
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="confirmPassword">Confirm New Password</label>
                            <input type="password" id="confirmPassword" name="confirmPassword" class="form-control" required oninput="checkPasswordMatch()">
                            <div id="passwordMatch" class="password-requirements"></div>
                        </div>
                        
                        <button type="button" class="btn btn-primary" onclick="handlePasswordChange()" id="changePasswordBtn">
                            <i class="fas fa-save"></i> Change Password
                        </button>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="profile-actions">
                    <button type="button" class="btn btn-primary" id="editProfileBtn">
                        <i class="fas fa-edit"></i> Edit Profile
                    </button>
                    <button type="button" class="btn btn-success" id="saveProfileBtn" style="display: none;">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                    <button type="button" class="btn btn-secondary" id="cancelEditBtn" style="display: none;">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button type="button" class="btn btn-danger" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </form>
        </div>
    </section>

    <!-- Logout Confirmation Modal -->
    <div id="logoutModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeLogoutModal()">&times;</span>
            <h3>Are you sure you want to logout?</h3>
            <div class="modal-actions">
                <button class="confirm" onclick="confirmLogout()">Yes</button>
                <button class="cancel" onclick="closeLogoutModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        let originalData = {}; // To store original values when editing
        let isPasswordFormOpen = false;

        // Toggle sidebar menu
        function toggleMenu() {
            const sidebar = document.querySelector('.sidebar');
            const menuBtn = document.querySelector('.mobile-menu-btn');
            sidebar.classList.toggle('active');
            
            if (sidebar.classList.contains('active')) {
                menuBtn.style.display = 'none';
            } else {
                menuBtn.style.display = 'flex';
            }
        }

        // Create and add mobile close button to sidebar
        function addMobileCloseButton() {
            const sidebar = document.querySelector('.sidebar');
            const closeBtn = document.createElement('div');
            closeBtn.className = 'mobile-close-btn';
            closeBtn.innerHTML = '<i class="fas fa-times"></i>';
            closeBtn.onclick = toggleMenu;
            
            const logoName = document.querySelector('.logo-name');
            logoName.appendChild(closeBtn);
        }

        // Close sidebar when clicking on a link (mobile)
        document.querySelectorAll('.nav-links a').forEach(link => {
            link.addEventListener('click', () => {
                if (window.innerWidth <= 768) {
                    toggleMenu();
                }
            });
        });

        // Update greeting and time
        function updateGreetingAndTime() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            
            // Set greeting based on time of day
            let greeting;
            if (hours < 12) {
                greeting = "Good Morning";
            } else if (hours < 18) {
                greeting = "Good Afternoon";
            } else {
                greeting = "Good Evening";
            }
            
            // Format date
            const options = { weekday: 'long', year: 'numeric', month: 'short', day: 'numeric' };
            const dateString = now.toLocaleDateString('en-US', options);
            
            // Format time with AM/PM
            const ampm = hours >= 12 ? 'PM' : 'AM';
            const formattedHours = hours % 12 || 12;
            const timeString = `${formattedHours}:${minutes}:${seconds} ${ampm}`;
            
            // Update DOM elements
            document.getElementById('greetingText').textContent = greeting;
            document.getElementById('currentDate').textContent = dateString;
            document.getElementById('currentTime').textContent = timeString;
        }

        // Update time every second
        setInterval(updateGreetingAndTime, 1000);
        updateGreetingAndTime(); // Initial call

        // Check authentication status when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Add mobile close button
                addMobileCloseButton();
                
                const response = await fetch('/api/auth/check-auth', {
                    credentials: 'include'
                });
                
                const authData = await response.json();
                
                if (!authData.isAuthenticated) {
                    window.location.href = '/login';
                    return;
                }
                
                // Fetch user profile if authenticated
                await fetchUserProfile();
                
                // Set up event listeners
                setupEventListeners();
                
                // Add logout event listener
                document.getElementById('sidebarLogoutBtn').addEventListener('click', function(e) {
                    e.preventDefault();
                    openLogoutModal();
                });
                
                // Close logout modal when clicking outside
                window.addEventListener('click', function(event) {
                    const logoutModal = document.getElementById('logoutModal');
                    if (event.target === logoutModal) {
                        closeLogoutModal();
                    }
                });
            } catch (error) {
                console.error('Error checking auth status:', error);
                window.location.href = '/login';
            }
        });

        function setupEventListeners() {
            document.getElementById('newProfilePicture').addEventListener('change', function() {
                if (this.files[0]) {
                    updateProfilePicture();
                }
            });

            document.getElementById('editProfileBtn').addEventListener('click', function() {
                toggleEditMode(true);
            });

            document.getElementById('saveProfileBtn').addEventListener('click', function(e) {
                e.preventDefault();
                saveProfile();
            });

            document.getElementById('cancelEditBtn').addEventListener('click', function(e) {
                e.preventDefault();
                cancelEdit();
            });
        }

        async function fetchUserProfile() {
            try {
                const response = await fetch('/api/auth/profile', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });

                const result = await response.json();
                
                if (response.ok) {
                    // Store the original data
                    originalData = {
                        fullName: result.fullName || '',
                        email: result.email || '',
                        contactNumber: result.contactNumber || '',
                        address: result.address || '',
                        birthdate: result.birthdate || '',
                        civilStatus: result.civilStatus || '',
                        occupation: result.occupation || '',
                        educationalAttainment: result.educationalAttainment || '',
                        monthlyIncome: result.monthlyIncome || '',
                        registeredVoter: result.registeredVoter || false,
                        fourPsMember: result.fourPsMember || false,
                        pwdMember: result.pwdMember || false,
                        seniorCitizen: result.seniorCitizen || false,
                        soloParent: result.soloParent || false
                    };

                    // Display values
                    document.getElementById('profileNameDisplay').textContent = originalData.fullName || 'Not provided';
                    document.getElementById('fullNameDisplay').textContent = originalData.fullName || 'Not provided';
                    document.getElementById('profileEmailDisplay').textContent = originalData.email || 'Not provided';
                    document.getElementById('emailDisplay').textContent = originalData.email || 'Not provided';
                    document.getElementById('contactNumberDisplay').textContent = originalData.contactNumber || 'Not provided';
                    document.getElementById('addressDisplay').textContent = originalData.address || 'Not provided';
                    document.getElementById('birthdateDisplay').textContent = originalData.birthdate ? 
                        formatDate(originalData.birthdate) : 'Not provided';
                    document.getElementById('civilStatusDisplay').textContent = originalData.civilStatus || 'Not provided';
                    document.getElementById('occupationDisplay').textContent = originalData.occupation || 'Not provided';
                    document.getElementById('educationalAttainmentDisplay').textContent = 
                        originalData.educationalAttainment || 'Not provided';
                    document.getElementById('monthlyIncomeDisplay').textContent = originalData.monthlyIncome || 'Not provided';

                    // Set form field values
                    document.getElementById('fullName').value = originalData.fullName;
                    document.getElementById('email').value = originalData.email;
                    document.getElementById('contactNumber').value = originalData.contactNumber;
                    document.getElementById('address').value = originalData.address;
                    document.getElementById('birthdate').value = originalData.birthdate ? 
                        formatDateForInput(originalData.birthdate) : '';
                    document.getElementById('civilStatus').value = originalData.civilStatus;
                    document.getElementById('occupation').value = originalData.occupation;
                    document.getElementById('educationalAttainment').value = originalData.educationalAttainment;
                    document.getElementById('monthlyIncome').value = originalData.monthlyIncome;

                    // Set checkbox values
                    document.getElementById('registeredVoter').checked = originalData.registeredVoter;
                    document.getElementById('fourPsMember').checked = originalData.fourPsMember;
                    document.getElementById('pwdMember').checked = originalData.pwdMember;
                    document.getElementById('seniorCitizen').checked = originalData.seniorCitizen;
                    document.getElementById('soloParent').checked = originalData.soloParent;

                    // Set profile picture - add timestamp to prevent caching
                    const timestamp = new Date().getTime();
                    const profilePicUrl = result.profilePictureUrl || 
                                        `images/default-profile.png?${timestamp}`;
                    document.getElementById('profilePicture').src = profilePicUrl;
                } else {
                    alert(result.error || 'Failed to fetch profile data');
                    if (response.status === 401) {
                        window.location.href = '/login';
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while fetching user profile.');
                window.location.href = '/login';
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function formatDateForInput(dateString) {
            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        async function updateProfilePicture() {
            const fileInput = document.getElementById('newProfilePicture');
            const file = fileInput.files[0];
            
            if (!file) {
                return;
            }

            if (file.size > 2 * 1024 * 1024) {
                alert('File size must be less than 2MB.');
                return;
            }

            const formData = new FormData();
            formData.append('profilePicture', file);

            try {
                const response = await fetch('/api/auth/update-profile-picture', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });

                const result = await response.json();
                if (response.ok) {
                    alert('Profile picture updated successfully!');
                    // Update the displayed image immediately
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('profilePicture').src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                    
                    // Clear the file input
                    fileInput.value = '';
                } else {
                    alert(result.error || 'Failed to update profile picture');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while updating the profile picture.');
            }
        }

        function toggleEditMode(edit) {
            const displayFields = document.querySelectorAll('.profile-value');
            const editFields = document.querySelectorAll('.edit-field');
            const editBtn = document.getElementById('editProfileBtn');
            const saveBtn = document.getElementById('saveProfileBtn');
            const cancelBtn = document.getElementById('cancelEditBtn');

            if (edit) {
                // Enter edit mode
                displayFields.forEach(field => field.style.display = 'none');
                editFields.forEach(field => field.style.display = 'block');
                editBtn.style.display = 'none';
                saveBtn.style.display = 'block';
                cancelBtn.style.display = 'block';
            } else {
                // Exit edit mode
                displayFields.forEach(field => field.style.display = 'flex');
                editFields.forEach(field => field.style.display = 'none');
                editBtn.style.display = 'block';
                saveBtn.style.display = 'none';
                cancelBtn.style.display = 'none';
            }
        }

        async function saveProfile() {
            // Prepare the update data with proper formatting
            const updatedData = {
                fullName: document.getElementById('fullName').value.trim(),
                contactNumber: document.getElementById('contactNumber').value.trim(),
                address: document.getElementById('address').value.trim(),
                birthdate: document.getElementById('birthdate').value || null,
                civilStatus: document.getElementById('civilStatus').value || null,
                occupation: document.getElementById('occupation').value.trim() || null,
                educationalAttainment: document.getElementById('educationalAttainment').value || null,
                monthlyIncome: document.getElementById('monthlyIncome').value || null,
                registeredVoter: document.getElementById('registeredVoter').checked,
                fourPsMember: document.getElementById('fourPsMember').checked,
                pwdMember: document.getElementById('pwdMember').checked,
                seniorCitizen: document.getElementById('seniorCitizen').checked,
                soloParent: document.getElementById('soloParent').checked
            };

            // Validate required fields
            if (!updatedData.fullName) {
                alert('Full name is required');
                return;
            }

            if (!updatedData.contactNumber) {
                alert('Contact number is required');
                return;
            }

            if (!updatedData.address) {
                alert('Address is required');
                return;
            }

            try {
                const response = await fetch('/api/residents/profile', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updatedData),
                    credentials: 'include'
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Error response:', errorData);
                    throw new Error(errorData.message || 'Failed to update profile');
                }

                const result = await response.json();
                alert('Profile updated successfully!');
                fetchUserProfile();
                toggleEditMode(false);
            } catch (error) {
                console.error('Error:', error);
                alert(error.message || 'An error occurred while updating the profile.');
            }
        }

        function cancelEdit() {
            // Restore original values
            document.getElementById('fullName').value = originalData.fullName;
            document.getElementById('contactNumber').value = originalData.contactNumber;
            document.getElementById('address').value = originalData.address;
            document.getElementById('birthdate').value = originalData.birthdate ? 
                formatDateForInput(originalData.birthdate) : '';
            document.getElementById('civilStatus').value = originalData.civilStatus;
            document.getElementById('occupation').value = originalData.occupation;
            document.getElementById('educationalAttainment').value = originalData.educationalAttainment;
            document.getElementById('monthlyIncome').value = originalData.monthlyIncome;

            // Restore checkbox values
            document.getElementById('registeredVoter').checked = originalData.registeredVoter;
            document.getElementById('fourPsMember').checked = originalData.fourPsMember;
            document.getElementById('pwdMember').checked = originalData.pwdMember;
            document.getElementById('seniorCitizen').checked = originalData.seniorCitizen;
            document.getElementById('soloParent').checked = originalData.soloParent;

            toggleEditMode(false);
        }

        // ==================== PASSWORD CHANGE FUNCTIONS ====================
        
        function togglePasswordForm() {
            const passwordForm = document.getElementById('changePasswordForm');
            const toggleIcon = document.getElementById('passwordToggleIcon');
            
            isPasswordFormOpen = !isPasswordFormOpen;
            
            if (isPasswordFormOpen) {
                passwordForm.classList.add('active');
                toggleIcon.classList.remove('fa-chevron-down');
                toggleIcon.classList.add('fa-chevron-up');
            } else {
                passwordForm.classList.remove('active');
                toggleIcon.classList.remove('fa-chevron-up');
                toggleIcon.classList.add('fa-chevron-down');
                // Reset form when closing
                document.getElementById('changePasswordForm').reset();
                validatePassword();
                document.getElementById('passwordMatch').textContent = '';
                document.getElementById('passwordMessage').style.display = 'none';
            }
        }

        // Password validation
        function validatePassword() {
            const password = document.getElementById('newPassword').value;
            
            const lengthReq = document.getElementById('reqLength');
            const uppercaseReq = document.getElementById('reqUppercase');
            const specialReq = document.getElementById('reqSpecial');
            
            // Check length
            if (password.length >= 8) {
                lengthReq.className = 'requirement met';
                lengthReq.innerHTML = '<i class="fas fa-check-circle"></i> At least 8 characters';
            } else {
                lengthReq.className = 'requirement not-met';
                lengthReq.innerHTML = '<i class="fas fa-circle"></i> At least 8 characters';
            }
            
            // Check uppercase
            if (/[A-Z]/.test(password)) {
                uppercaseReq.className = 'requirement met';
                uppercaseReq.innerHTML = '<i class="fas fa-check-circle"></i> At least one uppercase letter';
            } else {
                uppercaseReq.className = 'requirement not-met';
                uppercaseReq.innerHTML = '<i class="fas fa-circle"></i> At least one uppercase letter';
            }
            
            // Check special character
            if (/[!@#$%^&*(),.?":{}|<>]/.test(password)) {
                specialReq.className = 'requirement met';
                specialReq.innerHTML = '<i class="fas fa-check-circle"></i> At least one special character';
            } else {
                specialReq.className = 'requirement not-met';
                specialReq.innerHTML = '<i class="fas fa-circle"></i> At least one special character';
            }
        }

        // Check password match
        function checkPasswordMatch() {
            const password = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const matchElement = document.getElementById('passwordMatch');
            
            if (confirmPassword === '') {
                matchElement.textContent = '';
                return;
            }
            
            if (password === confirmPassword) {
                matchElement.textContent = '✓ Passwords match';
                matchElement.style.color = '#28a745';
            } else {
                matchElement.textContent = '✗ Passwords do not match';
                matchElement.style.color = '#dc3545';
            }
        }

        // Handle password change
        async function handlePasswordChange() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const messageElement = document.getElementById('passwordMessage');
            const changePasswordBtn = document.getElementById('changePasswordBtn');
            
            // Validate password requirements
            if (newPassword.length < 8 || 
                !/[A-Z]/.test(newPassword) || 
                !/[!@#$%^&*(),.?":{}|<>]/.test(newPassword)) {
                showMessage(messageElement, 'Please ensure your password meets all requirements.', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showMessage(messageElement, 'Passwords do not match.', 'error');
                return;
            }
            
            try {
                changePasswordBtn.disabled = true;
                changePasswordBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Changing...';
                
                const response = await fetch('/api/auth/change-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        currentPassword,
                        newPassword
                    }),
                    credentials: 'include'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showMessage(messageElement, 'Password changed successfully!', 'success');
                    document.getElementById('changePasswordForm').reset();
                    validatePassword();
                    document.getElementById('passwordMatch').textContent = '';
                    
                    // Close the password form after successful change
                    setTimeout(() => {
                        togglePasswordForm();
                    }, 2000);
                } else {
                    showMessage(messageElement, result.message || 'Failed to change password', 'error');
                }
            } catch (error) {
                console.error('Error changing password:', error);
                showMessage(messageElement, 'An error occurred while changing password', 'error');
            } finally {
                changePasswordBtn.disabled = false;
                changePasswordBtn.innerHTML = '<i class="fas fa-save"></i> Change Password';
            }
        }

        // Helper function to show messages
        function showMessage(element, message, type) {
            element.textContent = message;
            element.className = `message ${type}`;
            element.style.display = 'block';
            
            setTimeout(() => {
                element.style.display = 'none';
            }, 5000);
        }

        // ==================== LOGOUT FUNCTIONS ====================
        
        function openLogoutModal() {
            document.getElementById('logoutModal').style.display = 'block';
        }

        function closeLogoutModal() {
            document.getElementById('logoutModal').style.display = 'none';
        }

        function confirmLogout() {
            logout();
        }

        function logout() {
            fetch('/api/auth/logout', {
                method: 'POST',
                credentials: 'include'
            })
            .then(response => {
                if (response.ok) {
                    window.location.href = '/login';
                } else {
                    alert('Failed to logout. Please try again.');
                }
            })
            .catch(error => {
                console.error('Logout error:', error);
                alert('An error occurred during logout.');
            });
        }
    </script>
</body>
</html>