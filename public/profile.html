<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: aliceblue;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .wrapper {
            padding: 30px 50px;
            border: 1px solid #ddd;
            border-radius: 15px;
            background-color: white;
            width: 100%;
            max-width: 800px;
            position: relative;
        }

        .back-arrow {
            position: absolute;
            top: 25px;
            left: 25px;
            font-size: 20px;
            color: #0779e4;
            cursor: pointer;
            transition: all 0.2s;
        }

        .back-arrow:hover {
            color: #055cb3;
            transform: translateX(-3px);
        }

        h4 {
            letter-spacing: -1px;
            font-weight: 400;
            text-align: center;
            padding-top: 5px;
        }

        .profile-picture {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #0779e4;
        }

        #img-section p, #deactivate p {
            font-size: 12px;
            color: #777;
            margin-bottom: 10px;
            text-align: justify;
        }

        #img-section b, #img-section button, #deactivate b {
            font-size: 14px;
        }

        label {
            margin-bottom: 0;
            font-size: 14px;
            font-weight: 500;
            color: #777;
            padding-left: 3px;
        }

        .form-control {
            border-radius: 10px;
        }

        input[placeholder] {
            font-weight: 500;
        }

        .form-control:focus {
            box-shadow: none;
            border: 1.5px solid #0779e4;
        }

        select {
            display: block;
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 10px;
            height: 40px;
            padding: 5px 10px;
        }

        select:focus {
            outline: none;
        }

        .button {
            background-color: #fff;
            color: #0779e4;
        }

        .button:hover {
            background-color: #0779e4;
            color: #fff;
        }

        .btn-primary {
            background-color: #0779e4;
        }

        .danger {
            background-color: #fff;
            color: #e20404;
            border: 1px solid #ddd;
        }

        .danger:hover {
            background-color: #e20404;
            color: #fff;
        }

        .profile-info p {
            margin-bottom: 8px;
        }

        .profile-info span {
            font-weight: normal;
            color: #555;
        }

        .profile-field {
            margin-bottom: 15px;
        }

        .profile-value {
            font-weight: normal;
            color: #555;
            padding: 8px;
            background-color: #f9f9f9;
            border-radius: 5px;
            display: inline-block;
            min-width: 200px;
        }

        .edit-field {
            display: none;
        }

        .readonly-field {
            background-color: #f0f0f0;
        }

        .additional-info-field {
            margin-bottom: 15px;
        }
        
        .additional-info-label {
            margin-bottom: 0;
            font-size: 14px;
            font-weight: 500;
            color: #777;
            padding-left: 3px;
        }
        
        .additional-info-value {
            font-weight: normal;
            color: #555;
            padding: 8px;
            background-color: #f9f9f9;
            border-radius: 5px;
            display: inline-block;
            min-width: 200px;
        }

        .radio-group {
            display: flex;
            gap: 15px;
        }

        .radio-item {
            display: flex;
            align-items: center;
        }

        .radio-item input {
            margin-right: 5px;
        }

        .form-section-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            font-size: 15px;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
        }

        .checkbox-item input {
            margin-right: 5px;
        }

        /* Change Password Section Styles */
        .change-password-section {
            margin-top: 30px;
            padding: 20px;
            border: 1px solid #eee;
            border-radius: 10px;
            background-color: #f9f9f9;
        }

        .password-requirements {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .requirement {
            margin-bottom: 3px;
        }

        .requirement.met {
            color: #28a745;
        }

        .requirement.not-met {
            color: #dc3545;
        }

        .message {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: none;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        @media (max-width: 576px) {
            .wrapper {
                padding: 25px 20px;
            }
            .back-arrow {
                top: 15px;
                left: 15px;
            }
            .radio-group {
                flex-direction: column;
                gap: 5px;
            }
            .checkbox-group {
                flex-direction: column;
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="wrapper bg-white mt-sm-5">
        <a href="/residentdashboard" class="back-arrow">
            <i class="fas fa-arrow-left"></i>
        </a>
        
        <h4 class="pb-4 border-bottom">User Profile</h4>
        <div class="d-flex align-items-start py-3 border-bottom">
            <img id="profilePicture" src="" alt="Profile Picture" class="profile-picture">
            <div class="pl-sm-4 pl-2" id="img-section">
                <b>Profile Photo</b>
                <p>Accepted file types: .png, .jpg, .jpeg. Less than 2MB</p>
                <form id="uploadForm" class="d-flex align-items-center">
                    <input type="file" id="newProfilePicture" accept="image/*" class="d-none">
                    <label for="newProfilePicture" class="btn button border mr-2"><b>Choose File</b></label>
                    <button type="submit" class="btn btn-primary">Upload</button>
                </form>
            </div>
        </div>
        <div class="py-2">
            <div class="row py-2">
                <div class="col-md-6 profile-field">
                    <label for="fullName">Full Name</label>
                    <div class="profile-value" id="fullNameDisplay"></div>
                    <input type="text" class="form-control edit-field" id="fullName" placeholder="Enter full name">
                </div>
                <div class="col-md-6 pt-md-0 pt-3 profile-field">
                    <label for="email">Email Address</label>
                    <div class="profile-value" id="emailDisplay"></div>
                    <input type="email" class="form-control edit-field readonly-field" id="email" placeholder="Enter email" readonly>
                </div>
            </div>
            <div class="row py-2">
                <div class="col-md-6 profile-field">
                    <label for="middleName">Middle Name</label>
                    <div class="profile-value" id="middleNameDisplay"></div>
                    <input type="text" class="form-control edit-field" id="middleName" placeholder="Enter middle name">
                </div>
                <div class="col-md-6 pt-md-0 pt-3 profile-field">
                    <label for="suffix">Suffix</label>
                    <div class="profile-value" id="suffixDisplay"></div>
                    <input type="text" class="form-control edit-field" id="suffix" placeholder="Enter suffix (Jr, Sr, III)">
                </div>
            </div>
            <div class="row py-2">
                <div class="col-md-6 profile-field">
                    <label for="contactNumber">Contact Number</label>
                    <div class="profile-value" id="contactNumberDisplay"></div>
                    <input type="tel" class="form-control edit-field" id="contactNumber" placeholder="Enter contact number">
                </div>
                <div class="col-md-6 pt-md-0 pt-3 profile-field">
                    <label for="birthdate">Birthdate</label>
                    <div class="profile-value" id="birthdateDisplay"></div>
                    <input type="date" class="form-control edit-field" id="birthdate">
                </div>
            </div>
            <div class="row py-2">
                <div class="col-md-6 profile-field">
                    <label for="civilStatus">Civil Status</label>
                    <div class="profile-value" id="civilStatusDisplay"></div>
                    <select class="form-control edit-field" id="civilStatus">
                        <option value="">Select civil status</option>
                        <option value="Single">Single</option>
                        <option value="Married">Married</option>
                        <option value="Divorced">Divorced</option>
                        <option value="Widowed">Widowed</option>
                    </select>
                </div>
                <div class="col-md-6 pt-md-0 pt-3 profile-field">
                    <label for="occupation">Occupation</label>
                    <div class="profile-value" id="occupationDisplay"></div>
                    <select class="form-control edit-field" id="occupation">
                        <option value="">Select occupation</option>
                        <option value="Student">Student</option>
                        <option value="Employed">Employed</option>
                        <option value="Unemployed">Unemployed</option>
                        <option value="Self-employed">Self-employed</option>
                        <option value="Retired">Retired</option>
                        <option value="Government Employee">Government Employee</option>
                        <option value="Private Employee">Private Employee</option>
                        <option value="Business Owner">Business Owner</option>
                        <option value="Farmer">Farmer</option>
                        <option value="Fisherman">Fisherman</option>
                        <option value="Housewife/Househusband">Housewife/Househusband</option>
                    </select>
                </div>
            </div>
            <div class="row py-2">
                <div class="col-md-6 profile-field">
                    <label for="monthlyIncome">Monthly Income</label>
                    <div class="profile-value" id="monthlyIncomeDisplay"></div>
                    <select class="form-control edit-field" id="monthlyIncome">
                        <option value="">Select monthly income</option>
                        <option value="Below 5,000">Below ₱5,000</option>
                        <option value="5,000-10,000">₱5,000 - ₱10,000</option>
                        <option value="10,001-20,000">₱10,001 - ₱20,000</option>
                        <option value="20,001-30,000">₱20,001 - ₱30,000</option>
                        <option value="30,001-50,000">₱30,001 - ₱50,000</option>
                        <option value="Above 50,000">Above ₱50,000</option>
                    </select>
                </div>
                <div class="col-md-6 pt-md-0 pt-3 profile-field">
                    <label for="yearsResiding">Years Residing in Barangay</label>
                    <div class="profile-value" id="yearsResidingDisplay"></div>
                    <select class="form-control edit-field" id="yearsResiding">
                        <option value="">Select years residing</option>
                        <option value="Since birth">Since birth</option>
                        <option value="1-5 years">1-5 years</option>
                        <option value="6-10 years">6-10 years</option>
                        <option value="11-20 years">11-20 years</option>
                        <option value="20+ years">20+ years</option>
                    </select>
                </div>
            </div>
            <div class="row py-2">
                <div class="col-md-6 profile-field">
                    <label>Homeowner Status</label>
                    <div class="profile-value" id="homeownerDisplay"></div>
                    <div class="radio-group edit-field">
                        <div class="radio-item">
                            <input type="radio" id="homeownerYes" name="homeowner" value="Yes">
                            <label for="homeownerYes">Homeowner</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="homeownerNo" name="homeowner" value="No">
                            <label for="homeownerNo">Renting</label>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 pt-md-0 pt-3 profile-field">
                    <label for="alternateContact">Alternate Contact Number</label>
                    <div class="profile-value" id="alternateContactDisplay"></div>
                    <input type="tel" class="form-control edit-field" id="alternateContact" placeholder="Enter alternate contact number">
                </div>
            </div>
            <div class="row py-2">
                <div class="col-md-12 profile-field">
                    <label for="address">Address</label>
                    <div class="profile-value" id="addressDisplay" style="min-width: 100%;"></div>
                    <textarea class="form-control edit-field" id="address" placeholder="Enter address" style="min-width: 100%;"></textarea>
                </div>
            </div>
            <div class="row py-2">
                <div class="col-md-12 profile-field">
                    <label for="educationalAttainment">Educational Attainment</label>
                    <div class="profile-value" id="educationalAttainmentDisplay" style="min-width: 100%;"></div>
                    <select class="form-control edit-field" id="educationalAttainment">
                        <option value="">Select educational attainment</option>
                        <option value="Elementary Graduate">Elementary Graduate</option>
                        <option value="High School Graduate">High School Graduate</option>
                        <option value="Vocational Graduate">Vocational Graduate</option>
                        <option value="College Graduate">College Graduate</option>
                        <option value="Post Graduate">Post Graduate</option>
                        <option value="None">None</option>
                    </select>
                </div>
            </div>
            <div class="row py-2">
                <div class="col-md-12 profile-field">
                    <div class="form-section-title">Government Program Participation</div>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="registeredVoter" name="registeredVoter">
                            <label for="registeredVoter">Registered Voter</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="fourPsMember" name="fourPsMember">
                            <label for="fourPsMember">4Ps Member</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="pwdMember" name="pwdMember">
                            <label for="pwdMember">PWD Member</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="seniorCitizen" name="seniorCitizen">
                            <label for="seniorCitizen">Senior Citizen</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="soloParent" name="soloParent">
                            <label for="soloParent">Solo Parent</label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row py-2" id="additionalInfoContainer">
                <!-- Additional info fields will be inserted here -->
            </div>

            <!-- Change Password Section -->
            <div class="change-password-section">
                <h5 class="form-section-title">Change Password</h5>
                <div id="passwordMessage" class="message"></div>
                
                <form id="changePasswordForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="currentPassword">Current Password</label>
                                <input type="password" id="currentPassword" name="currentPassword" class="form-control" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="newPassword">New Password</label>
                                <input type="password" id="newPassword" name="newPassword" class="form-control" required oninput="validatePassword()">
                                <div class="password-requirements">
                                    <div id="reqLength" class="requirement not-met">At least 8 characters</div>
                                    <div id="reqUppercase" class="requirement not-met">At least one uppercase letter</div>
                                    <div id="reqSpecial" class="requirement not-met">At least one special character</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="confirmPassword">Confirm New Password</label>
                                <input type="password" id="confirmPassword" name="confirmPassword" class="form-control" required oninput="checkPasswordMatch()">
                                <div id="passwordMatch" class="password-requirements"></div>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary" id="changePasswordBtn">Change Password</button>
                </form>
            </div>

            <div class="py-3 pb-4 border-bottom d-flex justify-content-between">
                <button class="btn btn-primary" id="editProfileBtn">Edit Profile</button>
                <button class="btn btn-success edit-field" id="saveProfileBtn" style="display: none;">Save Changes</button>
                <button class="btn button border edit-field" id="cancelEditBtn" style="display: none;">Cancel</button>
                <button class="btn button border" onclick="logout()">Logout</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.bundle.min.js"></script>
    <script>
        let originalData = {}; // To store original values when editing
    
        // Check authentication status when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                const response = await fetch('/api/auth/check-auth', {
                    credentials: 'include'
                });
                
                const authData = await response.json();
                
                if (!authData.isAuthenticated) {
                    window.location.href = '/login';
                    return;
                }
                
                // Fetch user profile if authenticated
                await fetchUserProfile();
                
                // Set up event listeners
                setupEventListeners();
            } catch (error) {
                console.error('Error checking auth status:', error);
                window.location.href = '/login';
            }
        });
    
        function setupEventListeners() {
            document.getElementById('newProfilePicture').addEventListener('change', function() {
                const fileName = this.files[0] ? this.files[0].name : 'No file chosen';
                document.querySelector('label[for="newProfilePicture"]').textContent = fileName;
            });
    
            document.getElementById('uploadForm').addEventListener('submit', updateProfilePicture);
            
            document.getElementById('editProfileBtn').addEventListener('click', function() {
                toggleEditMode(true);
            });
    
            document.getElementById('saveProfileBtn').addEventListener('click', function(e) {
                e.preventDefault();
                saveProfile();
            });
    
            document.getElementById('cancelEditBtn').addEventListener('click', function(e) {
                e.preventDefault();
                cancelEdit();
            });

            // Change password form event listener
            document.getElementById('changePasswordForm').addEventListener('submit', handlePasswordChange);
        }
    
        async function fetchUserProfile() {
            try {
                const response = await fetch('/api/auth/profile', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });
    
                const result = await response.json();
                
                if (response.ok) {
                    // Store the original data
                    originalData = {
                        fullName: result.fullName || '',
                        email: result.email || '',
                        contactNumber: result.contactNumber || '',
                        address: result.address || '',
                        birthdate: result.birthdate || '',
                        civilStatus: result.civilStatus || '',
                        occupation: result.occupation || '',
                        educationalAttainment: result.educationalAttainment || '',
                        middleName: result.middleName || '',
                        suffix: result.suffix || '',
                        alternateContact: result.alternateContact || '',
                        monthlyIncome: result.monthlyIncome || '',
                        homeowner: result.homeowner || 'No',
                        yearsResiding: result.yearsResiding || '',
                        registeredVoter: result.registeredVoter || false,
                        fourPsMember: result.fourPsMember || false,
                        pwdMember: result.pwdMember || false,
                        seniorCitizen: result.seniorCitizen || false,
                        soloParent: result.soloParent || false
                    };
    
                    // Display values
                    document.getElementById('fullNameDisplay').textContent = originalData.fullName || 'Not provided';
                    document.getElementById('emailDisplay').textContent = originalData.email || 'Not provided';
                    document.getElementById('contactNumberDisplay').textContent = originalData.contactNumber || 'Not provided';
                    document.getElementById('addressDisplay').textContent = originalData.address || 'Not provided';
                    document.getElementById('birthdateDisplay').textContent = originalData.birthdate ? 
                        formatDate(originalData.birthdate) : 'Not provided';
                    document.getElementById('civilStatusDisplay').textContent = originalData.civilStatus || 'Not provided';
                    document.getElementById('occupationDisplay').textContent = originalData.occupation || 'Not provided';
                    document.getElementById('educationalAttainmentDisplay').textContent = 
                        originalData.educationalAttainment || 'Not provided';
                    
                    // Display values for new fields
                    document.getElementById('middleNameDisplay').textContent = originalData.middleName || 'Not provided';
                    document.getElementById('suffixDisplay').textContent = originalData.suffix || 'Not provided';
                    document.getElementById('alternateContactDisplay').textContent = originalData.alternateContact || 'Not provided';
                    document.getElementById('monthlyIncomeDisplay').textContent = originalData.monthlyIncome || 'Not provided';
                    document.getElementById('homeownerDisplay').textContent = originalData.homeowner || 'Not provided';
                    document.getElementById('yearsResidingDisplay').textContent = originalData.yearsResiding || 'Not provided';
    
                    // Set form field values
                    document.getElementById('fullName').value = originalData.fullName;
                    document.getElementById('email').value = originalData.email;
                    document.getElementById('contactNumber').value = originalData.contactNumber;
                    document.getElementById('address').value = originalData.address;
                    document.getElementById('birthdate').value = originalData.birthdate ? 
                        formatDateForInput(originalData.birthdate) : '';
                    document.getElementById('civilStatus').value = originalData.civilStatus;
                    document.getElementById('occupation').value = originalData.occupation;
                    document.getElementById('educationalAttainment').value = originalData.educationalAttainment;
                    
                    // Set values for new fields
                    document.getElementById('middleName').value = originalData.middleName;
                    document.getElementById('suffix').value = originalData.suffix;
                    document.getElementById('alternateContact').value = originalData.alternateContact;
                    document.getElementById('monthlyIncome').value = originalData.monthlyIncome;
                    document.getElementById('yearsResiding').value = originalData.yearsResiding;
                    
                    // Set homeowner radio buttons
                    if (originalData.homeowner === 'Yes') {
                        document.getElementById('homeownerYes').checked = true;
                    } else {
                        document.getElementById('homeownerNo').checked = true;
                    }
    
                    // Set checkbox values
                    document.getElementById('registeredVoter').checked = originalData.registeredVoter;
                    document.getElementById('fourPsMember').checked = originalData.fourPsMember;
                    document.getElementById('pwdMember').checked = originalData.pwdMember;
                    document.getElementById('seniorCitizen').checked = originalData.seniorCitizen;
                    document.getElementById('soloParent').checked = originalData.soloParent;
    
                    // Set profile picture - add timestamp to prevent caching
                    const timestamp = new Date().getTime();
                    const profilePicUrl = result.profilePictureUrl || 
                                        `images/default-profile.png?${timestamp}`;
                    document.getElementById('profilePicture').src = profilePicUrl;
    
                    // Display additional information
                    displayAdditionalInfo(originalData);
                } else {
                    alert(result.error || 'Failed to fetch profile data');
                    if (response.status === 401) {
                        window.location.href = '/login';
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while fetching user profile.');
                window.location.href = '/login';
            }
        }
    
        function displayAdditionalInfo(data) {
            const container = document.getElementById('additionalInfoContainer');
            container.innerHTML = '';
            
            // Only show fields that are true/YES
            const additionalInfo = [
                { key: 'registeredVoter', label: 'Registered Voter' },
                { key: 'fourPsMember', label: '4Ps Member' },
                { key: 'pwdMember', label: 'PWD Member' },
                { key: 'seniorCitizen', label: 'Senior Citizen' },
                { key: 'soloParent', label: 'Solo Parent' }
            ];
    
            additionalInfo.forEach(info => {
                if (data[info.key]) {
                    const fieldDiv = document.createElement('div');
                    fieldDiv.className = 'col-md-6 additional-info-field';
                    
                    const labelElement = document.createElement('label');
                    labelElement.className = 'additional-info-label';
                    labelElement.textContent = info.label;
                    
                    fieldDiv.appendChild(labelElement);
                    container.appendChild(fieldDiv);
                }
            });
        }
    
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }
    
        function formatDateForInput(dateString) {
            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
    
        async function updateProfilePicture(event) {
            event.preventDefault();
            const fileInput = document.getElementById('newProfilePicture');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a file.');
                return;
            }
    
            if (file.size > 2 * 1024 * 1024) {
                alert('File size must be less than 2MB.');
                return;
            }
    
            const formData = new FormData();
            formData.append('profilePicture', file);
    
            try {
                const response = await fetch('/api/auth/update-profile-picture', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });
    
                const result = await response.json();
                if (response.ok) {
                    alert('Profile picture updated successfully!');
                    // Update the displayed image immediately
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('profilePicture').src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                    
                    // Clear the file input
                    fileInput.value = '';
                    document.querySelector('label[for="newProfilePicture"]').textContent = 'Choose File';
                } else {
                    alert(result.error || 'Failed to update profile picture');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while updating the profile picture.');
            }
        }
    
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                fetch('/api/auth/logout', {
                    method: 'POST',
                    credentials: 'include'
                })
                .then(response => {
                    if (response.ok) {
                        window.location.href = '/login';
                    } else {
                        alert('Failed to logout. Please try again.');
                    }
                })
                .catch(error => {
                    console.error('Logout error:', error);
                    alert('An error occurred during logout.');
                });
            }   
        }
    
        function toggleEditMode(edit) {
            const displayFields = document.querySelectorAll('.profile-value');
            const editFields = document.querySelectorAll('.edit-field');
            const editBtn = document.getElementById('editProfileBtn');
            const saveBtn = document.getElementById('saveProfileBtn');
            const cancelBtn = document.getElementById('cancelEditBtn');
    
            if (edit) {
                // Enter edit mode
                displayFields.forEach(field => field.style.display = 'none');
                editFields.forEach(field => field.style.display = 'block');
                editBtn.style.display = 'none';
                saveBtn.style.display = 'block';
                cancelBtn.style.display = 'block';
            } else {
                // Exit edit mode
                displayFields.forEach(field => field.style.display = 'inline-block');
                editFields.forEach(field => field.style.display = 'none');
                editBtn.style.display = 'block';
                saveBtn.style.display = 'none';
                cancelBtn.style.display = 'none';
            }
        }
    
        async function saveProfile() {
            // Get homeowner status
            const homeowner = document.querySelector('input[name="homeowner"]:checked')?.value || 'No';
            
            // Prepare the update data with proper formatting
            const updatedData = {
                fullName: document.getElementById('fullName').value.trim(),
                contactNumber: document.getElementById('contactNumber').value.trim(),
                address: document.getElementById('address').value.trim(),
                birthdate: document.getElementById('birthdate').value || null,
                civilStatus: document.getElementById('civilStatus').value || null,
                occupation: document.getElementById('occupation').value.trim() || null,
                educationalAttainment: document.getElementById('educationalAttainment').value || null,
                middleName: document.getElementById('middleName').value.trim() || null,
                suffix: document.getElementById('suffix').value.trim() || null,
                alternateContact: document.getElementById('alternateContact').value.trim() || null,
                monthlyIncome: document.getElementById('monthlyIncome').value || null,
                yearsResiding: document.getElementById('yearsResiding').value || null,
                homeowner: homeowner,
                registeredVoter: document.getElementById('registeredVoter').checked,
                fourPsMember: document.getElementById('fourPsMember').checked,
                pwdMember: document.getElementById('pwdMember').checked,
                seniorCitizen: document.getElementById('seniorCitizen').checked,
                soloParent: document.getElementById('soloParent').checked
            };
    
            // Validate required fields
            if (!updatedData.fullName) {
                alert('Full name is required');
                return;
            }
    
            if (!updatedData.contactNumber) {
                alert('Contact number is required');
                return;
            }
    
            if (!updatedData.address) {
                alert('Address is required');
                return;
            }
    
            // Log the data being sent for debugging
            console.log('Sending update data:', updatedData);
    
            try {
                const response = await fetch('/api/residents/profile', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updatedData),
                    credentials: 'include'
                });
    
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Error response:', errorData);
                    throw new Error(errorData.message || 'Failed to update profile');
                }
    
                const result = await response.json();
                alert('Profile updated successfully!');
                fetchUserProfile();
                toggleEditMode(false);
            } catch (error) {
                console.error('Error:', error);
                alert(error.message || 'An error occurred while updating the profile.');
            }
        }
    
        function cancelEdit() {
            // Restore original values
            document.getElementById('fullName').value = originalData.fullName;
            document.getElementById('contactNumber').value = originalData.contactNumber;
            document.getElementById('address').value = originalData.address;
            document.getElementById('birthdate').value = originalData.birthdate ? 
                formatDateForInput(originalData.birthdate) : '';
            document.getElementById('civilStatus').value = originalData.civilStatus;
            document.getElementById('occupation').value = originalData.occupation;
            document.getElementById('educationalAttainment').value = originalData.educationalAttainment;
            
            // Restore new fields
            document.getElementById('middleName').value = originalData.middleName;
            document.getElementById('suffix').value = originalData.suffix;
            document.getElementById('alternateContact').value = originalData.alternateContact;
            document.getElementById('monthlyIncome').value = originalData.monthlyIncome;
            document.getElementById('yearsResiding').value = originalData.yearsResiding;
            
            // Restore homeowner radio buttons
            if (originalData.homeowner === 'Yes') {
                document.getElementById('homeownerYes').checked = true;
            } else {
                document.getElementById('homeownerNo').checked = true;
            }
    
            // Restore checkbox values
            document.getElementById('registeredVoter').checked = originalData.registeredVoter;
            document.getElementById('fourPsMember').checked = originalData.fourPsMember;
            document.getElementById('pwdMember').checked = originalData.pwdMember;
            document.getElementById('seniorCitizen').checked = originalData.seniorCitizen;
            document.getElementById('soloParent').checked = originalData.soloParent;
    
            toggleEditMode(false);
        }

        // ==================== PASSWORD CHANGE FUNCTIONS ====================
        
        // Password validation
        function validatePassword() {
            const password = document.getElementById('newPassword').value;
            
            const lengthReq = document.getElementById('reqLength');
            const uppercaseReq = document.getElementById('reqUppercase');
            const specialReq = document.getElementById('reqSpecial');
            
            // Check length
            if (password.length >= 8) {
                lengthReq.className = 'requirement met';
            } else {
                lengthReq.className = 'requirement not-met';
            }
            
            // Check uppercase
            if (/[A-Z]/.test(password)) {
                uppercaseReq.className = 'requirement met';
            } else {
                uppercaseReq.className = 'requirement not-met';
            }
            
            // Check special character
            if (/[!@#$%^&*(),.?":{}|<>]/.test(password)) {
                specialReq.className = 'requirement met';
            } else {
                specialReq.className = 'requirement not-met';
            }
        }

        // Check password match
        function checkPasswordMatch() {
            const password = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const matchElement = document.getElementById('passwordMatch');
            
            if (confirmPassword === '') {
                matchElement.textContent = '';
                return;
            }
            
            if (password === confirmPassword) {
                matchElement.textContent = 'Passwords match';
                matchElement.style.color = '#28a745';
            } else {
                matchElement.textContent = 'Passwords do not match';
                matchElement.style.color = '#dc3545';
            }
        }

        // Handle password change
        async function handlePasswordChange(e) {
            e.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const messageElement = document.getElementById('passwordMessage');
            const changePasswordBtn = document.getElementById('changePasswordBtn');
            
            // Validate password requirements
            if (newPassword.length < 8 || 
                !/[A-Z]/.test(newPassword) || 
                !/[!@#$%^&*(),.?":{}|<>]/.test(newPassword)) {
                showMessage(messageElement, 'Please ensure your password meets all requirements.', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showMessage(messageElement, 'Passwords do not match.', 'error');
                return;
            }
            
            try {
                changePasswordBtn.disabled = true;
                changePasswordBtn.textContent = 'Changing...';
                
                const response = await fetch('/api/auth/change-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        currentPassword,
                        newPassword
                    }),
                    credentials: 'include'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showMessage(messageElement, 'Password changed successfully!', 'success');
                    document.getElementById('changePasswordForm').reset();
                    validatePassword();
                    document.getElementById('passwordMatch').textContent = '';
                } else {
                    showMessage(messageElement, result.message || 'Failed to change password', 'error');
                }
            } catch (error) {
                console.error('Error changing password:', error);
                showMessage(messageElement, 'An error occurred while changing password', 'error');
            } finally {
                changePasswordBtn.disabled = false;
                changePasswordBtn.textContent = 'Change Password';
            }
        }

        // Helper function to show messages
        function showMessage(element, message, type) {
            element.textContent = message;
            element.className = `message ${type}`;
            element.style.display = 'block';
            
            setTimeout(() => {
                element.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>