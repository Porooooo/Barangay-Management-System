<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile - Barangay Talipapa</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/profile.css">
    <link rel="icon" type="image/png" href="images/barangay-bg.png">
    <style>
        /* Additional styles for the new layout */
        .profile-header {
            display: flex;
            align-items: center;
            gap: 20px;
            position: relative;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .profile-picture-container {
            position: relative;
            flex-shrink: 0;
        }

        .profile-picture {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .profile-upload-btn {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(13, 79, 139, 0.3);
        }

        .profile-upload-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(13, 79, 139, 0.4);
        }

        .profile-info-header {
            flex: 1;
        }

        .profile-name {
            font-size: 24px;
            font-weight: 700;
            color: #333;
            margin-bottom: 5px;
        }

        .profile-email {
            font-size: 16px;
            color: #666;
            margin-bottom: 10px;
        }

        .profile-status {
            display: inline-block;
            padding: 4px 12px;
            background: #28a745;
            color: white;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .profile-header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .action-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .edit-btn {
            background: var(--primary);
            color: white;
        }

        .password-btn {
            background: var(--secondary);
            color: white;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        /* Edit Profile Modal */
        .edit-profile-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }

        .edit-profile-content {
            background: white;
            padding: 30px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow-y: auto;
        }

        .edit-profile-content h3 {
            margin-bottom: 25px;
            color: var(--primary);
            text-align: center;
            font-size: 24px;
        }

        .close-edit-modal {
            position: absolute;
            top: 20px;
            right: 25px;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            transition: color 0.3s ease;
        }

        .close-edit-modal:hover {
            color: #333;
        }

        .edit-profile-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .edit-form-section {
            margin-bottom: 20px;
        }

        .edit-form-section.full-width {
            grid-column: 1 / -1;
        }

        .edit-form-section h4 {
            margin-bottom: 15px;
            color: var(--primary);
            font-size: 16px;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 8px;
        }

        .edit-form-group {
            margin-bottom: 15px;
        }

        .edit-form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .edit-form-group input,
        .edit-form-group select,
        .edit-form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
            font-family: inherit;
        }

        .edit-form-group input:focus,
        .edit-form-group select:focus,
        .edit-form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .edit-form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .checkbox-group-edit {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .checkbox-item-edit {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-item-edit input {
            width: auto;
        }

        .checkbox-item-edit label {
            margin: 0;
            font-weight: normal;
            font-size: 14px;
        }

        .edit-profile-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 2px solid #e9ecef;
            grid-column: 1 / -1;
        }

        .edit-profile-actions button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .save-edit-btn {
            background: var(--primary);
            color: white;
        }

        .cancel-edit-btn {
            background: #6c757d;
            color: white;
        }

        .save-edit-btn:hover,
        .cancel-edit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        /* Change Password Modal */
        .change-password-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .change-password-content {
            background: white;
            padding: 25px;
            width: 90%;
            max-width: 450px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .change-password-content h3 {
            margin-bottom: 20px;
            color: var(--primary);
            text-align: center;
        }

        .close-password-modal {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 20px;
            cursor: pointer;
            color: #666;
        }

        .password-form-group {
            margin-bottom: 15px;
        }

        .password-form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }

        .password-form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .password-requirements {
            margin-top: 8px;
            font-size: 12px;
        }

        .requirement {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 3px;
        }

        .requirement.met {
            color: #28a745;
        }

        .requirement.not-met {
            color: #6c757d;
        }

        .password-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .password-actions button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
        }

        .password-submit {
            background: var(--primary);
            color: white;
        }

        .password-cancel {
            background: #6c757d;
            color: white;
        }

        .d-none {
            display: none !important;
        }

        /* Hide monthly income and logout button */
        .monthly-income-section {
            display: none !important;
        }

        .profile-actions .btn-danger {
            display: none !important;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .profile-header {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }

            .profile-header-actions {
                justify-content: center;
                width: 100%;
            }

            .edit-profile-form {
                grid-template-columns: 1fr;
            }

            .checkbox-group-edit {
                grid-template-columns: 1fr;
            }

            .edit-profile-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Mobile Menu Button -->
    <div class="mobile-menu-btn" onclick="toggleMenu()">
        <i class="fas fa-bars"></i>
    </div>

    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="logo-name">
            <div class="logo-image">
                <img src="images/barangay-bg.png" alt="BTMS Logo">
            </div>
            <span class="logo_name">Brgy. Talipapa</span>
            <div class="mobile-close-btn">
                <i class="fas fa-times"></i>
            </div>
        </div>
        
        <div class="menu-items">
            <ul class="nav-links">
                <li><a href="/residentdashboard">
                    <i class="fas fa-home"></i>
                    <span class="link-name">Dashboard</span>
                </a></li>
            
                <li><a href="/requests">
                    <i class="fas fa-file-alt"></i>
                    <span class="link-name">Request Document</span>
                </a></li>
                <li><a href="/announcement">
                    <i class="fas fa-bell"></i>
                    <span class="link-name">Announcements</span>
                </a></li>
            
                <li><a href="/blotter">
                    <i class="fas fa-shield-alt"></i>
                    <span class="link-name">Blotter</span>
                </a></li>
            
            </ul>
            
            <!-- Logout Section -->
            <div class="logout-section">
                <a href="#" id="sidebarLogoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                    <span class="link-name">Logout</span>
                </a>
            </div>
        </div>
        
        <!-- Greeting and Time Section - MOVED TO BOTTOM -->
        <div class="greeting-section">
            <div class="greeting" id="greetingText">Good Morning</div>
            <div class="current-date" id="currentDate">Thursday, Jul 09, 2020</div>
            <div class="current-time" id="currentTime">07:08:09 AM</div>
        </div>
    </nav>
    
    <!-- Main Content -->
    <section class="main-content">
        <div class="page-header">
            <h1 class="page-title">User Profile</h1>
        </div>

        <!-- Profile Container -->
        <div class="profile-container">
            <!-- Profile Header with Action Buttons -->
            <div class="profile-header">
                <div class="profile-picture-container">
                    <img id="profilePicture" src="" alt="Profile Picture" class="profile-picture">
                    <div class="profile-upload-btn" onclick="document.getElementById('newProfilePicture').click()">
                        <i class="fas fa-camera"></i>
                    </div>
                    <input type="file" id="newProfilePicture" accept="image/*" class="d-none">
                </div>
                <div class="profile-info-header">
                    <h2 class="profile-name" id="profileNameDisplay">Loading...</h2>
                    <p class="profile-email" id="profileEmailDisplay">Loading...</p>
                    <span class="profile-status">Active Account</span>
                </div>
                
                <!-- Action Buttons aligned with profile header -->
                <div class="profile-header-actions">
                    <button type="button" class="action-btn edit-btn" onclick="openEditProfileModal()">
                        <i class="fas fa-edit"></i> Edit Profile
                    </button>
                    <button type="button" class="action-btn password-btn" onclick="openChangePasswordModal()">
                        <i class="fas fa-key"></i> Change Password
                    </button>
                </div>
            </div>

            <!-- Profile Display (Read-only) -->
            <div class="profile-display">
                <div class="profile-form">
                    <!-- Personal Information -->
                    <div class="form-section">
                        <h3 class="form-section-title">Personal Information</h3>
                        
                        <div class="form-group">
                            <label class="form-label">Full Name</label>
                            <div class="profile-value" id="fullNameDisplay">Loading...</div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Email Address</label>
                            <div class="profile-value" id="emailDisplay">Loading...</div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Contact Number</label>
                            <div class="profile-value" id="contactNumberDisplay">Loading...</div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Birthdate</label>
                            <div class="profile-value" id="birthdateDisplay">Loading...</div>
                        </div>
                    </div>

                    <!-- Additional Information -->
                    <div class="form-section">
                        <h3 class="form-section-title">Additional Information</h3>
                        
                        <div class="form-group">
                            <label class="form-label">Civil Status</label>
                            <div class="profile-value" id="civilStatusDisplay">Loading...</div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Occupation</label>
                            <div class="profile-value" id="occupationDisplay">Loading...</div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Educational Attainment</label>
                            <div class="profile-value" id="educationalAttainmentDisplay">Loading...</div>
                        </div>
                    </div>

                    <!-- Address Information -->
                    <div class="form-section" style="grid-column: 1 / -1;">
                        <h3 class="form-section-title">Address Information</h3>
                        
                        <div class="form-group">
                            <label class="form-label">Complete Address</label>
                            <div class="profile-value" id="addressDisplay">Loading...</div>
                        </div>
                    </div>

                    <!-- Government Programs -->
                    <div class="form-section" style="grid-column: 1 / -1;">
                        <h3 class="form-section-title">Government Program Participation</h3>
                        
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="registeredVoterDisplay" disabled>
                                <label for="registeredVoterDisplay">Registered Voter</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="fourPsMemberDisplay" disabled>
                                <label for="fourPsMemberDisplay">4Ps Member</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="pwdMemberDisplay" disabled>
                                <label for="pwdMemberDisplay">PWD Member</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="seniorCitizenDisplay" disabled>
                                <label for="seniorCitizenDisplay">Senior Citizen</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="soloParentDisplay" disabled>
                                <label for="soloParentDisplay">Solo Parent</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Edit Profile Modal -->
    <div id="editProfileModal" class="edit-profile-modal">
        <div class="edit-profile-content">
            <span class="close-edit-modal" onclick="closeEditProfileModal()">&times;</span>
            <h3>Edit Profile</h3>
            
            <form id="editProfileForm">
                <div class="edit-profile-form">
                    <!-- Personal Information -->
                    <div class="edit-form-section">
                        <h4>Personal Information</h4>
                        
                        <div class="edit-form-group">
                            <label for="editFullName">Full Name *</label>
                            <input type="text" id="editFullName" name="fullName" required>
                        </div>
                        
                        <div class="edit-form-group">
                            <label for="editEmail">Email Address</label>
                            <input type="email" id="editEmail" name="email" readonly style="background-color: #f8f9fa;">
                        </div>
                        
                        <div class="edit-form-group">
                            <label for="editContactNumber">Contact Number *</label>
                            <input type="tel" id="editContactNumber" name="contactNumber" required>
                        </div>
                        
                        <div class="edit-form-group">
                            <label for="editBirthdate">Birthdate</label>
                            <input type="date" id="editBirthdate" name="birthdate">
                        </div>
                    </div>

                    <!-- Additional Information -->
                    <div class="edit-form-section">
                        <h4>Additional Information</h4>
                        
                        <div class="edit-form-group">
                            <label for="editCivilStatus">Civil Status</label>
                            <select id="editCivilStatus" name="civilStatus">
                                <option value="">Select civil status</option>
                                <option value="Single">Single</option>
                                <option value="Married">Married</option>
                                <option value="Divorced">Divorced</option>
                                <option value="Widowed">Widowed</option>
                            </select>
                        </div>
                        
                        <div class="edit-form-group">
                            <label for="editOccupation">Occupation</label>
                            <select id="editOccupation" name="occupation">
                                <option value="">Select occupation</option>
                                <option value="Student">Student</option>
                                <option value="Employed">Employed</option>
                                <option value="Unemployed">Unemployed</option>
                                <option value="Self-employed">Self-employed</option>
                                <option value="Retired">Retired</option>
                                <option value="Government Employee">Government Employee</option>
                                <option value="Private Employee">Private Employee</option>
                                <option value="Business Owner">Business Owner</option>
                                <option value="Farmer">Farmer</option>
                                <option value="Fisherman">Fisherman</option>
                                <option value="Housewife/Househusband">Housewife/Househusband</option>
                            </select>
                        </div>
                        
                        <div class="edit-form-group">
                            <label for="editEducationalAttainment">Educational Attainment</label>
                            <select id="editEducationalAttainment" name="educationalAttainment">
                                <option value="">Select educational attainment</option>
                                <option value="Elementary Graduate">Elementary Graduate</option>
                                <option value="High School Graduate">High School Graduate</option>
                                <option value="Vocational Graduate">Vocational Graduate</option>
                                <option value="College Graduate">College Graduate</option>
                                <option value="Post Graduate">Post Graduate</option>
                                <option value="None">None</option>
                            </select>
                        </div>
                    </div>

                    <!-- Address Information -->
                    <div class="edit-form-section full-width">
                        <h4>Address Information</h4>
                        
                        <div class="edit-form-group">
                            <label for="editAddress">Complete Address *</label>
                            <textarea id="editAddress" name="address" required></textarea>
                        </div>
                    </div>

                    <!-- Government Programs -->
                    <div class="edit-form-section full-width">
                        <h4>Government Program Participation</h4>
                        
                        <div class="checkbox-group-edit">
                            <div class="checkbox-item-edit">
                                <input type="checkbox" id="editRegisteredVoter" name="registeredVoter">
                                <label for="editRegisteredVoter">Registered Voter</label>
                            </div>
                            <div class="checkbox-item-edit">
                                <input type="checkbox" id="editFourPsMember" name="fourPsMember">
                                <label for="editFourPsMember">4Ps Member</label>
                            </div>
                            <div class="checkbox-item-edit">
                                <input type="checkbox" id="editPwdMember" name="pwdMember">
                                <label for="editPwdMember">PWD Member</label>
                            </div>
                            <div class="checkbox-item-edit">
                                <input type="checkbox" id="editSeniorCitizen" name="seniorCitizen">
                                <label for="editSeniorCitizen">Senior Citizen</label>
                            </div>
                            <div class="checkbox-item-edit">
                                <input type="checkbox" id="editSoloParent" name="soloParent">
                                <label for="editSoloParent">Solo Parent</label>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="edit-profile-actions">
                        <button type="button" class="cancel-edit-btn" onclick="closeEditProfileModal()">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button type="button" class="save-edit-btn" onclick="saveProfile()">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="changePasswordModal" class="change-password-modal">
        <div class="change-password-content">
            <span class="close-password-modal" onclick="closeChangePasswordModal()">&times;</span>
            <h3>Change Password</h3>
            
            <div id="passwordMessage" class="message"></div>
            
            <div class="password-form-group">
                <label for="currentPassword">Current Password</label>
                <input type="password" id="currentPassword" name="currentPassword" class="form-control" required>
            </div>
            
            <div class="password-form-group">
                <label for="newPassword">New Password</label>
                <input type="password" id="newPassword" name="newPassword" class="form-control" required oninput="validatePassword()">
                <div class="password-requirements">
                    <div id="reqLength" class="requirement not-met">
                        <i class="fas fa-circle"></i> At least 8 characters
                    </div>
                    <div id="reqUppercase" class="requirement not-met">
                        <i class="fas fa-circle"></i> At least one uppercase letter
                    </div>
                    <div id="reqSpecial" class="requirement not-met">
                        <i class="fas fa-circle"></i> At least one special character
                    </div>
                </div>
            </div>
            
            <div class="password-form-group">
                <label for="confirmPassword">Confirm New Password</label>
                <input type="password" id="confirmPassword" name="confirmPassword" class="form-control" required oninput="checkPasswordMatch()">
                <div id="passwordMatch" class="password-requirements"></div>
            </div>
            
            <div class="password-actions">
                <button type="button" class="password-cancel" onclick="closeChangePasswordModal()">Cancel</button>
                <button type="button" class="password-submit" onclick="handlePasswordChange()" id="changePasswordBtn">
                    <i class="fas fa-save"></i> Change Password
                </button>
            </div>
        </div>
    </div>

    <!-- Logout Confirmation Modal -->
    <div id="logoutModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeLogoutModal()">&times;</span>
            <h3>Are you sure you want to logout?</h3>
            <div class="modal-actions">
                <button class="confirm" onclick="confirmLogout()">Yes</button>
                <button class="cancel" onclick="closeLogoutModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        let originalData = {}; // To store original values when editing

        // Toggle sidebar menu
        function toggleMenu() {
            const sidebar = document.querySelector('.sidebar');
            const menuBtn = document.querySelector('.mobile-menu-btn');
            sidebar.classList.toggle('active');
            
            if (sidebar.classList.contains('active')) {
                menuBtn.style.display = 'none';
            } else {
                menuBtn.style.display = 'flex';
            }
        }

        // Create and add mobile close button to sidebar
        function addMobileCloseButton() {
            const sidebar = document.querySelector('.sidebar');
            const closeBtn = document.createElement('div');
            closeBtn.className = 'mobile-close-btn';
            closeBtn.innerHTML = '<i class="fas fa-times"></i>';
            closeBtn.onclick = toggleMenu;
            
            const logoName = document.querySelector('.logo-name');
            logoName.appendChild(closeBtn);
        }

        // Close sidebar when clicking on a link (mobile)
        document.querySelectorAll('.nav-links a').forEach(link => {
            link.addEventListener('click', () => {
                if (window.innerWidth <= 768) {
                    toggleMenu();
                }
            });
        });

        // Update greeting and time
        function updateGreetingAndTime() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            
            // Set greeting based on time of day
            let greeting;
            if (hours < 12) {
                greeting = "Good Morning";
            } else if (hours < 18) {
                greeting = "Good Afternoon";
            } else {
                greeting = "Good Evening";
            }
            
            // Format date
            const options = { weekday: 'long', year: 'numeric', month: 'short', day: 'numeric' };
            const dateString = now.toLocaleDateString('en-US', options);
            
            // Format time with AM/PM
            const ampm = hours >= 12 ? 'PM' : 'AM';
            const formattedHours = hours % 12 || 12;
            const timeString = `${formattedHours}:${minutes}:${seconds} ${ampm}`;
            
            // Update DOM elements
            document.getElementById('greetingText').textContent = greeting;
            document.getElementById('currentDate').textContent = dateString;
            document.getElementById('currentTime').textContent = timeString;
        }

        // Update time every second
        setInterval(updateGreetingAndTime, 1000);
        updateGreetingAndTime(); // Initial call

        // Check authentication status when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Add mobile close button
                addMobileCloseButton();
                
                const response = await fetch('/api/auth/check-auth', {
                    credentials: 'include'
                });
                
                const authData = await response.json();
                
                if (!authData.isAuthenticated) {
                    window.location.href = '/login';
                    return;
                }
                
                // Fetch user profile if authenticated
                await fetchUserProfile();
                
                // Set up event listeners
                setupEventListeners();
                
                // Add logout event listener
                document.getElementById('sidebarLogoutBtn').addEventListener('click', function(e) {
                    e.preventDefault();
                    openLogoutModal();
                });
                
                // Close modals when clicking outside
                window.addEventListener('click', function(event) {
                    const logoutModal = document.getElementById('logoutModal');
                    const passwordModal = document.getElementById('changePasswordModal');
                    const editModal = document.getElementById('editProfileModal');
                    
                    if (event.target === logoutModal) {
                        closeLogoutModal();
                    }
                    if (event.target === passwordModal) {
                        closeChangePasswordModal();
                    }
                    if (event.target === editModal) {
                        closeEditProfileModal();
                    }
                });
            } catch (error) {
                console.error('Error checking auth status:', error);
                window.location.href = '/login';
            }
        });

        function setupEventListeners() {
            document.getElementById('newProfilePicture').addEventListener('change', function() {
                if (this.files[0]) {
                    updateProfilePicture();
                }
            });
        }

        async function fetchUserProfile() {
            try {
                const response = await fetch('/api/auth/profile', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });

                const result = await response.json();
                
                if (response.ok) {
                    // Store the original data
                    originalData = {
                        fullName: result.fullName || '',
                        email: result.email || '',
                        contactNumber: result.contactNumber || '',
                        address: result.address || '',
                        birthdate: result.birthdate || '',
                        civilStatus: result.civilStatus || '',
                        occupation: result.occupation || '',
                        educationalAttainment: result.educationalAttainment || '',
                        registeredVoter: result.registeredVoter || false,
                        fourPsMember: result.fourPsMember || false,
                        pwdMember: result.pwdMember || false,
                        seniorCitizen: result.seniorCitizen || false,
                        soloParent: result.soloParent || false
                    };

                    // Display values
                    document.getElementById('profileNameDisplay').textContent = originalData.fullName || 'Not provided';
                    document.getElementById('fullNameDisplay').textContent = originalData.fullName || 'Not provided';
                    document.getElementById('profileEmailDisplay').textContent = originalData.email || 'Not provided';
                    document.getElementById('emailDisplay').textContent = originalData.email || 'Not provided';
                    document.getElementById('contactNumberDisplay').textContent = originalData.contactNumber || 'Not provided';
                    document.getElementById('addressDisplay').textContent = originalData.address || 'Not provided';
                    document.getElementById('birthdateDisplay').textContent = originalData.birthdate ? 
                        formatDate(originalData.birthdate) : 'Not provided';
                    document.getElementById('civilStatusDisplay').textContent = originalData.civilStatus || 'Not provided';
                    document.getElementById('occupationDisplay').textContent = originalData.occupation || 'Not provided';
                    document.getElementById('educationalAttainmentDisplay').textContent = 
                        originalData.educationalAttainment || 'Not provided';

                    // Set display checkbox values
                    document.getElementById('registeredVoterDisplay').checked = originalData.registeredVoter;
                    document.getElementById('fourPsMemberDisplay').checked = originalData.fourPsMember;
                    document.getElementById('pwdMemberDisplay').checked = originalData.pwdMember;
                    document.getElementById('seniorCitizenDisplay').checked = originalData.seniorCitizen;
                    document.getElementById('soloParentDisplay').checked = originalData.soloParent;

                    // Set profile picture - add timestamp to prevent caching
                    const timestamp = new Date().getTime();
                    const profilePicUrl = result.profilePictureUrl || 
                                        `images/default-profile.png?${timestamp}`;
                    document.getElementById('profilePicture').src = profilePicUrl;
                } else {
                    alert(result.error || 'Failed to fetch profile data');
                    if (response.status === 401) {
                        window.location.href = '/login';
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while fetching user profile.');
                window.location.href = '/login';
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function formatDateForInput(dateString) {
            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        async function updateProfilePicture() {
            const fileInput = document.getElementById('newProfilePicture');
            const file = fileInput.files[0];
            
            if (!file) {
                return;
            }

            if (file.size > 10 * 1024 * 1024) {
                alert('File size must be less than 10MB.');
                return;
            }

            const formData = new FormData();
            formData.append('profilePicture', file);

            try {
                const response = await fetch('/api/auth/update-profile-picture', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });

                const result = await response.json();
                if (response.ok) {
                    alert('Profile picture updated successfully!');
                    // Update the displayed image immediately
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('profilePicture').src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                    
                    // Clear the file input
                    fileInput.value = '';
                } else {
                    alert(result.error || 'Failed to update profile picture');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while updating the profile picture.');
            }
        }

        // ==================== EDIT PROFILE MODAL FUNCTIONS ====================
        
        function openEditProfileModal() {
            // Populate the edit form with current data
            document.getElementById('editFullName').value = originalData.fullName || '';
            document.getElementById('editEmail').value = originalData.email || '';
            document.getElementById('editContactNumber').value = originalData.contactNumber || '';
            document.getElementById('editAddress').value = originalData.address || '';
            document.getElementById('editBirthdate').value = originalData.birthdate ? 
                formatDateForInput(originalData.birthdate) : '';
            document.getElementById('editCivilStatus').value = originalData.civilStatus || '';
            document.getElementById('editOccupation').value = originalData.occupation || '';
            document.getElementById('editEducationalAttainment').value = originalData.educationalAttainment || '';
            
            // Set checkbox values
            document.getElementById('editRegisteredVoter').checked = originalData.registeredVoter;
            document.getElementById('editFourPsMember').checked = originalData.fourPsMember;
            document.getElementById('editPwdMember').checked = originalData.pwdMember;
            document.getElementById('editSeniorCitizen').checked = originalData.seniorCitizen;
            document.getElementById('editSoloParent').checked = originalData.soloParent;
            
            // Show the modal
            document.getElementById('editProfileModal').style.display = 'flex';
        }

        function closeEditProfileModal() {
            document.getElementById('editProfileModal').style.display = 'none';
        }

        async function saveProfile() {
            // Prepare the update data with proper formatting
            const updatedData = {
                fullName: document.getElementById('editFullName').value.trim(),
                contactNumber: document.getElementById('editContactNumber').value.trim(),
                address: document.getElementById('editAddress').value.trim(),
                birthdate: document.getElementById('editBirthdate').value || null,
                civilStatus: document.getElementById('editCivilStatus').value || null,
                occupation: document.getElementById('editOccupation').value.trim() || null,
                educationalAttainment: document.getElementById('editEducationalAttainment').value || null,
                registeredVoter: document.getElementById('editRegisteredVoter').checked,
                fourPsMember: document.getElementById('editFourPsMember').checked,
                pwdMember: document.getElementById('editPwdMember').checked,
                seniorCitizen: document.getElementById('editSeniorCitizen').checked,
                soloParent: document.getElementById('editSoloParent').checked
            };

            // Validate required fields
            if (!updatedData.fullName) {
                alert('Full name is required');
                return;
            }

            if (!updatedData.contactNumber) {
                alert('Contact number is required');
                return;
            }

            if (!updatedData.address) {
                alert('Address is required');
                return;
            }

            try {
                const response = await fetch('/api/residents/profile', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updatedData),
                    credentials: 'include'
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Error response:', errorData);
                    throw new Error(errorData.message || 'Failed to update profile');
                }

                const result = await response.json();
                alert('Profile updated successfully!');
                closeEditProfileModal();
                fetchUserProfile(); // Refresh the displayed data
            } catch (error) {
                console.error('Error:', error);
                alert(error.message || 'An error occurred while updating the profile.');
            }
        }

        // ==================== PASSWORD CHANGE FUNCTIONS ====================
        
        function openChangePasswordModal() {
            document.getElementById('changePasswordModal').style.display = 'flex';
            // Reset form
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            validatePassword();
            document.getElementById('passwordMatch').textContent = '';
            document.getElementById('passwordMessage').style.display = 'none';
        }

        function closeChangePasswordModal() {
            document.getElementById('changePasswordModal').style.display = 'none';
        }

        // Password validation
        function validatePassword() {
            const password = document.getElementById('newPassword').value;
            
            const lengthReq = document.getElementById('reqLength');
            const uppercaseReq = document.getElementById('reqUppercase');
            const specialReq = document.getElementById('reqSpecial');
            
            // Check length
            if (password.length >= 8) {
                lengthReq.className = 'requirement met';
                lengthReq.innerHTML = '<i class="fas fa-check-circle"></i> At least 8 characters';
            } else {
                lengthReq.className = 'requirement not-met';
                lengthReq.innerHTML = '<i class="fas fa-circle"></i> At least 8 characters';
            }
            
            // Check uppercase
            if (/[A-Z]/.test(password)) {
                uppercaseReq.className = 'requirement met';
                uppercaseReq.innerHTML = '<i class="fas fa-check-circle"></i> At least one uppercase letter';
            } else {
                uppercaseReq.className = 'requirement not-met';
                uppercaseReq.innerHTML = '<i class="fas fa-circle"></i> At least one uppercase letter';
            }
            
            // Check special character
            if (/[!@#$%^&*(),.?":{}|<>]/.test(password)) {
                specialReq.className = 'requirement met';
                specialReq.innerHTML = '<i class="fas fa-check-circle"></i> At least one special character';
            } else {
                specialReq.className = 'requirement not-met';
                specialReq.innerHTML = '<i class="fas fa-circle"></i> At least one special character';
            }
        }

        // Check password match
        function checkPasswordMatch() {
            const password = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const matchElement = document.getElementById('passwordMatch');
            
            if (confirmPassword === '') {
                matchElement.textContent = '';
                return;
            }
            
            if (password === confirmPassword) {
                matchElement.textContent = '✓ Passwords match';
                matchElement.style.color = '#28a745';
            } else {
                matchElement.textContent = '✗ Passwords do not match';
                matchElement.style.color = '#dc3545';
            }
        }

        // Handle password change
        async function handlePasswordChange() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const messageElement = document.getElementById('passwordMessage');
            const changePasswordBtn = document.getElementById('changePasswordBtn');
            
            // Validate password requirements
            if (newPassword.length < 8 || 
                !/[A-Z]/.test(newPassword) || 
                !/[!@#$%^&*(),.?":{}|<>]/.test(newPassword)) {
                showMessage(messageElement, 'Please ensure your password meets all requirements.', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showMessage(messageElement, 'Passwords do not match.', 'error');
                return;
            }
            
            try {
                changePasswordBtn.disabled = true;
                changePasswordBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Changing...';
                
                const response = await fetch('/api/auth/change-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        currentPassword,
                        newPassword
                    }),
                    credentials: 'include'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showMessage(messageElement, 'Password changed successfully!', 'success');
                    document.getElementById('currentPassword').value = '';
                    document.getElementById('newPassword').value = '';
                    document.getElementById('confirmPassword').value = '';
                    validatePassword();
                    document.getElementById('passwordMatch').textContent = '';
                    
                    // Close the password modal after successful change
                    setTimeout(() => {
                        closeChangePasswordModal();
                    }, 2000);
                } else {
                    showMessage(messageElement, result.message || 'Failed to change password', 'error');
                }
            } catch (error) {
                console.error('Error changing password:', error);
                showMessage(messageElement, 'An error occurred while changing password', 'error');
            } finally {
                changePasswordBtn.disabled = false;
                changePasswordBtn.innerHTML = '<i class="fas fa-save"></i> Change Password';
            }
        }

        // Helper function to show messages
        function showMessage(element, message, type) {
            element.textContent = message;
            element.className = `message ${type}`;
            element.style.display = 'block';
            
            setTimeout(() => {
                element.style.display = 'none';
            }, 5000);
        }

        // ==================== LOGOUT FUNCTIONS ====================
        
        function openLogoutModal() {
            document.getElementById('logoutModal').style.display = 'block';
        }

        function closeLogoutModal() {
            document.getElementById('logoutModal').style.display = 'none';
        }

        function confirmLogout() {
            logout();
        }

        function logout() {
            fetch('/api/auth/logout', {
                method: 'POST',
                credentials: 'include'
            })
            .then(response => {
                if (response.ok) {
                    window.location.href = '/login';
                } else {
                    alert('Failed to logout. Please try again.');
                }
            })
            .catch(error => {
                console.error('Logout error:', error);
                alert('An error occurred during logout.');
            });
        }
    </script>
</body>
</html>