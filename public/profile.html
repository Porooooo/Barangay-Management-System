<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: aliceblue;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .wrapper {
            padding: 30px 50px;
            border: 1px solid #ddd;
            border-radius: 15px;
            background-color: white;
            width: 100%;
            max-width: 800px;
            position: relative;
        }

        .back-arrow {
            position: absolute;
            top: 25px;
            left: 25px;
            font-size: 20px;
            color: #0779e4;
            cursor: pointer;
            transition: all 0.2s;
        }

        .back-arrow:hover {
            color: #055cb3;
            transform: translateX(-3px);
        }

        h4 {
            letter-spacing: -1px;
            font-weight: 400;
            text-align: center;
            padding-top: 5px;
        }

        .profile-picture {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #0779e4;
        }

        #img-section p, #deactivate p {
            font-size: 12px;
            color: #777;
            margin-bottom: 10px;
            text-align: justify;
        }

        #img-section b, #img-section button, #deactivate b {
            font-size: 14px;
        }

        label {
            margin-bottom: 0;
            font-size: 14px;
            font-weight: 500;
            color: #777;
            padding-left: 3px;
        }

        .form-control {
            border-radius: 10px;
        }

        input[placeholder] {
            font-weight: 500;
        }

        .form-control:focus {
            box-shadow: none;
            border: 1.5px solid #0779e4;
        }

        select {
            display: block;
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 10px;
            height: 40px;
            padding: 5px 10px;
        }

        select:focus {
            outline: none;
        }

        .button {
            background-color: #fff;
            color: #0779e4;
        }

        .button:hover {
            background-color: #0779e4;
            color: #fff;
        }

        .btn-primary {
            background-color: #0779e4;
        }

        .danger {
            background-color: #fff;
            color: #e20404;
            border: 1px solid #ddd;
        }

        .danger:hover {
            background-color: #e20404;
            color: #fff;
        }

        .profile-info p {
            margin-bottom: 8px;
        }

        .profile-info span {
            font-weight: normal;
            color: #555;
        }

        .profile-field {
            margin-bottom: 15px;
        }

        .profile-value {
            font-weight: normal;
            color: #555;
            padding: 8px;
            background-color: #f9f9f9;
            border-radius: 5px;
            display: inline-block;
            min-width: 200px;
        }

        .edit-field {
            display: none;
        }

        .readonly-field {
            background-color: #f0f0f0;
        }

        .additional-info-field {
            margin-bottom: 15px;
        }
        
        .additional-info-label {
            margin-bottom: 0;
            font-size: 14px;
            font-weight: 500;
            color: #777;
            padding-left: 3px;
        }
        
        .additional-info-value {
            font-weight: normal;
            color: #555;
            padding: 8px;
            background-color: #f9f9f9;
            border-radius: 5px;
            display: inline-block;
            min-width: 200px;
        }

        @media (max-width: 576px) {
            .wrapper {
                padding: 25px 20px;
            }
            .back-arrow {
                top: 15px;
                left: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="wrapper bg-white mt-sm-5">
        <a href="residentdashboard.html" class="back-arrow">
            <i class="fas fa-arrow-left"></i>
        </a>
        
        <h4 class="pb-4 border-bottom">User Profile</h4>
        <div class="d-flex align-items-start py-3 border-bottom">
            <img id="profilePicture" src="" alt="Profile Picture" class="profile-picture">
            <div class="pl-sm-4 pl-2" id="img-section">
                <b>Profile Photo</b>
                <p>Accepted file types: .png, .jpg, .jpeg. Less than 2MB</p>
                <form id="uploadForm" class="d-flex align-items-center">
                    <input type="file" id="newProfilePicture" accept="image/*" class="d-none">
                    <label for="newProfilePicture" class="btn button border mr-2"><b>Choose File</b></label>
                    <button type="submit" class="btn btn-primary">Upload</button>
                </form>
            </div>
        </div>
        <div class="py-2">
            <div class="row py-2">
                <div class="col-md-6 profile-field">
                    <label for="fullName">Full Name</label>
                    <div class="profile-value" id="fullNameDisplay"></div>
                    <input type="text" class="form-control edit-field" id="fullName" placeholder="Enter full name">
                </div>
                <div class="col-md-6 pt-md-0 pt-3 profile-field">
                    <label for="email">Email Address</label>
                    <div class="profile-value" id="emailDisplay"></div>
                    <input type="email" class="form-control edit-field readonly-field" id="email" placeholder="Enter email" readonly>
                </div>
            </div>
            <div class="row py-2">
                <div class="col-md-6 profile-field">
                    <label for="contactNumber">Contact Number</label>
                    <div class="profile-value" id="contactNumberDisplay"></div>
                    <input type="tel" class="form-control edit-field" id="contactNumber" placeholder="Enter contact number">
                </div>
                <div class="col-md-6 pt-md-0 pt-3 profile-field">
                    <label for="birthdate">Birthdate</label>
                    <div class="profile-value" id="birthdateDisplay"></div>
                    <input type="date" class="form-control edit-field" id="birthdate">
                </div>
            </div>
            <div class="row py-2">
                <div class="col-md-6 profile-field">
                    <label for="civilStatus">Civil Status</label>
                    <div class="profile-value" id="civilStatusDisplay"></div>
                    <select class="form-control edit-field" id="civilStatus">
                        <option value="">Select civil status</option>
                        <option value="Single">Single</option>
                        <option value="Married">Married</option>
                        <option value="Divorced">Divorced</option>
                        <option value="Widowed">Widowed</option>
                    </select>
                </div>
                <div class="col-md-6 pt-md-0 pt-3 profile-field">
                    <label for="occupation">Occupation</label>
                    <div class="profile-value" id="occupationDisplay"></div>
                    <input type="text" class="form-control edit-field" id="occupation" placeholder="Enter occupation">
                </div>
            </div>
            <div class="row py-2">
                <div class="col-md-12 profile-field">
                    <label for="address">Address</label>
                    <div class="profile-value" id="addressDisplay" style="min-width: 100%;"></div>
                    <textarea class="form-control edit-field" id="address" placeholder="Enter address" style="min-width: 100%;"></textarea>
                </div>
            </div>
            <div class="row py-2">
                <div class="col-md-12 profile-field">
                    <label for="educationalAttainment">Educational Attainment</label>
                    <div class="profile-value" id="educationalAttainmentDisplay" style="min-width: 100%;"></div>
                    <select class="form-control edit-field" id="educationalAttainment">
                        <option value="">Select educational attainment</option>
                        <option value="Elementary Graduate">Elementary Graduate</option>
                        <option value="High School Graduate">High School Graduate</option>
                        <option value="Vocational Graduate">Vocational Graduate</option>
                        <option value="College Graduate">College Graduate</option>
                        <option value="Post Graduate">Post Graduate</option>
                        <option value="None">None</option>
                    </select>
                </div>
            </div>
            <div class="row py-2" id="additionalInfoContainer">
                <!-- Additional info fields will be inserted here -->
            </div>
            <div class="py-3 pb-4 border-bottom d-flex justify-content-between">
                <button class="btn btn-primary" id="editProfileBtn">Edit Profile</button>
                <button class="btn btn-success edit-field" id="saveProfileBtn" style="display: none;">Save Changes</button>
                <button class="btn button border edit-field" id="cancelEditBtn" style="display: none;">Cancel</button>
                <button class="btn button border" onclick="logout()">Logout</button>
            </div>
            <div class="d-sm-flex align-items-center pt-3" id="deactivate">
                <div>
                    <b>Deactivate your account</b>
                    <p>This will permanently delete your account and all associated data</p>
                </div>
                <div class="ml-auto">
                    <button class="btn danger" onclick="confirmDeactivate()">Deactivate</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.bundle.min.js"></script>
    <script>
        let originalData = {}; // To store original values when editing

        // Check authentication status when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                const response = await fetch('/api/auth/check-auth', {
                    credentials: 'include'
                });
                
                const authData = await response.json();
                
                if (!authData.isAuthenticated) {
                    window.location.href = 'login.html';
                    return;
                }
                
                // Fetch user profile if authenticated
                await fetchUserProfile();
                
                // Set up event listeners
                setupEventListeners();
            } catch (error) {
                console.error('Error checking auth status:', error);
                window.location.href = 'login.html';
            }
        });

        function setupEventListeners() {
            document.getElementById('newProfilePicture').addEventListener('change', function() {
                const fileName = this.files[0] ? this.files[0].name : 'No file chosen';
                document.querySelector('label[for="newProfilePicture"]').textContent = fileName;
            });

            document.getElementById('uploadForm').addEventListener('submit', updateProfilePicture);
            
            document.getElementById('editProfileBtn').addEventListener('click', function() {
                toggleEditMode(true);
            });

            document.getElementById('saveProfileBtn').addEventListener('click', function(e) {
                e.preventDefault();
                saveProfile();
            });

            document.getElementById('cancelEditBtn').addEventListener('click', function(e) {
                e.preventDefault();
                cancelEdit();
            });
        }

        async function fetchUserProfile() {
            try {
                const response = await fetch('/api/auth/profile', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });

                const result = await response.json();
                
                if (response.ok) {
                    // Store the original data
                    originalData = {
                        fullName: result.fullName || '',
                        email: result.email || '',
                        contactNumber: result.contactNumber || '',
                        address: result.address || '',
                        birthdate: result.birthdate || '',
                        civilStatus: result.civilStatus || '',
                        occupation: result.occupation || '',
                        educationalAttainment: result.educationalAttainment || '',
                        registeredVoter: result.registeredVoter || false,
                        fourPsMember: result.fourPsMember || false,
                        pwdMember: result.pwdMember || false,
                        seniorCitizen: result.seniorCitizen || false,
                        pregnant: result.pregnant || false
                    };

                    // Display values
                    document.getElementById('fullNameDisplay').textContent = originalData.fullName || 'Not provided';
                    document.getElementById('emailDisplay').textContent = originalData.email || 'Not provided';
                    document.getElementById('contactNumberDisplay').textContent = originalData.contactNumber || 'Not provided';
                    document.getElementById('addressDisplay').textContent = originalData.address || 'Not provided';
                    document.getElementById('birthdateDisplay').textContent = originalData.birthdate ? 
                        formatDate(originalData.birthdate) : 'Not provided';
                    document.getElementById('civilStatusDisplay').textContent = originalData.civilStatus || 'Not provided';
                    document.getElementById('occupationDisplay').textContent = originalData.occupation || 'Not provided';
                    document.getElementById('educationalAttainmentDisplay').textContent = 
                        originalData.educationalAttainment || 'Not provided';

                    // Display additional information
                    displayAdditionalInfo(originalData);

                    // Set form field values
                    document.getElementById('fullName').value = originalData.fullName;
                    document.getElementById('email').value = originalData.email;
                    document.getElementById('contactNumber').value = originalData.contactNumber;
                    document.getElementById('address').value = originalData.address;
                    document.getElementById('birthdate').value = originalData.birthdate ? 
                        formatDateForInput(originalData.birthdate) : '';
                    document.getElementById('civilStatus').value = originalData.civilStatus;
                    document.getElementById('occupation').value = originalData.occupation;
                    document.getElementById('educationalAttainment').value = originalData.educationalAttainment;

                    // Set profile picture
                    const profilePicUrl = result.profilePictureUrl || 'images/default-profile.png';
                    document.getElementById('profilePicture').src = profilePicUrl;
                } else {
                    alert(result.error || 'Failed to fetch profile data');
                    if (response.status === 401) {
                        window.location.href = 'login.html';
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while fetching user profile.');
                window.location.href = 'login.html';
            }
        }

        function displayAdditionalInfo(data) {
            const container = document.getElementById('additionalInfoContainer');
            container.innerHTML = '';
            
            // Only show fields that are true/YES
            const additionalInfo = [
                { key: 'registeredVoter', label: 'Registered Voter' },
                { key: 'fourPsMember', label: '4Ps Member' },
                { key: 'pwdMember', label: 'PWD Member' },
                { key: 'seniorCitizen', label: 'Senior Citizen' },
                { key: 'pregnant', label: 'Pregnant' }
            ];

            additionalInfo.forEach(info => {
                if (data[info.key]) {
                    const fieldDiv = document.createElement('div');
                    fieldDiv.className = 'col-md-6 additional-info-field';
                    
                    const labelElement = document.createElement('label');
                    labelElement.className = 'additional-info-label';
                    labelElement.textContent = info.label;
                    
                    fieldDiv.appendChild(labelElement);
                    container.appendChild(fieldDiv);
                }
            });
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function formatDateForInput(dateString) {
            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        async function updateProfilePicture(event) {
            event.preventDefault();
            const fileInput = document.getElementById('newProfilePicture');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a file.');
                return;
            }

            if (file.size > 2 * 1024 * 1024) {
                alert('File size must be less than 2MB.');
                return;
            }

            const formData = new FormData();
            formData.append('profilePicture', file);

            try {
                const response = await fetch('/api/auth/update-profile-picture', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });

                const result = await response.json();
                if (response.ok) {
                    alert('Profile picture updated successfully!');
                    // Update the displayed image immediately
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('profilePicture').src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                    
                    // Clear the file input
                    fileInput.value = '';
                    document.querySelector('label[for="newProfilePicture"]').textContent = 'Choose File';
                } else {
                    alert(result.error || 'Failed to update profile picture');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while updating the profile picture.');
            }
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                fetch('/api/auth/logout', {
                    method: 'POST',
                    credentials: 'include'
                })
                .then(response => {
                    if (response.ok) {
                        window.location.href = 'login.html';
                    } else {
                        alert('Failed to logout. Please try again.');
                    }
                })
                .catch(error => {
                    console.error('Logout error:', error);
                    alert('An error occurred during logout.');
                });
            }   
        }

        function confirmDeactivate() {
            if (confirm('Are you sure you want to deactivate your account? This action cannot be undone.')) {
                // Add deactivation logic here
                alert('Account deactivation request sent.');
            }
        }

        function toggleEditMode(edit) {
            const displayFields = document.querySelectorAll('.profile-value');
            const editFields = document.querySelectorAll('.edit-field');
            const editBtn = document.getElementById('editProfileBtn');
            const saveBtn = document.getElementById('saveProfileBtn');
            const cancelBtn = document.getElementById('cancelEditBtn');

            if (edit) {
                // Enter edit mode
                displayFields.forEach(field => field.style.display = 'none');
                editFields.forEach(field => field.style.display = 'block');
                editBtn.style.display = 'none';
                saveBtn.style.display = 'block';
                cancelBtn.style.display = 'block';
            } else {
                // Exit edit mode
                displayFields.forEach(field => field.style.display = 'inline-block');
                editFields.forEach(field => field.style.display = 'none');
                editBtn.style.display = 'block';
                saveBtn.style.display = 'none';
                cancelBtn.style.display = 'none';
            }
        }

        async function saveProfile() {
            const updatedData = {
                fullName: document.getElementById('fullName').value,
                contactNumber: document.getElementById('contactNumber').value,
                address: document.getElementById('address').value,
                birthdate: document.getElementById('birthdate').value,
                civilStatus: document.getElementById('civilStatus').value,
                occupation: document.getElementById('occupation').value,
                educationalAttainment: document.getElementById('educationalAttainment').value
            };

            try {
                const response = await fetch('/api/residents/profile', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updatedData),
                    credentials: 'include'
                });

                const result = await response.json();
                if (response.ok) {
                    alert('Profile updated successfully!');
                    fetchUserProfile();
                    toggleEditMode(false);
                } else {
                    alert(result.error || 'Failed to update profile');
                    if (response.status === 401) {
                        window.location.href = 'login.html';
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while updating the profile.');
            }
        }

        function cancelEdit() {
            // Restore original values
            document.getElementById('fullName').value = originalData.fullName;
            document.getElementById('contactNumber').value = originalData.contactNumber;
            document.getElementById('address').value = originalData.address;
            document.getElementById('birthdate').value = originalData.birthdate ? 
                formatDateForInput(originalData.birthdate) : '';
            document.getElementById('civilStatus').value = originalData.civilStatus;
            document.getElementById('occupation').value = originalData.occupation;
            document.getElementById('educationalAttainment').value = originalData.educationalAttainment;

            toggleEditMode(false);
        }
    </script>
</body>
</html>